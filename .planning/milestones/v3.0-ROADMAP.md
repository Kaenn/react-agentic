# Milestone v3.0: Primitive/Composite Architecture

**Status:** SHIPPED 2026-01-31
**Phases:** 27-33
**Total Plans:** 13

## Overview

Separate primitive components (compiler-owned) from composite components (user-definable TSX functions). Enable users to create custom components that compose primitives.

## Phases

### Phase 27: Baseline & Registry

**Goal**: Establish safety baseline before refactoring and formalize primitive classification
**Depends on**: Phase 26 (v2.1 complete)
**Requirements**: FOUND-01, FOUND-02
**Plans**: 2 plans

Plans:
- [x] 27-01-PLAN.md — Create snapshot tests for all component markdown output
- [x] 27-02-PLAN.md — Create primitive registry with classification functions

**Details:**
- 64 snapshot tests capturing all component markdown output
- External snapshots prevent accidental output changes during refactoring
- Registry with 22 primitive components across 3 layers (infrastructure, presentation, document)
- Presentation primitives marked for Phase 32 composite migration
- Registry exported for user introspection and metaprogramming

### Phase 28: Content Types

**Goal**: Type foundation enabling content constraints across component boundaries
**Depends on**: Phase 27
**Requirements**: FOUND-03, FOUND-04, FOUND-05
**Plans**: 1 plan

Plans:
- [x] 28-01-PLAN.md — Create content-types.ts with discriminated union types, export from package root

**Details:**
- CommandContent type allows all primitives (SpawnAgent, control flow, runtime)
- AgentContent type allows all primitives (separate from CommandContent for future divergence)
- SubComponentContent type restricts to document-level primitives (excludes 10 command-level features)
- Extract-based SubComponentContent pattern (explicit allow-list vs implicit deny-list)
- Content types exported from react-agentic package root
- 24 tests including 10 @ts-expect-error compile-time exclusion tests

### Phase 29: Reference Printing

**Goal**: Enable composites to print variable and function references in markdown output
**Depends on**: Phase 28
**Requirements**: REF-01, REF-02, REF-03, REF-04
**Plans**: 2 plans

Plans:
- [x] 29-01-PLAN.md — RuntimeVar shell syntax, RuntimeFn properties, Ref component
- [x] 29-02-PLAN.md — Gap closure: Fix array access formatting, expand test coverage

**Details:**
- Shell variable syntax ($VAR.path) for RuntimeVar interpolation
- Bracket notation for array indices ($VAR.items[0])
- Fixed array access formatting bug (map+join → reduce) to avoid stray dots
- RuntimeFn reference properties: .name, .call, .input, .output
- Ref component for explicit reference printing in JSX

### Phase 30: Component Composition

**Goal**: Full support for children and props in custom components
**Depends on**: Phase 29
**Requirements**: COMP-01, COMP-02, COMP-03, COMP-04
**Plans**: 2 plans

Plans:
- [x] 30-01-PLAN.md — Extend static transformer for props and children support
- [x] 30-02-PLAN.md — Add comprehensive test coverage for both transformer paths

**Details:**
- Context-based prop substitution via componentProps field
- Block-level children substitution via componentChildren field
- GroupNode wrapping for multi-block fragment returns
- Static transformer now supports props, children, and fragments
- Local component support added to static path
- 33 new tests for component composition (828 total)
- Parity verified between static and runtime paths

### Phase 31: Content Validation

**Goal**: Compile-time errors for invalid content nesting
**Depends on**: Phase 30
**Requirements**: VALID-01, VALID-02, VALID-03
**Plans**: 1 plan

Plans:
- [x] 31-01-PLAN.md — Enhance JSDoc, type Command/Agent children, add validation tests

**Details:**
- Enhanced JSDoc on all content types with @example and exclusion lists
- SubComponentContent documents all 10 excluded node types with kind values
- CommandContent and AgentContent integrated into Command/Agent children props
- 21 user component pattern tests with 13 @ts-expect-error directives
- Backward-compatible content type integration (union with ReactNode)
- Compile-time validation proven through direct type assignment tests

### Phase 32: Composite Library

**Goal**: Move current components to user-definable composite layer
**Depends on**: Phase 31
**Requirements**: LIB-01, LIB-02, LIB-03, LIB-04, LIB-05, LIB-06
**Plans**: 4 plans

Plans:
- [x] 32-01-PLAN.md — Create composites directory infrastructure with package.json subpath exports
- [x] 32-02-PLAN.md — Create control flow composites (IfElseBlock, LoopWithBreak)
- [x] 32-03-PLAN.md — Create SpawnAgentWithRetry composite
- [x] 32-04-PLAN.md — Create presentation composites (StepSection, DataTable, BulletList, FileContext) and finalize

**Details:**
- src/composites/index.ts barrel export created
- package.json ./composites subpath export configured
- tsup.config.ts entry point added for build output
- 7 composites: IfElseBlock, LoopWithBreak, SpawnAgentWithRetry, StepSection, DataTable, BulletList, FileContext
- All composites have rich JSDoc with @example, @param, and @see tags
- 35 tests across 3 test files

### Phase 33: Documentation

**Goal**: User-facing documentation for primitive/composite architecture
**Depends on**: Phase 32
**Requirements**: DOC-01, DOC-03 (DOC-02 deferred - no migration needed pre-production)
**Plans**: 1 plan

Plans:
- [x] 33-01-PLAN.md — Create primitives.md, composites.md, update docs index

**Details:**
- docs/primitives.md: Catalog of 22 compiler-owned components with links to existing docs
- docs/composites.md: User-definable layer with 3 pattern examples (conditional wrapper, repeated section, enhanced behavior)
- docs/README.md: Updated index with primitives.md and composites.md entries
- Link-instead-of-duplicate strategy avoids documentation drift
- Copy-and-modify guidance empowers users to fork composites
- Complete TSX + emitted markdown examples for all patterns

---

## Milestone Summary

**Key Decisions:**

- Extract-based SubComponentContent pattern: Explicit allow-list vs implicit deny-list
- Shell variable syntax ($VAR.path) for RuntimeVar interpolation in markdown
- GroupNode wrapping for multi-block fragment returns
- Context-based prop/children substitution in static transformer
- Composites directory with separate package.json subpath export

**Issues Resolved:**

- Array access formatting bug (map+join produced stray dots before brackets)
- Fragment composition returning only first block instead of all blocks
- Static/runtime transformer parity for component composition

**Issues Deferred:**

- DOC-02: Migration guide for existing components (deferred — no migration needed pre-production)

**Technical Debt Incurred:**

- None significant

---

_For current project status, see .planning/ROADMAP.md_
