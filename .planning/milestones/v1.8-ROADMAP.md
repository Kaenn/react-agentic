# Milestone v1.8: Scoped State Skills

**Status:** ✅ SHIPPED 2026-01-26
**Phases:** 19
**Total Plans:** 4

## Overview

Refactored state system to use provider-agnostic, scoped skills — each State definition generates namespaced CRUD skills with code-driven execution. TypeScript interfaces define state shape at compile time, SQLite provider generates deterministic bash/sqlite3 skills.

## Phases

### Phase 19: Scoped State Skills

**Goal**: Refactor state to use scoped skills per state definition with provider-agnostic code templates
**Depends on**: Phase 18
**Requirements**: SSTATE-01 through SSTATE-08
**Plans**: 4 plans

Plans:
- [x] 19-01: IR and JSX type extensions for State/Operation
- [x] 19-02: Provider templates (SQLite only for this phase)
- [x] 19-03: State parser and transformer
- [x] 19-04: Emitter and CLI multi-skill output

**Details:**

Core objectives achieved:
- Centralize provider logic — removed MCP boilerplate from commands
- Type-safe state — TypeScript interface defines state shape at compile time
- SQLite provider — bash + sqlite3 CLI for all generated code
- Scoped skills — each state generates namespaced skills (/releases:read, /config:write)
- Code-driven execution — skills contain deterministic code, not AI interpretation
- Low context loading — generated skills are self-contained
- Auto-generated CRUD — every state gets init, read, write, delete automatically
- Custom operations — define semantic operations (/releases:record) beyond basic CRUD

Component API:
```tsx
interface ReleasesState {
  lastVersion: string;
  bumpType: 'major' | 'minor' | 'patch';
  updatedAt: string;
}

export default function ReleasesState() {
  return (
    <State<ReleasesState>
      name="releases"
      provider="sqlite"
      config={{ database: ".state/state.db" }}
    >
      <Operation name="record">
        {`UPDATE releases SET lastVersion = '$version', bumpType = '$bump_type' WHERE rowid = 1`}
      </Operation>
    </State>
  );
}
```

Output structure:
```
.claude/skills/
├── releases.init.md    # Auto: CREATE TABLE
├── releases.read.md    # Auto: SQLite SELECT
├── releases.write.md   # Auto: SQLite UPDATE
├── releases.delete.md  # Auto: Reset to defaults
└── releases.record.md  # Custom operation
```

---

## Milestone Summary

**Key Decisions:**

- phantom-type-generic: TSchema phantom type for compile-time type checking
- state-provider-config: Separate config object for SQLite-specific configuration
- provider-registry-pattern: Map-based registry with registerProvider/getProvider
- sql-escaping-approach: Double single quotes in SQL strings for injection prevention
- json-output-format: sqlite3 -json piped through jq for reliable parsing
- async-provider-loading: getProviderAsync with dynamic import avoids circular dependency
- multi-file-output: State generates 4+ skill files to .claude/skills/{state}.{op}.md

**Issues Resolved:**

- Circular dependency in provider registry (ESM hoisting issue)
- Schema flattening for nested TypeScript interfaces
- SQL argument inference from $variable patterns

**Issues Deferred:**

- Additional providers (localfile, supabase, postgres) deferred to future milestones
- State migration tooling deferred

**Technical Debt Incurred:**

- Pre-existing TypeScript error in build.ts:86 (extractPromptPlaceholders call) - unrelated to Phase 19

---

_For current project status, see .planning/ROADMAP.md_
