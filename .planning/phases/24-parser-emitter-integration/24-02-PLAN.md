---
phase: 24-parser-emitter-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/verification/test-control-flow.tsx
  - src/app/verification/test-step.tsx
  - src/app/verification/integration-v2.tsx
autonomous: true

must_haves:
  truths:
    - "Loop component emits 'For each X in Y:' pattern with children"
    - "OnStatus component emits 'On STATUS:' conditional blocks"
    - "Step component emits numbered sections in heading/bold/xml variants"
    - "Integration test demonstrates all v2.0 components working together"
    - "Render props pattern works with Command and Agent context"
  artifacts:
    - path: "src/app/verification/test-control-flow.tsx"
      provides: "Loop and OnStatus test cases"
    - path: "src/app/verification/test-step.tsx"
      provides: "Step component variant tests"
    - path: "src/app/verification/integration-v2.tsx"
      provides: "All v2.0 components in one file"
    - path: ".claude/commands/test-control-flow.md"
      provides: "Generated markdown for control flow tests"
    - path: ".claude/commands/test-step.md"
      provides: "Generated markdown for Step tests"
    - path: ".claude/commands/integration-v2.md"
      provides: "Generated markdown demonstrating all v2.0 features"
  key_links:
    - from: "integration-v2.tsx"
      to: ".claude/commands/integration-v2.md"
      via: "build command"
      pattern: "all v2.0 components emit correctly in combination"
---

<objective>
Create verification tests for control flow components (Loop, OnStatus, Step) and an integration test demonstrating all v2.0 components together.

Purpose: Complete test coverage for Phase 23 control flow patterns and prove all v2.0 components work in combination.
Output: Three test files covering control flow, Step variants, and full v2.0 integration.
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/24-parser-emitter-integration/24-RESEARCH.md

Key reference files:
- src/app/scenarios/4.1-simple-if-condition.tsx (existing If test pattern)
- src/app/scenarios/4.2-if-else-pair.tsx (existing If/Else pattern)
- src/app/test-render-props.tsx (existing render props pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create control flow test (Loop, OnStatus)</name>
  <files>src/app/verification/test-control-flow.tsx</files>
  <action>
Create test-control-flow.tsx that tests Loop and OnStatus components.

Note: If/Else already tested in scenarios/4.1 and 4.2. This focuses on the untested control flow.

Test cases for Loop:
1. Basic loop with string items
2. Loop with custom `as` parameter name
3. Loop with variable reference for items

Test cases for OnStatus:
1. OnStatus SUCCESS handler
2. OnStatus ERROR handler
3. Multiple OnStatus handlers for same spawn

Pattern:
```tsx
import { Command, Loop, OnStatus, SpawnAgent, useVariable, useOutput } from '../../jsx.js';

export default function TestControlFlow() {
  const files = useVariable<string[]>("FILES");
  const output = useOutput("spawn-result");

  return (
    <Command name="test-control-flow" description="Verify Loop and OnStatus components">
      <h2>Test 1: Basic Loop</h2>
      <Loop items={["item1", "item2", "item3"]} as="item">
        <p>Processing: {item}</p>
      </Loop>

      <h2>Test 2: Loop with Custom As</h2>
      <Loop items={["a.ts", "b.ts"]} as="file">
        <p>Building: {file}</p>
      </Loop>

      <h2>Test 3: Loop with Variable</h2>
      <Loop items={files} as="f">
        <p>File: {f}</p>
      </Loop>

      <h2>Test 4: OnStatus SUCCESS</h2>
      <SpawnAgent agent="test-agent" input={{ data: "test" }} output={output} />
      <OnStatus output={output} status="SUCCESS">
        <p>Agent completed successfully</p>
      </OnStatus>

      <h2>Test 5: OnStatus ERROR</h2>
      <OnStatus output={output} status="ERROR">
        <p>Agent encountered an error</p>
      </OnStatus>
    </Command>
  );
}
```

Build and verify output patterns.
  </action>
  <verify>
```bash
node dist/cli/index.js build src/app/verification/test-control-flow.tsx
cat .claude/commands/test-control-flow.md
```
Verify:
- Loop emits `**For each {as} in {items}:**` pattern
- OnStatus emits `**On SUCCESS:**` and `**On ERROR:**` blocks
  </verify>
  <done>test-control-flow.tsx builds with correct Loop and OnStatus markdown patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create Step component test (all variants)</name>
  <files>src/app/verification/test-step.tsx</files>
  <action>
Create test-step.tsx testing all Step component variants:

1. Default variant (heading) - emits `### Step N: {name}`
2. Bold variant - emits `**Step N: {name}**`
3. XML variant - emits `<step number="N" name="...">`
4. Step with children content

Pattern:
```tsx
import { Command, Step } from '../../jsx.js';

export default function TestStep() {
  return (
    <Command name="test-step" description="Verify Step component variants">
      <h2>Default Variant (heading)</h2>
      <Step name="Initialize" number={1}>
        <p>Set up the environment</p>
      </Step>

      <Step name="Execute" number={2}>
        <p>Run the main task</p>
      </Step>

      <h2>Bold Variant</h2>
      <Step name="Setup" number={1} variant="bold">
        <p>Bold step content</p>
      </Step>

      <h2>XML Variant</h2>
      <Step name="Configure" number={1} variant="xml">
        <p>XML wrapped step content</p>
      </Step>

      <h2>Mixed Variants in Sequence</h2>
      <Step name="First" number={1} variant="heading">
        <p>Heading style step</p>
      </Step>
      <Step name="Second" number={2} variant="bold">
        <p>Bold style step</p>
      </Step>
      <Step name="Third" number={3} variant="xml">
        <p>XML style step</p>
      </Step>
    </Command>
  );
}
```

Build and verify all three variants emit correctly.
  </action>
  <verify>
```bash
node dist/cli/index.js build src/app/verification/test-step.tsx
cat .claude/commands/test-step.md
```
Verify:
- heading variant: `### Step 1: Initialize`
- bold variant: `**Step 1: Setup**`
- xml variant: `<step number="1" name="Configure">`
  </verify>
  <done>test-step.tsx builds with all three Step variants emitting correctly</done>
</task>

<task type="auto">
  <name>Task 3: Create v2.0 integration test</name>
  <files>src/app/verification/integration-v2.tsx</files>
  <action>
Create integration-v2.tsx that demonstrates ALL v2.0 features in a single command:

**Phase 21 (Structured Props):**
- Table with headers, rows, alignment
- List (bullet and ordered)

**Phase 22 (Semantic Components):**
- ExecutionContext
- SuccessCriteria
- OfferNext
- At least one XmlSection or wrapper component

**Phase 23 (Context Access):**
- Command with render props pattern accessing ctx.name
- If/Else conditional
- Loop
- Step component

This is a functional integration test proving all components work together in a realistic command.

Pattern:
```tsx
import {
  Command,
  Table,
  List,
  ExecutionContext,
  SuccessCriteria,
  OfferNext,
  XmlSection,
  If,
  Else,
  Loop,
  Step,
  useVariable
} from '../../jsx.js';
import { fileExists } from '../../jsx.js';

export default function IntegrationV2() {
  const mode = useVariable<string>("MODE");

  return (
    <Command name="integration-v2" description="Demonstrate all v2.0 features">
      {(ctx) => (
        <>
          <h1>v2.0 Feature Integration Test</h1>
          <p>Command: {ctx.name}</p>
          <p>Output path: {ctx.outputPath}</p>

          <ExecutionContext paths={[
            "project-config.json",
            "workflow-guide.md"
          ]} />

          <Step name="Gather Information" number={1}>
            <p>Collect required data before proceeding</p>
            <Table
              headers={["Field", "Source", "Required"]}
              rows={[
                ["Name", "package.json", "Yes"],
                ["Version", "package.json", "Yes"],
                ["Config", ".env", "No"]
              ]}
              align={["left", "left", "center"]}
            />
          </Step>

          <Step name="Conditional Processing" number={2}>
            <If test={fileExists("config.json")}>
              <p>Configuration found - using custom settings</p>
              <List items={["Load config", "Validate schema", "Apply settings"]} />
            </If>
            <Else>
              <p>No configuration - using defaults</p>
            </Else>
          </Step>

          <Step name="Process Items" number={3}>
            <Loop items={["task-a", "task-b", "task-c"]} as="task">
              <p>Executing: {task}</p>
            </Loop>
          </Step>

          <Step name="Verify Results" number={4}>
            <SuccessCriteria items={[
              "All tasks completed",
              "No errors in logs",
              { text: "Optional: Performance check", checked: false }
            ]} />
          </Step>

          <XmlSection name="guidelines">
            <p>Follow project coding standards</p>
            <p>Document all changes</p>
          </XmlSection>

          <OfferNext routes={[
            { name: "Deploy", path: "/deploy", description: "Deploy to production" },
            { name: "Test", path: "/run-tests", description: "Run test suite" },
            { name: "Rollback", path: "/rollback" }
          ]} />
        </>
      )}
    </Command>
  );
}
```

Build and verify all components emit in combination.
  </action>
  <verify>
```bash
node dist/cli/index.js build src/app/verification/integration-v2.tsx
cat .claude/commands/integration-v2.md
```
Verify markdown contains:
- Render props context interpolation (command name, output path)
- Table with alignment
- Lists (ordered and bullet)
- ExecutionContext XML section
- SuccessCriteria with checkboxes
- OfferNext routes
- XmlSection custom tag
- If/Else conditional blocks
- Loop iteration pattern
- Step headings
  </verify>
  <done>integration-v2.tsx builds demonstrating all v2.0 components working together</done>
</task>

</tasks>

<verification>
All test files build successfully:
```bash
node dist/cli/index.js build "src/app/verification/*.tsx"
ls .claude/commands/test-control-flow.md .claude/commands/test-step.md .claude/commands/integration-v2.md
```

Integration test markdown contains evidence of all Phase 21-23 components.
</verification>

<success_criteria>
- [ ] test-control-flow.tsx tests Loop (3 cases) and OnStatus (2+ cases)
- [ ] test-step.tsx tests all 3 Step variants (heading, bold, xml)
- [ ] integration-v2.tsx includes at least one example of every v2.0 component
- [ ] All files build without errors
- [ ] Integration test demonstrates render props, structured props, semantic, and control flow together
</success_criteria>

<output>
After completion, create `.planning/phases/24-parser-emitter-integration/24-02-SUMMARY.md`
</output>
