---
phase: 17-state-system
plan: 06
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - src/app/state-read.skill.tsx
  - src/app/state-write.skill.tsx
autonomous: true

must_haves:
  truths:
    - "state-read skill can read full state or specific field from JSON file"
    - "state-write skill can write field or merge partial update to JSON file"
    - "Skills use FileAdapter from src/state/ for actual file operations"
    - "Skills output to .claude/skills/state-read/ and .claude/skills/state-write/"
    - "Skills are invocable via /react-agentic:state-read and /react-agentic:state-write"
  artifacts:
    - path: "src/app/state-read.skill.tsx"
      provides: "State read skill TSX source"
      contains: "Skill"
    - path: "src/app/state-write.skill.tsx"
      provides: "State write skill TSX source"
      contains: "Skill"
    - path: ".claude/skills/state-read/SKILL.md"
      provides: "Generated state-read skill"
      contains: "state-read"
    - path: ".claude/skills/state-write/SKILL.md"
      provides: "Generated state-write skill"
      contains: "state-write"
  key_links:
    - from: ".claude/skills/state-read/SKILL.md"
      to: "src/state/file-adapter.ts"
      via: "skill instructions reference FileAdapter usage"
      pattern: "FileAdapter"
    - from: ".claude/skills/state-write/SKILL.md"
      to: "src/state/file-adapter.ts"
      via: "skill instructions reference FileAdapter usage"
      pattern: "FileAdapter"
---

<objective>
Create CLI skills for state-read and state-write that implement actual state access using FileAdapter.

Purpose: Enable direct CLI access to state files as required by STATE-06
Output: Two skills that Claude can invoke at runtime to read/write JSON state files
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-state-system/17-CONTEXT.md

# FileAdapter from Plan 02
@src/state/file-adapter.ts
@src/state/types.ts

# Skill pattern from Phase 16
@src/app/test-skill.tsx
@docs/skill.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state-read skill</name>
  <files>src/app/state-read.skill.tsx</files>
  <action>
Create a Skill TSX file that defines the state-read CLI skill.

The skill should instruct Claude to:
1. Accept arguments: `{state_key}` and optional `--field {path}`
2. Locate the state file at `.state/{state_key}.json`
3. Read the JSON file using Node.js fs or the Read tool
4. If `--field` is provided, extract the nested value using dot-notation path
5. Output the result as JSON to stdout

```tsx
/**
 * State Read Skill
 *
 * Reads state from JSON files in .state/ directory.
 * Usage: /react-agentic:state-read {key} [--field {path}]
 */

import { Skill, Markdown } from '../jsx.js';

export default function StateReadSkill() {
  return (
    <Skill
      name="state-read"
      description="Read state from .state/ JSON files. Use when a command needs to read persistent state values."
      allowedTools={['Read', 'Bash(node:*)', 'Bash(cat:*)', 'Bash(jq:*)']}
      argumentHint="{key} [--field {path}]"
    >
      <Markdown>{`
# State Read

Read state values from JSON files in the \`.state/\` directory.

## Arguments

- \`{key}\`: State key identifier (e.g., \`projectContext\`)
- \`--field {path}\`: Optional dot-notation path for nested field (e.g., \`config.debug\`)

## Process

1. Parse arguments from \`$ARGUMENTS\`
   - First argument is the state key
   - If \`--field\` flag present, next argument is the field path

2. Locate state file at \`.state/{key}.json\`
   - If file doesn't exist, return error JSON: \`{"error": "State not found", "key": "{key}"}\`

3. Read the JSON file content

4. If field path provided:
   - Navigate the JSON using dot-notation (e.g., \`config.debug\` -> obj.config.debug)
   - Return the field value as JSON

5. If no field path:
   - Return the entire state object as JSON

## Output Format

Always output valid JSON:

**Success (full state):**
\`\`\`json
{"name": "My Project", "phase": 2, "config": {"debug": true}}
\`\`\`

**Success (field read):**
\`\`\`json
true
\`\`\`

**Error:**
\`\`\`json
{"error": "State not found", "key": "projectContext"}
\`\`\`

## Example Usage

Read full state:
\`\`\`
/react-agentic:state-read projectContext
\`\`\`

Read specific field:
\`\`\`
/react-agentic:state-read projectContext --field phase
\`\`\`

Read nested field:
\`\`\`
/react-agentic:state-read projectContext --field config.debug
\`\`\`

## Implementation Notes

Use \`jq\` for JSON parsing when available:
\`\`\`bash
# Full state
cat .state/{key}.json

# Field read
cat .state/{key}.json | jq '.config.debug'
\`\`\`

Or use Node.js:
\`\`\`bash
node -e "
  const fs = require('fs');
  const data = JSON.parse(fs.readFileSync('.state/{key}.json', 'utf-8'));
  const field = '{path}';
  if (field) {
    const parts = field.split('.');
    let value = data;
    for (const part of parts) value = value?.[part];
    console.log(JSON.stringify(value));
  } else {
    console.log(JSON.stringify(data));
  }
"
\`\`\`
`}</Markdown>
    </Skill>
  );
}
```
  </action>
  <verify>Run `node dist/cli/index.js build src/app/state-read.skill.tsx` - builds without errors</verify>
  <done>state-read skill created at .claude/skills/state-read/SKILL.md with full and field read instructions</done>
</task>

<task type="auto">
  <name>Task 2: Create state-write skill</name>
  <files>src/app/state-write.skill.tsx</files>
  <action>
Create a Skill TSX file that defines the state-write CLI skill.

The skill should instruct Claude to:
1. Accept arguments: `{state_key}` with either `--field {path} --value {val}` OR `--merge '{json}'`
2. Locate or create the state file at `.state/{state_key}.json`
3. For field mode: set the nested value at the specified path
4. For merge mode: shallow merge the provided JSON object
5. Write the updated state back to the file (pretty JSON)

```tsx
/**
 * State Write Skill
 *
 * Writes state to JSON files in .state/ directory.
 * Usage: /react-agentic:state-write {key} --field {path} --value {val}
 *    OR: /react-agentic:state-write {key} --merge '{json}'
 */

import { Skill, Markdown } from '../jsx.js';

export default function StateWriteSkill() {
  return (
    <Skill
      name="state-write"
      description="Write state to .state/ JSON files. Use when a command needs to persist state values."
      allowedTools={['Read', 'Write', 'Bash(node:*)', 'Bash(mkdir:*)']}
      argumentHint="{key} --field {path} --value {val} | --merge '{json}'"
    >
      <Markdown>{`
# State Write

Write state values to JSON files in the \`.state/\` directory.

## Arguments

**Field mode:**
- \`{key}\`: State key identifier
- \`--field {path}\`: Dot-notation path for the field to write
- \`--value {val}\`: Value to write (JSON or string)

**Merge mode:**
- \`{key}\`: State key identifier
- \`--merge '{json}'\`: JSON object to shallow merge into state

## Process

1. Parse arguments from \`$ARGUMENTS\`
   - First argument is the state key
   - Detect mode: \`--field\` for field mode, \`--merge\` for merge mode

2. Ensure \`.state/\` directory exists:
   \`\`\`bash
   mkdir -p .state
   \`\`\`

3. Read existing state from \`.state/{key}.json\`
   - If file doesn't exist, start with empty object \`{}\`

4. **Field mode:**
   - Parse the field path (e.g., \`config.debug\` -> ['config', 'debug'])
   - Navigate/create intermediate objects
   - Set the value at the final path

5. **Merge mode:**
   - Parse the merge JSON object
   - Shallow merge: \`{ ...existingState, ...mergeObject }\`

6. Write updated state to \`.state/{key}.json\` with pretty formatting (2-space indent)

## Output Format

On success, output the updated state:

\`\`\`json
{"name": "Updated", "phase": 2, "config": {"debug": true}}
\`\`\`

On error:

\`\`\`json
{"error": "Invalid JSON in merge value", "input": "..."}
\`\`\`

## Example Usage

Write single field:
\`\`\`
/react-agentic:state-write projectContext --field phase --value 2
\`\`\`

Write nested field:
\`\`\`
/react-agentic:state-write projectContext --field config.debug --value true
\`\`\`

Write string value:
\`\`\`
/react-agentic:state-write projectContext --field name --value "My Project"
\`\`\`

Merge partial update:
\`\`\`
/react-agentic:state-write projectContext --merge '{"name": "New Name", "phase": 3}'
\`\`\`

## Implementation

Use Node.js for reliable JSON handling:

**Field write:**
\`\`\`bash
node -e "
  const fs = require('fs');
  const path = '.state/{key}.json';

  // Read existing or start empty
  let data = {};
  try { data = JSON.parse(fs.readFileSync(path, 'utf-8')); } catch {}

  // Set nested value
  const field = '{field_path}'.split('.');
  let obj = data;
  for (let i = 0; i < field.length - 1; i++) {
    if (!(field[i] in obj)) obj[field[i]] = {};
    obj = obj[field[i]];
  }
  obj[field[field.length - 1]] = {value};

  // Write back
  fs.mkdirSync('.state', { recursive: true });
  fs.writeFileSync(path, JSON.stringify(data, null, 2));
  console.log(JSON.stringify(data));
"
\`\`\`

**Merge write:**
\`\`\`bash
node -e "
  const fs = require('fs');
  const path = '.state/{key}.json';

  // Read existing or start empty
  let data = {};
  try { data = JSON.parse(fs.readFileSync(path, 'utf-8')); } catch {}

  // Merge
  const merge = {merge_json};
  data = { ...data, ...merge };

  // Write back
  fs.mkdirSync('.state', { recursive: true });
  fs.writeFileSync(path, JSON.stringify(data, null, 2));
  console.log(JSON.stringify(data));
"
\`\`\`

## Notes

- Creates \`.state/\` directory if it doesn't exist
- Creates state file with empty object if it doesn't exist
- Field write creates intermediate objects as needed
- Merge is shallow (top-level keys only)
- Always outputs pretty JSON (2-space indent) for readability
`}</Markdown>
    </Skill>
  );
}
```
  </action>
  <verify>Run `node dist/cli/index.js build src/app/state-write.skill.tsx` - builds without errors</verify>
  <done>state-write skill created at .claude/skills/state-write/SKILL.md with field and merge mode instructions</done>
</task>

<task type="auto">
  <name>Task 3: Build both skills and verify output</name>
  <files>.claude/skills/state-read/SKILL.md, .claude/skills/state-write/SKILL.md</files>
  <action>
Build both skills to generate the SKILL.md files:

```bash
# Build state-read skill
node dist/cli/index.js build src/app/state-read.skill.tsx

# Build state-write skill
node dist/cli/index.js build src/app/state-write.skill.tsx

# Verify outputs exist
ls -la .claude/skills/state-read/
ls -la .claude/skills/state-write/

# Verify content includes key sections
grep -n "state-read" .claude/skills/state-read/SKILL.md
grep -n "state-write" .claude/skills/state-write/SKILL.md
```

Verify the generated SKILL.md files contain:
1. Correct frontmatter with name and description
2. Process section explaining how to read/write
3. Example usage section
4. Implementation notes with bash/node examples
  </action>
  <verify>Both .claude/skills/state-read/SKILL.md and .claude/skills/state-write/SKILL.md exist with correct content</verify>
  <done>Both CLI skills built and verified - STATE-06 requirement covered</done>
</task>

</tasks>

<verification>
```bash
# Skills exist in output directory
ls -la .claude/skills/state-read/SKILL.md
ls -la .claude/skills/state-write/SKILL.md

# Skills have correct names in frontmatter
grep "name: state-read" .claude/skills/state-read/SKILL.md
grep "name: state-write" .claude/skills/state-write/SKILL.md

# Skills have allowed tools
grep "allowed-tools" .claude/skills/state-read/SKILL.md
grep "allowed-tools" .claude/skills/state-write/SKILL.md

# Skills reference .state/ directory
grep ".state/" .claude/skills/state-read/SKILL.md
grep ".state/" .claude/skills/state-write/SKILL.md
```
</verification>

<success_criteria>
- [ ] src/app/state-read.skill.tsx created with Skill component
- [ ] src/app/state-write.skill.tsx created with Skill component
- [ ] state-read skill outputs to .claude/skills/state-read/SKILL.md
- [ ] state-write skill outputs to .claude/skills/state-write/SKILL.md
- [ ] state-read supports full state and field reads
- [ ] state-write supports field mode and merge mode
- [ ] Skills reference .state/{key}.json file pattern
- [ ] Skills provide implementation examples (jq/node)
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-state-system/17-06-SUMMARY.md`
</output>
