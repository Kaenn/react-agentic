---
phase: 05-composition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/parser/parser.ts
  - src/parser/transformer.ts
  - tests/parser/transformer.test.ts
autonomous: true

must_haves:
  truths:
    - "User can write `{...baseProps}` in Command element and props resolve from object literal"
    - "Later props override earlier spread props (spread order matters)"
    - "Non-identifier spread expressions throw descriptive error"
    - "Non-object-literal spread sources throw descriptive error"
  artifacts:
    - path: "src/parser/parser.ts"
      provides: "resolveSpreadAttribute function for object literal extraction"
      exports: ["resolveSpreadAttribute"]
    - path: "src/parser/transformer.ts"
      provides: "Command spread attribute handling"
      contains: "JsxSpreadAttribute"
  key_links:
    - from: "src/parser/transformer.ts"
      to: "src/parser/parser.ts"
      via: "import resolveSpreadAttribute"
      pattern: "resolveSpreadAttribute"
---

<objective>
Implement static props spreading for Command elements

Purpose: Enable users to define shared props in object literals and spread them into Command elements at transpile time, reducing duplication across similar commands.

Output: Working `{...baseProps}` support in Command elements with proper prop merging
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-composition/05-RESEARCH.md

# Relevant source files
@src/parser/parser.ts
@src/parser/transformer.ts
@tests/parser/transformer.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement spread attribute resolution in parser</name>
  <files>src/parser/parser.ts</files>
  <action>
Add functions to resolve spread attributes to their object literal values:

1. `resolveSpreadAttribute(spreadAttr: JsxSpreadAttribute, sourceFile: SourceFile)`:
   - Get expression from spreadAttr.getExpression()
   - Validate it's an Identifier (throw if not: "Spread expressions must be simple identifiers")
   - Get symbol via expression.getSymbol()
   - Find variable declaration from symbol.getDeclarations()
   - Get initializer from variable declaration
   - Validate it's ObjectLiteralExpression (throw if not: "Spread source must be an object literal")
   - Call extractObjectLiteralProps to get values
   - Return Record<string, unknown>

2. `extractObjectLiteralProps(objLiteral: ObjectLiteralExpression)`:
   - Iterate objLiteral.getProperties()
   - For PropertyAssignment: extract name and initializer value
   - Handle StringLiteral, ArrayLiteralExpression, NumericLiteral, TrueKeyword, FalseKeyword
   - For arrays, use existing extractArrayLiteral pattern from getArrayAttributeValue
   - Return Record<string, unknown>

Import from ts-morph: JsxSpreadAttribute, ObjectLiteralExpression, SyntaxKind

Export: resolveSpreadAttribute function
  </action>
  <verify>
`npm run typecheck` passes with no errors on new functions
  </verify>
  <done>
resolveSpreadAttribute function exists and handles identifier -> object literal resolution with descriptive errors for invalid cases
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate spread handling into Command transformation</name>
  <files>src/parser/transformer.ts, tests/parser/transformer.test.ts</files>
  <action>
Modify transformCommand to handle spread attributes:

1. In transformer.ts:
   - Import resolveSpreadAttribute from parser.ts
   - Import Node, JsxSpreadAttribute from ts-morph
   - Create helper `mergeCommandProps(opening, sourceFile)`:
     - Initialize empty merged object
     - Iterate opening.getAttributes() in order
     - For JsxSpreadAttribute: resolve and Object.assign into merged
     - For JsxAttribute: extract value using existing getAttributeValue/getArrayAttributeValue
     - Return merged Record<string, unknown>
   - Update transformCommand to:
     - Get sourceFile from node (node.getSourceFile())
     - Call mergeCommandProps instead of individual getAttributeValue calls
     - Extract name, description, allowedTools from merged object
     - Keep existing validation (name required, description required)

2. In transformer.test.ts, add tests in "Command component" describe block:
   - Test: spread props from object literal resolves correctly
   - Test: explicit props override spread props (later wins)
   - Test: multiple spreads merge in order
   - Test: throws for non-identifier spread `{...getProps()}`
   - Test: throws for non-object spread source

Example test:
```typescript
it('resolves spread props from object literal', () => {
  const source = `
    const baseProps = { name: "base", description: "Base command" };
    export default function MyCommand() {
      return (
        <Command {...baseProps}>
          <p>Content</p>
        </Command>
      );
    }
  `;
  const doc = transformTsx(source);
  expect(doc.frontmatter?.data).toEqual({
    name: 'base',
    description: 'Base command',
  });
});
```
  </action>
  <verify>
`npm test` passes all existing and new spread-related tests
  </verify>
  <done>
Command elements accept spread attributes, props merge in order, and tests verify spread behavior
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` - no type errors
2. `npm test` - all tests pass including new spread tests
3. Manual verification:
   ```typescript
   const baseProps = { name: "test", description: "A test" };
   <Command {...baseProps} allowedTools={["Read"]}>
   ```
   Produces frontmatter with name, description, and allowed-tools
</verification>

<success_criteria>
- [ ] resolveSpreadAttribute function handles object literal extraction
- [ ] extractObjectLiteralProps extracts string, array, number, boolean values
- [ ] transformCommand merges spread props with explicit props
- [ ] Later props override earlier (spread order respected)
- [ ] Clear errors for non-identifier spreads and non-object sources
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-composition/05-01-SUMMARY.md`
</output>
