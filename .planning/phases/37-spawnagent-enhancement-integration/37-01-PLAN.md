---
phase: 37-spawnagent-enhancement-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/Agent.ts
  - src/ir/runtime-nodes.ts
  - src/parser/transformers/spawner.ts
  - src/emitter/runtime-markdown-emitter.ts
  - src/cli/config.ts
autonomous: true

must_haves:
  truths:
    - "SpawnAgent accepts readAgentFile boolean prop"
    - "readAgentFile=true emits 'First, read {path} for your role and instructions' instruction"
    - "readAgentFile requires agent prop (compile error if missing)"
    - "agentsDir config defaults to ~/.claude/agents/"
  artifacts:
    - path: "src/components/Agent.ts"
      provides: "readAgentFile prop type"
      contains: "readAgentFile"
    - path: "src/ir/runtime-nodes.ts"
      provides: "readAgentFile field on SpawnAgentNode"
      contains: "readAgentFile?: boolean"
    - path: "src/parser/transformers/spawner.ts"
      provides: "readAgentFile extraction and validation"
      contains: "extractReadAgentFileProp"
    - path: "src/emitter/runtime-markdown-emitter.ts"
      provides: "self-reading instruction emission"
      contains: "First, read"
    - path: "src/cli/config.ts"
      provides: "agentsDir config field"
      contains: "agentsDir"
  key_links:
    - from: "src/parser/transformers/spawner.ts"
      to: "SpawnAgentNode.readAgentFile"
      via: "extractReadAgentFileProp"
      pattern: "readAgentFile.*extractReadAgentFileProp"
    - from: "src/emitter/runtime-markdown-emitter.ts"
      to: "agentsDir"
      via: "self-reading path construction"
      pattern: "agentsDir.*readAgentFile"
---

<objective>
Add readAgentFile prop to SpawnAgent that prepends self-reading instruction to agent prompts.

Purpose: Enable agents to read their own definition files before executing, matching the GSD pattern: "First, read {path} for your role and instructions."

Output: SpawnAgent accepts readAgentFile boolean; emitter prepends instruction using configurable agentsDir.
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-spawnagent-enhancement-integration/37-CONTEXT.md
@.planning/phases/37-spawnagent-enhancement-integration/37-RESEARCH.md

Source files:
@src/components/Agent.ts
@src/ir/runtime-nodes.ts
@src/parser/transformers/spawner.ts
@src/emitter/runtime-markdown-emitter.ts
@src/cli/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add readAgentFile to types and IR</name>
  <files>
    src/components/Agent.ts
    src/ir/runtime-nodes.ts
  </files>
  <action>
1. Add readAgentFile prop to SpawnAgentProps in src/components/Agent.ts:

In SpawnAgentProps interface (after loadFromFile prop, around line 163):
```typescript
/**
 * Enable agent self-reading pattern.
 * When true, prepends "First, read {agentsDir}/{agent}.md for your role and instructions."
 * Requires agent prop to be a string or AgentRef (not inline agent).
 */
readAgentFile?: boolean;
```

Also add to V3SpawnAgentProps interface (after loadFromFile prop):
```typescript
/** Enable agent self-reading pattern (prepends read instruction) */
readAgentFile?: OrRuntimeVar<boolean>;
```

2. Add readAgentFile field to SpawnAgentNode in src/ir/runtime-nodes.ts:

In SpawnAgentNode interface (after loadFromFile field, around line 317):
```typescript
/** Enable agent self-reading instruction prepend */
readAgentFile?: boolean;
```
  </action>
  <verify>
- npm run typecheck passes
- grep shows readAgentFile in SpawnAgentProps in Agent.ts
- grep shows readAgentFile in SpawnAgentNode in runtime-nodes.ts
  </verify>
  <done>readAgentFile prop added to SpawnAgentProps and SpawnAgentNode IR</done>
</task>

<task type="auto">
  <name>Task 2: Add agentsDir config field</name>
  <files>
    src/cli/config.ts
  </files>
  <action>
1. Add agentsDir to ReactAgenticConfig interface (after codeSplit):
```typescript
/** Directory for agent definition files (default: ~/.claude/agents/) */
agentsDir: string;
```

2. Add agentsDir to DEFAULT_CONFIG (after codeSplit: false):
```typescript
agentsDir: '~/.claude/agents/',
```

3. Add agentsDir parsing in loadConfigFile function (after codeSplit parsing):
```typescript
if (typeof parsed.agentsDir === 'string') {
  config.agentsDir = parsed.agentsDir;
}
```

4. Add agentsDir to CLIConfigOverrides interface (after codeSplit):
```typescript
agentsDir?: string;
```

5. Update resolveConfig to handle agentsDir (after codeSplit merging):
```typescript
agentsDir: cliOptions.agentsDir ?? fileConfig.agentsDir ?? DEFAULT_CONFIG.agentsDir,
```
  </action>
  <verify>
- npm run typecheck passes
- grep shows agentsDir in ReactAgenticConfig
- grep shows agentsDir in DEFAULT_CONFIG with ~/.claude/agents/
  </verify>
  <done>agentsDir config field added with default ~/.claude/agents/</done>
</task>

<task type="auto">
  <name>Task 3: Add transformer extraction and validation</name>
  <files>
    src/parser/transformers/spawner.ts
  </files>
  <action>
1. Add extractReadAgentFileProp function (after extractLoadFromFileProp function, around line 369):

```typescript
/**
 * Extract readAgentFile prop
 *
 * Supports:
 * - readAgentFile (boolean true shorthand)
 * - readAgentFile={true}
 * - readAgentFile={false}
 *
 * When true, validates that agent prop exists (can't self-read without agent name).
 */
function extractReadAgentFileProp(
  element: JsxOpeningElement | JsxSelfClosingElement,
  agentName: string | undefined,
  ctx: TransformContext
): boolean {
  const attr = element.getAttribute('readAgentFile');
  if (!attr || !Node.isJsxAttribute(attr)) {
    return false;
  }

  const init = attr.getInitializer();

  // Case 1: Boolean shorthand - readAgentFile (no value = true)
  if (!init) {
    validateCanSelfRead(agentName, element, ctx);
    return true;
  }

  // Case 2: JSX expression - readAgentFile={true|false}
  if (Node.isJsxExpression(init)) {
    const expr = init.getExpression();
    if (expr && expr.getText() === 'true') {
      validateCanSelfRead(agentName, element, ctx);
      return true;
    }
    if (expr && expr.getText() === 'false') {
      return false;
    }
  }

  throw ctx.createError(
    'readAgentFile must be a boolean (true or false)',
    element
  );
}

/**
 * Validate that agent name exists for self-reading pattern
 */
function validateCanSelfRead(
  agentName: string | undefined,
  element: JsxOpeningElement | JsxSelfClosingElement,
  ctx: TransformContext
): void {
  if (!agentName) {
    throw ctx.createError(
      'readAgentFile requires agent prop to be specified. ' +
      'Cannot self-read without an agent name.',
      element
    );
  }
}
```

2. Call extractReadAgentFileProp in transformSpawnAgent (after extractLoadFromFileProp call, around line 38):

```typescript
// Extract readAgentFile prop
const readAgentFile = extractReadAgentFileProp(openingElement, agentName, ctx);
```

3. Add readAgentFile to SpawnAgentNode return (after loadFromFile spread, around line 105):

```typescript
...(readAgentFile && { readAgentFile }),
```
  </action>
  <verify>
- npm run typecheck passes
- grep shows extractReadAgentFileProp function in spawner.ts
- grep shows validateCanSelfRead function in spawner.ts
- grep shows readAgentFile in the return object spread
  </verify>
  <done>readAgentFile prop extracted and validated in transformer</done>
</task>

<task type="auto">
  <name>Task 4: Add emitter self-reading instruction</name>
  <files>
    src/emitter/runtime-markdown-emitter.ts
  </files>
  <action>
1. First, find the emitSpawnAgent method (around line 624) and understand the current structure.

2. Update the emitSpawnAgent method to handle readAgentFile. After building promptContent (around line 635) but before handling loadFromFile, add:

```typescript
// Handle readAgentFile - prepends self-reading instruction
if (node.readAgentFile) {
  const agentName = typeof node.agent === 'string'
    ? node.agent
    : node.agent.varName; // RuntimeVarRefNode case

  // Construct path using agentsDir (expand ~ to home)
  const agentsDir = this.config?.agentsDir || '~/.claude/agents/';
  const expandedDir = agentsDir.startsWith('~')
    ? agentsDir.replace('~', require('os').homedir())
    : agentsDir;

  // Ensure path ends with / for clean joining
  const normalizedDir = expandedDir.endsWith('/') ? expandedDir : expandedDir + '/';
  const agentFilePath = `${normalizedDir}${agentName}.md`;

  // Prepend self-reading instruction (use \\n\\n for literal newlines in escaped string)
  const instruction = `First, read ${agentFilePath} for your role and instructions.\\n\\n`;
  promptContent = instruction + promptContent;
}
```

3. Check the RuntimeMarkdownEmitter class constructor and properties. If there's no config property, we need to add one. Add a config property and update constructor to accept it:

In the class (near the top, around line 20-30):
```typescript
/** Build configuration (for agentsDir, etc.) */
private config?: Partial<import('../cli/config.js').ReactAgenticConfig>;
```

Update constructor signature to accept config (if not already):
```typescript
constructor(
  document: DocumentNode,
  config?: Partial<import('../cli/config.js').ReactAgenticConfig>
) {
  this.document = document;
  this.config = config;
}
```

4. Also import os at the top of the file if not already imported:
```typescript
import os from 'os';
```

Note: Use require('os') inline OR add import - either works. Inline is simpler if the file doesn't already import os.
  </action>
  <verify>
- npm run typecheck passes
- grep shows "First, read" in emitSpawnAgent method
- grep shows agentsDir in emitSpawnAgent method
- npm run build passes
  </verify>
  <done>Self-reading instruction emitted when readAgentFile=true using agentsDir config</done>
</task>

</tasks>

<verification>
```bash
# Typecheck entire project
npm run typecheck

# Verify readAgentFile in types
grep -n "readAgentFile" src/components/Agent.ts

# Verify readAgentFile in IR
grep -n "readAgentFile" src/ir/runtime-nodes.ts

# Verify agentsDir in config
grep -n "agentsDir" src/cli/config.ts

# Verify transformer extraction
grep -n "extractReadAgentFileProp" src/parser/transformers/spawner.ts

# Verify emitter instruction
grep -n "First, read" src/emitter/runtime-markdown-emitter.ts

# Build to verify compilation
npm run build

# Run existing tests to ensure no regressions
npm test
```
</verification>

<success_criteria>
1. SpawnAgentProps has readAgentFile?: boolean
2. V3SpawnAgentProps has readAgentFile?: OrRuntimeVar<boolean>
3. SpawnAgentNode has readAgentFile?: boolean
4. ReactAgenticConfig has agentsDir with default ~/.claude/agents/
5. transformSpawnAgent extracts readAgentFile and validates agent prop exists
6. emitSpawnAgent prepends "First, read {path} for your role and instructions." when readAgentFile=true
7. All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/37-spawnagent-enhancement-integration/37-01-SUMMARY.md`
</output>
