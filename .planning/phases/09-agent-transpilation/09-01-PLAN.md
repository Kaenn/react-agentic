---
phase: 09-agent-transpilation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/jsx.ts
  - src/parser/transformer.ts
  - tests/parser/agent-transformer.test.ts
autonomous: true

must_haves:
  truths:
    - "Agent element is recognized as valid root element (not treated as custom component)"
    - "Agent without name prop throws TranspileError with source location"
    - "Agent without description prop throws TranspileError with source location"
    - "Agent with all props (name, description, tools, color) transforms to AgentDocumentNode"
    - "Agent children transform to BlockNode[] in AgentDocumentNode.children"
  artifacts:
    - path: "src/jsx.ts"
      provides: "AgentProps interface with required name/description and optional tools/color/folder/children"
      contains: "export interface AgentProps"
    - path: "src/jsx.ts"
      provides: "Agent function stub"
      contains: "export function Agent"
    - path: "src/parser/transformer.ts"
      provides: "transformAgent method"
      contains: "transformAgent"
    - path: "tests/parser/agent-transformer.test.ts"
      provides: "Agent transformation tests"
      min_lines: 80
  key_links:
    - from: "src/parser/transformer.ts"
      to: "src/ir/nodes.ts"
      via: "AgentDocumentNode, AgentFrontmatterNode imports"
      pattern: "AgentDocumentNode|AgentFrontmatterNode"
    - from: "src/parser/transformer.ts"
      to: "transform() method"
      via: "Agent detection before custom component check"
      pattern: "name === 'Agent'"
---

<objective>
Add Agent component parsing and IR transformation to the transpiler.

Purpose: Enable TSX files with `<Agent>` root element to be parsed and transformed to AgentDocumentNode IR, following the same patterns as Command transformation.

Output: Working Agent transformation that produces AgentDocumentNode with frontmatter and body content.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ir-extensions/08-01-SUMMARY.md
@.planning/phases/09-agent-transpilation/09-RESEARCH.md

@src/jsx.ts
@src/parser/transformer.ts
@src/ir/nodes.ts
@tests/parser/transformer.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AgentProps interface and Agent component stub</name>
  <files>src/jsx.ts</files>
  <action>
Add AgentProps interface and Agent function stub to jsx.ts, following the CommandProps/Command pattern exactly.

**AgentProps interface:**
```typescript
export interface AgentProps {
  /** Agent name (used in frontmatter and Task() spawning) */
  name: string;
  /** Agent description (used in frontmatter) */
  description: string;
  /** Space-separated tool names (optional) */
  tools?: string;
  /** Terminal color for agent output (optional) */
  color?: string;
  /** Subfolder for output path (optional) - determines namespaced agent name */
  folder?: string;
  /** Agent body content */
  children?: ReactNode;
}
```

**Agent function stub:**
```typescript
export function Agent(_props: AgentProps): null {
  return null;
}
```

Add JSDoc example showing usage with all props.

**Export:** Ensure both AgentProps and Agent are exported (they will be by virtue of being `export`).
  </action>
  <verify>
Run `npm run typecheck` - should pass with new types.
Run `npm run build` - dist/jsx.d.ts should include AgentProps and Agent exports.
  </verify>
  <done>
AgentProps interface has name (required), description (required), tools (optional), color (optional), folder (optional), children (optional). Agent function stub exists and returns null.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add transformAgent method and Agent detection</name>
  <files>src/parser/transformer.ts</files>
  <action>
Extend the Transformer class to handle Agent elements.

**Step 1: Add imports**
Add AgentDocumentNode and AgentFrontmatterNode to the import from '../ir/index.js'.

**Step 2: Add 'Agent' to SPECIAL_COMPONENTS**
Update the SPECIAL_COMPONENTS Set to include 'Agent':
```typescript
const SPECIAL_COMPONENTS = new Set(['Command', 'Markdown', 'XmlBlock', 'Agent']);
```
This prevents Agent from being treated as a custom component.

**Step 3: Update transform() method**
Add Agent detection AFTER Command check, BEFORE fragment handling:
```typescript
if (name === 'Command') {
  return this.transformCommand(node);
}
if (name === 'Agent') {
  return this.transformAgent(node);
}
```

**Step 4: Add transformAgent method**
Follow transformCommand pattern exactly. Key differences:
- Returns AgentDocumentNode (not DocumentNode)
- Uses AgentFrontmatterNode (not FrontmatterNode)
- Extracts tools and color as optional string props (not array)
- No mergeCommandProps equivalent needed (no spread support for now)

```typescript
private transformAgent(node: JsxElement | JsxSelfClosingElement): AgentDocumentNode {
  const openingElement = Node.isJsxElement(node)
    ? node.getOpeningElement()
    : node;

  // Extract required props
  const name = getAttributeValue(openingElement, 'name');
  const description = getAttributeValue(openingElement, 'description');

  if (!name) {
    throw this.createError('Agent requires name prop', openingElement);
  }
  if (!description) {
    throw this.createError('Agent requires description prop', openingElement);
  }

  // Extract optional props
  const tools = getAttributeValue(openingElement, 'tools');
  const color = getAttributeValue(openingElement, 'color');

  // Build frontmatter (using spread for optional fields)
  const frontmatter: AgentFrontmatterNode = {
    kind: 'agentFrontmatter',
    name,
    description,
    ...(tools && { tools }),
    ...(color && { color }),
  };

  // Transform children as body blocks
  const children: BlockNode[] = [];
  if (Node.isJsxElement(node)) {
    for (const child of node.getJsxChildren()) {
      const block = this.transformToBlock(child);
      if (block) children.push(block);
    }
  }

  return { kind: 'agentDocument', frontmatter, children };
}
```

**Step 5: Update transform() return type**
Change `transform()` return type from `DocumentNode` to `DocumentNode | AgentDocumentNode`:
```typescript
transform(node: JsxElement | JsxSelfClosingElement | JsxFragment, sourceFile?: SourceFile): DocumentNode | AgentDocumentNode
```

Also update the convenience function signature at the bottom of the file.

**Note:** The folder prop is NOT stored in frontmatter - it's only used for output path routing in build.ts (Plan 09-02).
  </action>
  <verify>
Run `npm run typecheck` - should pass with no errors.
Run `npm run build` - should succeed.
  </verify>
  <done>
transformAgent method exists, returns AgentDocumentNode, validates required props (name, description), extracts optional props (tools, color), and transforms children to BlockNode[]. Agent is in SPECIAL_COMPONENTS.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Agent transformation tests</name>
  <files>tests/parser/agent-transformer.test.ts</files>
  <action>
Create a new test file for Agent transformation following the pattern in transformer.test.ts.

**Test setup:**
```typescript
import { describe, it, expect } from 'vitest';
import { createProject, findRootJsxElement } from '../../src/parser/parser.js';
import { Transformer } from '../../src/parser/transformer.js';
import type { AgentDocumentNode } from '../../src/ir/index.js';

function transformTsx(tsx: string): AgentDocumentNode {
  const project = createProject();
  const source = project.createSourceFile('test.tsx', tsx, { overwrite: true });
  const root = findRootJsxElement(source);
  if (!root) throw new Error('No JSX found');
  const transformer = new Transformer();
  const doc = transformer.transform(root);
  if (doc.kind !== 'agentDocument') {
    throw new Error(`Expected agentDocument, got ${doc.kind}`);
  }
  return doc;
}
```

**Test cases (at least 8):**

1. **Basic Agent transformation** - Agent with required props only
2. **Agent with all props** - name, description, tools, color
3. **Agent with body content** - paragraph child
4. **Agent with multiple children** - heading + paragraph
5. **Self-closing Agent** - `<Agent name="x" description="y" />`
6. **Agent without name throws** - expect TranspileError with location
7. **Agent without description throws** - expect TranspileError with location
8. **Agent tools is string not array** - verify tools prop is stored as-is

**Example test:**
```typescript
describe('Agent transformation', () => {
  it('transforms Agent with required props', () => {
    const tsx = `export default function MyAgent() {
      return (
        <Agent name="researcher" description="Research topics">
        </Agent>
      );
    }`;
    const doc = transformTsx(tsx);

    expect(doc.kind).toBe('agentDocument');
    expect(doc.frontmatter.kind).toBe('agentFrontmatter');
    expect(doc.frontmatter.name).toBe('researcher');
    expect(doc.frontmatter.description).toBe('Research topics');
    expect(doc.frontmatter.tools).toBeUndefined();
    expect(doc.frontmatter.color).toBeUndefined();
    expect(doc.children).toHaveLength(0);
  });

  it('throws for Agent without name', () => {
    const tsx = `export default function BadAgent() {
      return <Agent description="Missing name" />;
    }`;
    expect(() => transformTsx(tsx)).toThrow(/Agent requires name prop/);
  });
});
```

Ensure all tests follow project conventions (vitest, descriptive names).
  </action>
  <verify>
Run `npm test tests/parser/agent-transformer.test.ts` - all tests pass.
Run `npm test` - all 165+ tests pass (no regressions).
  </verify>
  <done>
8+ tests covering Agent transformation: required props, all props, body content, multiple children, self-closing, missing name error, missing description error, tools as string.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type checking:** `npm run typecheck` passes
2. **Build:** `npm run build` succeeds
3. **Tests:** `npm test` - all tests pass including new Agent transformation tests
4. **Manual verification:**
   - Create a test TSX file with Agent component
   - Transform it using the transformer
   - Verify AgentDocumentNode structure in debugger/console

**Sample verification TSX:**
```tsx
export default function TestAgent() {
  return (
    <Agent name="test-agent" description="Test description" tools="Read Grep Glob" color="cyan">
      <h1>Role</h1>
      <p>You are a test agent.</p>
    </Agent>
  );
}
```

Expected AgentDocumentNode:
```json
{
  "kind": "agentDocument",
  "frontmatter": {
    "kind": "agentFrontmatter",
    "name": "test-agent",
    "description": "Test description",
    "tools": "Read Grep Glob",
    "color": "cyan"
  },
  "children": [
    { "kind": "heading", "level": 1, "children": [...] },
    { "kind": "paragraph", "children": [...] }
  ]
}
```
</verification>

<success_criteria>
- AgentProps interface exported from jsx.ts with correct required/optional props
- Agent function stub exported from jsx.ts
- transformAgent method in Transformer class produces AgentDocumentNode
- Agent added to SPECIAL_COMPONENTS (not treated as custom component)
- Required props (name, description) validated with TranspileError on missing
- Optional props (tools, color) correctly handled (omitted if undefined)
- 8+ tests covering transformation scenarios
- All tests pass, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09-agent-transpilation/09-01-SUMMARY.md`
</output>
