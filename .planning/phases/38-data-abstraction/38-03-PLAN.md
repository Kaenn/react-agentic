---
phase: 38-data-abstraction
plan: 03
type: execute
wave: 2
depends_on: ["38-01", "38-02"]
files_modified:
  - tests/grammar/VariableComponents/assign.test.ts
  - tests/grammar/VariableComponents/assign-group.test.ts
  - tests/grammar/VariableComponents/assign-from.test.ts
autonomous: true

must_haves:
  truths:
    - "All from={file(...)} tests pass with correct bash output"
    - "All from={bash(...)} tests pass with correct bash output"
    - "All from={value(...)} tests pass with quoted/raw output"
    - "All from={env(...)} tests pass with $VAR output"
    - "AssignGroup works with from prop syntax"
    - "Template string interpolation in file()/bash() emits shell variables"
  artifacts:
    - path: "tests/grammar/VariableComponents/assign-from.test.ts"
      provides: "Integration tests for from prop with all source types"
      min_lines: 100
  key_links:
    - from: "tests/grammar/VariableComponents/assign-from.test.ts"
      to: "src/primitives/sources.ts"
      via: "import source helpers"
      pattern: "from.*file.*bash.*value"
---

<objective>
Create comprehensive integration tests for the new `<Assign from={source}>` pattern covering all source types and edge cases.

Purpose: Validate the complete pipeline (TSX -> IR -> Markdown) for the unified assignment pattern.
Output: Test suite proving all source types work correctly with proper bash emission.
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-data-abstraction/38-CONTEXT.md
@.planning/phases/38-data-abstraction/38-01-SUMMARY.md
@.planning/phases/38-data-abstraction/38-02-SUMMARY.md
@tests/grammar/VariableComponents/assign.test.ts
@tests/grammar/VariableComponents/assign-group.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create from prop integration tests</name>
  <files>tests/grammar/VariableComponents/assign-from.test.ts</files>
  <action>
Create comprehensive test file for the from prop pattern:

```typescript
/**
 * Grammar Tests: Assign from Prop
 *
 * Tests the unified <Assign from={source}> pattern with all source types.
 */

import { describe, it, expect } from 'vitest';
import { transformAgentContent } from '../_helpers/test-utils.js';

describe('<Assign from={...}>', () => {
  describe('file() source', () => {
    it('emits VAR=$(cat path) format', () => {
      const tsx = `
        import { useVariable, file } from 'react-agentic';
        const STATE = useVariable("STATE");
        export default function Doc() {
          return (
            <Agent name="test" description="Test">
              <Assign var={STATE} from={file('.planning/STATE.md')} />
            </Agent>
          );
        }
      `;
      const output = transformAgentContent(tsx, true);
      expect(output).toContain('STATE=$(cat .planning/STATE.md)');
    });

    it('handles optional flag with 2>/dev/null', () => {
      // Test file('path', { optional: true })
    });

    it('handles template strings with variable refs', () => {
      // Test file(`${phaseDir}/*-PLAN.md`)
    });
  });

  describe('bash() source', () => {
    it('emits VAR=$(command) format', () => {
      // Test bash('echo hello')
    });

    it('handles template strings with variable refs', () => {
      // Test bash(`ls ${dir}`)
    });
  });

  describe('value() source', () => {
    it('emits VAR="value" format by default', () => {
      // Test value('hello world')
    });

    it('emits VAR=value unquoted with raw option', () => {
      // Test value('42', { raw: true })
    });
  });

  describe('env() source', () => {
    it('emits VAR=$ENV_VAR format', () => {
      // Test env('HOME')
    });
  });

  describe('in AssignGroup', () => {
    it('works with multiple from sources', () => {
      // Test AssignGroup with mixed sources
    });
  });

  describe('error cases', () => {
    it('throws when both from and bash props provided', () => {
      // Mutually exclusive check
    });
  });
});
```

Cover all patterns from RESEARCH.md examples. Use transformAgentContent from test helpers.
  </action>
  <verify>`npm test tests/grammar/VariableComponents/assign-from.test.ts` passes</verify>
  <done>All integration tests for from prop pattern pass</done>
</task>

<task type="auto">
  <name>Task 2: Update existing tests if needed</name>
  <files>tests/grammar/VariableComponents/assign.test.ts, tests/grammar/VariableComponents/assign-group.test.ts</files>
  <action>
Review existing tests and ensure they still work. The old syntax (bash=, value=, env=) should continue to work during this phase.

1. Run existing tests to verify backward compatibility:
```bash
npm test tests/grammar/VariableComponents/assign.test.ts
npm test tests/grammar/VariableComponents/assign-group.test.ts
```

2. If any tests fail due to IR changes, fix them to work with the updated AssignNode structure.

3. Add a comment in the test files indicating that these tests use legacy syntax that will be removed in Plan 04:
```typescript
// Note: These tests use legacy bash=/value=/env= syntax.
// See assign-from.test.ts for new from={source} pattern tests.
// Legacy props will be removed in Phase 38, Plan 04.
```

Do NOT migrate tests to new syntax yet - that's Plan 04.
  </action>
  <verify>All existing assign tests pass</verify>
  <done>Existing tests pass and are marked as legacy</done>
</task>

<task type="auto">
  <name>Task 3: Test template string interpolation</name>
  <files>tests/grammar/VariableComponents/assign-from.test.ts</files>
  <action>
Add tests for template string interpolation in file() and bash() sources:

```typescript
describe('template string interpolation', () => {
  it('converts ${varRef} to $VAR_NAME in file paths', () => {
    const tsx = `
      import { useVariable, file } from 'react-agentic';
      const PHASE_DIR = useVariable("PHASE_DIR");
      const PLAN = useVariable("PLAN");
      export default function Doc() {
        return (
          <Agent name="test" description="Test">
            <Assign var={PHASE_DIR} from={bash('ls -d .planning/phases/38-*')} />
            <Assign var={PLAN} from={file(\`\${PHASE_DIR}/38-PLAN.md\`)} />
          </Agent>
        );
      }
    `;
    const output = transformAgentContent(tsx, true);
    expect(output).toContain('PLAN=$(cat "$PHASE_DIR"/38-PLAN.md)');
  });

  it('converts ${varRef} to $VAR_NAME in bash commands', () => {
    const tsx = `
      import { useVariable, bash } from 'react-agentic';
      const DIR = useVariable("DIR");
      const FILES = useVariable("FILES");
      export default function Doc() {
        return (
          <Agent name="test" description="Test">
            <Assign var={DIR} from={bash('pwd')} />
            <Assign var={FILES} from={bash(\`ls \${DIR}\`)} />
          </Agent>
        );
      }
    `;
    const output = transformAgentContent(tsx, true);
    expect(output).toContain('FILES=$(ls $DIR)');
  });
});
```

These tests validate the CONTEXT.md requirement that file()/bash() support runtime refs via template strings.
  </action>
  <verify>Template interpolation tests pass</verify>
  <done>Template string interpolation works for file() and bash() sources</done>
</task>

</tasks>

<verification>
1. `npm test tests/grammar/VariableComponents/` passes all tests
2. New tests cover file(), bash(), value(), env() sources
3. Template string interpolation tested and working
4. Existing legacy tests still pass
</verification>

<success_criteria>
- [ ] assign-from.test.ts created with comprehensive tests
- [ ] All 4 source types tested with correct bash output
- [ ] Template string interpolation tested
- [ ] AssignGroup works with from syntax
- [ ] Existing legacy tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/38-data-abstraction/38-03-SUMMARY.md`
</output>
