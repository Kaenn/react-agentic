---
phase: 38-data-abstraction
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ir/nodes.ts
  - src/primitives/variables.ts
  - src/parser/transformers/variables.ts
  - src/emitter/emitter.ts
autonomous: true

must_haves:
  truths:
    - "AssignNode.assignment supports 'file', 'bash', 'value', 'env', 'runtimeFn' types"
    - "Transformer extracts from prop and creates correct AssignNode"
    - "Emitter produces correct bash for all source types"
    - "Old bash=/value=/env= props continue to work during transition"
  artifacts:
    - path: "src/ir/nodes.ts"
      provides: "Extended AssignNode with new assignment types"
      contains: "type: 'file'"
    - path: "src/parser/transformers/variables.ts"
      provides: "Transformer handling from prop"
      contains: "extractFromProp"
    - path: "src/emitter/emitter.ts"
      provides: "Emitter for new assignment types"
      contains: "case 'file'"
  key_links:
    - from: "src/parser/transformers/variables.ts"
      to: "src/ir/nodes.ts"
      via: "creates AssignNode"
      pattern: "kind: 'assign'"
    - from: "src/emitter/emitter.ts"
      to: "src/ir/nodes.ts"
      via: "consumes AssignNode"
      pattern: "switch.*assignment.type"
---

<objective>
Extend the IR, transformer, and emitter to support the new `<Assign from={source}>` pattern while maintaining backward compatibility with old props.

Purpose: Enable the unified source-based assignment pattern in the compile pipeline.
Output: Working end-to-end support for `<Assign from={file(...)} />` and other sources.
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-data-abstraction/38-CONTEXT.md
@.planning/phases/38-data-abstraction/38-RESEARCH.md
@src/ir/nodes.ts
@src/primitives/variables.ts
@src/parser/transformers/variables.ts
@src/emitter/emitter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AssignNode IR with new source types</name>
  <files>src/ir/nodes.ts</files>
  <action>
Extend the `AssignNode.assignment` discriminated union to support all source types:

```typescript
export interface AssignNode {
  kind: 'assign';
  variableName: string;
  assignment:
    | { type: 'bash'; content: string; }
    | { type: 'value'; content: string; raw?: boolean; }
    | { type: 'env'; content: string; }
    | { type: 'file'; path: string; optional?: boolean; }
    | { type: 'runtimeFn'; fnName: string; args: Record<string, unknown>; };
  comment?: string;
  blankBefore?: boolean;
}
```

Add the `raw` property to 'value' type and new 'file' and 'runtimeFn' types.

Note: 'env' type already exists, keep it for backward compatibility.
  </action>
  <verify>`npm run build` compiles with extended types</verify>
  <done>AssignNode has all 5 assignment types including 'file' and 'runtimeFn'</done>
</task>

<task type="auto">
  <name>Task 2: Update transformer to handle from prop</name>
  <files>src/parser/transformers/variables.ts</files>
  <action>
Refactor `transformAssign` to support both patterns:

1. **Add from prop detection** at the start of transformAssign:
```typescript
const fromProp = openingElement.getAttribute('from');
if (fromProp) {
  return transformAssignWithFrom(node, ctx, variable);
}
// Fall through to existing legacy prop handling
```

2. **Create new function** `transformAssignWithFrom`:
- Extract the from prop value (JSX expression containing source helper call)
- Detect source type by looking for call expression to file/bash/value/env
- For `file(path)`: extract path string, check for optional option
- For `bash(cmd)`: extract command string
- For `value(val)`: extract value string, check for raw option
- For `env(varName)`: extract env var name
- Handle template literals using existing `extractTemplateContent()`
- Build AssignNode with appropriate assignment type

3. **Handle runtimeFn sources**:
- Check if from value is an identifier referencing a RuntimeFn wrapper
- Look up in ctx.runtimeFunctions map
- Extract args prop if present
- Build AssignNode with type: 'runtimeFn'

4. **Keep existing prop handling** (bash=, value=, env=) for backward compatibility during migration.

Reference extractTemplateContent from shared.ts for template string handling.
  </action>
  <verify>`npm run build` succeeds</verify>
  <done>transformAssign handles both from prop and legacy props</done>
</task>

<task type="auto">
  <name>Task 3: Update emitter for new assignment types</name>
  <files>src/emitter/emitter.ts</files>
  <action>
Update `emitAssignmentLine` to handle all assignment types:

```typescript
private emitAssignmentLine(node: AssignNode): string {
  const { variableName, assignment, comment } = node;

  let line: string;
  switch (assignment.type) {
    case 'bash':
      line = `${variableName}=$(${assignment.content})`;
      break;
    case 'value': {
      const val = assignment.content;
      // raw option: emit unquoted
      if (assignment.raw) {
        line = `${variableName}=${val}`;
      } else {
        // Quote by default (safe for spaces)
        line = `${variableName}="${val}"`;
      }
      break;
    }
    case 'env':
      line = `${variableName}=$${assignment.content}`;
      break;
    case 'file': {
      // Use smartQuotePath for proper quoting
      const quotedPath = this.smartQuotePath(assignment.path);
      if (assignment.optional) {
        line = `${variableName}=$(cat ${quotedPath} 2>/dev/null)`;
      } else {
        line = `${variableName}=$(cat ${quotedPath})`;
      }
      break;
    }
    case 'runtimeFn':
      const argsJson = JSON.stringify(assignment.args);
      line = `${variableName}=$(node runtime.js ${assignment.fnName} '${argsJson}')`;
      break;
  }

  if (comment) {
    return `# ${comment}\n${line}`;
  }
  return line;
}
```

Note: The 'file' case uses existing `smartQuotePath()` method for proper path quoting.
  </action>
  <verify>`npm run build` succeeds</verify>
  <done>Emitter handles all 5 assignment types with correct bash output</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Existing assign tests still pass: `npm test tests/grammar/VariableComponents/assign.test.ts`
3. Existing assign-group tests pass: `npm test tests/grammar/VariableComponents/assign-group.test.ts`
</verification>

<success_criteria>
- [ ] AssignNode IR extended with 'file' and 'runtimeFn' types, 'value' has raw property
- [ ] Transformer handles from prop with all source types
- [ ] Emitter produces correct bash for all source types
- [ ] Existing tests with old syntax continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/38-data-abstraction/38-02-SUMMARY.md`
</output>
