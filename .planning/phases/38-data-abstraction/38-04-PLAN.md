---
phase: 38-data-abstraction
plan: 04
type: execute
wave: 3
depends_on: ["38-03"]
files_modified:
  - src/primitives/variables.ts
  - src/primitives/files.ts
  - src/parser/transformers/variables.ts
  - src/parser/transformers/dispatch.ts
  - src/parser/transformers/runtime-dispatch.ts
  - src/ir/nodes.ts
  - src/emitter/emitter.ts
  - tests/grammar/VariableComponents/assign.test.ts
  - tests/grammar/VariableComponents/assign-group.test.ts
autonomous: true

must_haves:
  truths:
    - "AssignProps only accepts var, from, args, and comment props"
    - "Old bash=/value=/env= props are removed from AssignProps"
    - "ReadFile component is removed entirely"
    - "All tests use new from={source} syntax"
    - "No references to ReadFile in codebase"
  artifacts:
    - path: "src/primitives/variables.ts"
      provides: "Clean AssignProps with only from prop"
      contains: "from:"
    - path: "tests/grammar/VariableComponents/assign.test.ts"
      provides: "Tests migrated to from syntax"
      contains: "from={bash("
  key_links:
    - from: "src/primitives/variables.ts"
      to: "src/primitives/sources.ts"
      via: "type import"
      pattern: "import.*AssignSource"
---

<objective>
Remove legacy syntax and ReadFile component per CONTEXT.md decision: "Removal strategy (no deprecation)".

Purpose: Clean break to simplified API with only `from={source}` syntax.
Output: Codebase uses exclusively the new unified pattern.
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-data-abstraction/38-CONTEXT.md
@.planning/phases/38-data-abstraction/38-03-SUMMARY.md
@src/primitives/variables.ts
@src/primitives/files.ts
@tests/grammar/VariableComponents/assign.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove legacy Assign props</name>
  <files>src/primitives/variables.ts, src/parser/transformers/variables.ts</files>
  <action>
1. **Update AssignProps** in src/primitives/variables.ts:
```typescript
import type { AssignSource } from './sources.js';
import type { RuntimeFnComponent } from '../components/runtime-fn.js';

export interface AssignProps {
  /** Variable reference from useVariable */
  var: VariableRef;
  /** Data source - file, bash, value, env, or runtimeFn */
  from: AssignSource | RuntimeFnComponent<any, any>;
  /** For runtimeFn sources: arguments to pass */
  args?: Record<string, unknown>;
  /** Optional comment to emit above the assignment */
  comment?: string;
}
```

Remove: bash, value, env props.

2. **Update transformer** in src/parser/transformers/variables.ts:
- Remove extractAssignPropValue calls for bash, value, env
- Remove the legacy prop handling code path
- Keep only the from prop handling (transformAssignWithFrom)
- Update error messages to reference only from prop

3. **Update JSDoc** on Assign component to show new usage pattern.
  </action>
  <verify>`npm run build` succeeds</verify>
  <done>AssignProps only has var, from, args, comment props</done>
</task>

<task type="auto">
  <name>Task 2: Remove ReadFile component</name>
  <files>src/primitives/files.ts, src/ir/nodes.ts, src/emitter/emitter.ts, src/parser/transformers/dispatch.ts, src/parser/transformers/runtime-dispatch.ts, src/jsx.ts, src/index.ts</files>
  <action>
Remove ReadFile completely per CONTEXT.md:

1. **src/primitives/files.ts** - Keep only ReadFiles (schema-based), remove ReadFile (single file).

2. **src/ir/nodes.ts**:
- Remove ReadFileNode interface
- Remove 'readFile' from BaseBlockNode union
- Keep ReadFilesNode (batch file reading with schema)

3. **src/emitter/emitter.ts**:
- Remove emitReadFile method
- Remove 'readFile' case from emitBlock switch

4. **src/parser/transformers/dispatch.ts** (V1):
- Remove 'ReadFile' case from dispatch switch

5. **src/parser/transformers/runtime-dispatch.ts** (V3):
- Remove 'ReadFile' case if present

6. **src/jsx.ts and src/index.ts**:
- Remove ReadFile from exports
- Keep ReadFiles export

7. Grep for any remaining ReadFile references:
```bash
rg 'ReadFile[^s]' --type ts
```
Fix any remaining references.
  </action>
  <verify>`npm run build` succeeds, no ReadFile references remain</verify>
  <done>ReadFile component completely removed from codebase</done>
</task>

<task type="auto">
  <name>Task 3: Migrate existing tests to new syntax</name>
  <files>tests/grammar/VariableComponents/assign.test.ts, tests/grammar/VariableComponents/assign-group.test.ts</files>
  <action>
Migrate all existing tests from legacy syntax to new from={} syntax:

1. **assign.test.ts** - Update all tests:
```typescript
// OLD:
<Assign var={TIMESTAMP} bash={\`date +%s\`} />

// NEW:
import { bash } from 'react-agentic';
<Assign var={TIMESTAMP} from={bash(\`date +%s\`)} />
```

Convert:
- `bash="..."` → `from={bash("...")}`
- `value="..."` → `from={value("...")}`
- `env="..."` → `from={env("...")}`

2. **assign-group.test.ts** - Same migration for grouped assignments.

3. **Remove error case tests** that test for old syntax errors (e.g., "throws when no assignment prop provided" - now it should throw when no from prop).

4. **Add import** for source helpers at top of test files:
```typescript
// Note: Import helpers for test strings (they're used in TSX source)
// The actual imports happen in the TSX strings being tested
```

5. **Update error case tests** to check for new error messages about from prop.
  </action>
  <verify>`npm test tests/grammar/VariableComponents/` passes all tests</verify>
  <done>All tests migrated to new syntax, old error tests updated</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npm test` passes all tests
3. `rg 'bash="|value="|env="' --type ts` returns no results in src/
4. `rg 'ReadFile[^s]' --type ts` returns no results
5. All assign tests use from={} syntax
</verification>

<success_criteria>
- [ ] AssignProps cleaned to only var, from, args, comment
- [ ] Legacy bash=/value=/env= props removed from transformer
- [ ] ReadFile component and IR node removed
- [ ] All tests migrated to new syntax
- [ ] Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/38-data-abstraction/38-04-SUMMARY.md`
</output>
