---
phase: 04-cli-interface
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/cli/commands/build.ts
  - src/cli/output.ts
  - src/cli/index.ts
autonomous: true

must_haves:
  truths:
    - "User can run `react-agentic build src/**/*.tsx` to process multiple files"
    - "Output files are placed in `.claude/commands/` following Claude Code convention"
    - "Terminal output has visual hierarchy with colors"
    - "Colors are disabled when NO_COLOR env var is set"
  artifacts:
    - path: "src/cli/commands/build.ts"
      provides: "Build command with glob processing"
      min_lines: 50
      exports: ["buildCommand"]
    - path: "src/cli/output.ts"
      provides: "Colored terminal output utilities"
      min_lines: 15
      exports: ["logSuccess", "logError", "logSummary", "logInfo"]
  key_links:
    - from: "src/cli/commands/build.ts"
      to: "src/index.ts"
      via: "imports transpilation pipeline"
      pattern: "import.*from.*\\.\\./\\.\\./(index|parser|emitter)"
    - from: "src/cli/commands/build.ts"
      to: "globby"
      via: "glob pattern expansion"
      pattern: "globby\\("
    - from: "src/cli/index.ts"
      to: "src/cli/commands/build.ts"
      via: "addCommand"
      pattern: "program\\.addCommand\\(buildCommand\\)"
---

<objective>
Implement the build command that processes TSX files via glob patterns and outputs Markdown to `.claude/commands/`.

Purpose: This is the core CLI functionality - users run `react-agentic build src/**/*.tsx` to transpile their command files.
Output: Working build command with colored terminal output and proper file handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-cli-interface/04-RESEARCH.md
@.planning/phases/04-cli-interface/04-01-SUMMARY.md

Existing pipeline (from src/index.ts exports):
- createProject(): creates ts-morph Project
- parseFile(project, filePath): adds source file to project
- findRootJsxElement(sourceFile): finds JSX in return statement
- transform(root): converts JSX to DocumentNode IR
- emit(doc): converts DocumentNode to Markdown string

Key patterns from research:
- globby with gitignore: true
- picocolors auto-detects NO_COLOR
- mkdir recursive before writing
- Exit code 1 on any errors
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create output utilities</name>
  <files>src/cli/output.ts</files>
  <action>
Create `src/cli/output.ts` with colored terminal output utilities:

```typescript
/**
 * CLI Output Utilities - Colored terminal output with NO_COLOR support
 */
import pc from 'picocolors';

/**
 * Log successful file processing
 */
export function logSuccess(inputFile: string, outputFile: string): void {
  console.log(`${pc.green('✓')} ${pc.dim(inputFile)} → ${pc.cyan(outputFile)}`);
}

/**
 * Log file processing error
 */
export function logError(inputFile: string, message: string): void {
  console.error(`${pc.red('✗')} ${pc.dim(inputFile)}: ${message}`);
}

/**
 * Log informational message
 */
export function logInfo(message: string): void {
  console.log(pc.dim(message));
}

/**
 * Log build summary
 */
export function logSummary(successCount: number, errorCount: number): void {
  console.log('');
  if (errorCount === 0) {
    console.log(pc.green(`Built ${successCount} file(s) successfully`));
  } else {
    console.log(
      pc.yellow(`Built ${successCount} file(s) with ${pc.red(String(errorCount))} error(s)`)
    );
  }
}

/**
 * Log warning message
 */
export function logWarning(message: string): void {
  console.log(pc.yellow(message));
}
```

picocolors automatically respects:
- NO_COLOR environment variable
- FORCE_COLOR environment variable
- TTY detection (disables colors when piped)
  </action>
  <verify>
- File exists at src/cli/output.ts
- Exports logSuccess, logError, logInfo, logSummary, logWarning
- Uses picocolors (pc)
  </verify>
  <done>Output utilities created with colored logging functions</done>
</task>

<task type="auto">
  <name>Task 2: Create build command</name>
  <files>src/cli/commands/build.ts</files>
  <action>
Create `src/cli/commands/build.ts` with the build command implementation:

```typescript
/**
 * Build Command - Transpile TSX command files to Markdown
 */
import { Command } from 'commander';
import { globby } from 'globby';
import { writeFile, mkdir } from 'fs/promises';
import path from 'path';
import { createProject, findRootJsxElement, transform, emit } from '../../index.js';
import { logSuccess, logError, logInfo, logSummary, logWarning } from '../output.js';

interface BuildOptions {
  out: string;
}

export const buildCommand = new Command('build')
  .description('Transpile TSX command files to Markdown')
  .argument('<patterns...>', 'Glob patterns for TSX files (e.g., src/**/*.tsx)')
  .option('-o, --out <dir>', 'Output directory', '.claude/commands')
  .action(async (patterns: string[], options: BuildOptions) => {
    // Expand glob patterns
    const files = await globby(patterns, {
      onlyFiles: true,
      gitignore: true,
    });

    // Filter to .tsx files only
    const tsxFiles = files.filter((f) => f.endsWith('.tsx'));

    if (tsxFiles.length === 0) {
      logWarning('No .tsx files found matching patterns');
      process.exit(0);
    }

    logInfo(`Found ${tsxFiles.length} file(s) to process\n`);

    // Ensure output directory exists
    await mkdir(options.out, { recursive: true });

    // Create ts-morph project once
    const project = createProject();

    let successCount = 0;
    let errorCount = 0;

    for (const inputFile of tsxFiles) {
      try {
        // Parse file
        const sourceFile = project.addSourceFileAtPath(inputFile);

        // Find root JSX
        const root = findRootJsxElement(sourceFile);
        if (!root) {
          throw new Error('No JSX element found in file');
        }

        // Transform to IR
        const doc = transform(root);

        // Emit to Markdown
        const markdown = emit(doc);

        // Determine output path
        const basename = path.basename(inputFile, '.tsx');
        const outputPath = path.join(options.out, `${basename}.md`);

        // Write output
        await writeFile(outputPath, markdown, 'utf-8');

        logSuccess(inputFile, outputPath);
        successCount++;
      } catch (error) {
        errorCount++;
        const message = error instanceof Error ? error.message : String(error);
        logError(inputFile, message);
      }
    }

    // Summary
    logSummary(successCount, errorCount);

    // Exit with error code if any failures
    if (errorCount > 0) {
      process.exit(1);
    }
  });
```

Implementation notes:
- Variadic argument `<patterns...>` accepts multiple glob patterns
- Default output to `.claude/commands/` per CLI-02
- gitignore: true respects .gitignore files
- Single ts-morph project for efficiency
- Exit code 1 on any errors (for CI compatibility)
  </action>
  <verify>
- File exists at src/cli/commands/build.ts
- Exports buildCommand
- Uses globby for pattern expansion
- Creates output directory with mkdir recursive
- Calls createProject, findRootJsxElement, transform, emit
  </verify>
  <done>Build command implemented with glob processing and output path resolution</done>
</task>

<task type="auto">
  <name>Task 3: Wire build command to CLI</name>
  <files>src/cli/index.ts</files>
  <action>
Update `src/cli/index.ts` to add the build command:

```typescript
#!/usr/bin/env node
import { Command } from 'commander';
import { readFile } from 'fs/promises';
import { fileURLToPath } from 'url';
import path from 'path';
import { buildCommand } from './commands/build.js';

async function main() {
  // Read version from package.json (stays in sync)
  const __dirname = path.dirname(fileURLToPath(import.meta.url));
  const pkgPath = path.resolve(__dirname, '../../package.json');
  const pkg = JSON.parse(await readFile(pkgPath, 'utf-8'));

  const program = new Command();

  program
    .name('react-agentic')
    .description('Compile-time safety for Claude Code commands')
    .version(pkg.version);

  program.addCommand(buildCommand);

  program.parse();
}

main().catch((err) => {
  console.error(err.message);
  process.exit(1);
});
```

Changes from 04-01:
- Import buildCommand from './commands/build.js'
- Add program.addCommand(buildCommand)
  </action>
  <verify>
- src/cli/index.ts imports buildCommand
- program.addCommand(buildCommand) is called
- `npm run build` succeeds
  </verify>
  <done>Build command wired to CLI entry point</done>
</task>

</tasks>

<verification>
After all tasks:

1. Build the project:
   ```bash
   npm run build
   ```

2. Test help with build command:
   ```bash
   node dist/cli/index.js --help
   ```
   Should show build command in help output.

3. Test build command help:
   ```bash
   node dist/cli/index.js build --help
   ```
   Should show:
   ```
   Usage: react-agentic build [options] <patterns...>

   Transpile TSX command files to Markdown

   Arguments:
     patterns           Glob patterns for TSX files (e.g., src/**/*.tsx)

   Options:
     -o, --out <dir>    Output directory (default: ".claude/commands")
     -h, --help         display help for command
   ```

4. Create a test TSX file and run build:
   ```bash
   mkdir -p test-input
   cat > test-input/test-command.tsx << 'EOF'
   export default function TestCommand() {
     return (
       <Command name="test" description="A test command">
         <h1>Test Command</h1>
         <p>This is a test.</p>
       </Command>
     );
   }
   EOF
   node dist/cli/index.js build 'test-input/**/*.tsx'
   cat .claude/commands/test-command.md
   rm -rf test-input .claude/commands/test-command.md
   ```

5. Test NO_COLOR support:
   ```bash
   NO_COLOR=1 node dist/cli/index.js build --help
   ```
   Output should have no ANSI color codes.
</verification>

<success_criteria>
- `react-agentic build src/**/*.tsx` processes all matching TSX files
- Output files appear in `.claude/commands/` with .md extension
- Terminal shows colored output: green checkmarks for success, red X for errors
- `NO_COLOR=1` disables colors in output
- Exit code 1 when any file fails to transpile
- Missing files or no matches shows warning and exits cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-cli-interface/04-02-SUMMARY.md`
</output>
