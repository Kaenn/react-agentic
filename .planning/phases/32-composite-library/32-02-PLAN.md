---
phase: 32-composite-library
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - src/composites/IfElseBlock.tsx
  - src/composites/LoopWithBreak.tsx
  - src/composites/index.ts
  - tests/composites/control-flow.test.ts
autonomous: true

must_haves:
  truths:
    - "IfElseBlock wraps If and Else primitives with unified API"
    - "LoopWithBreak wraps Loop with break condition pattern"
    - "Composites importable from react-agentic/composites"
    - "JSDoc examples are runnable TSX"
  artifacts:
    - path: "src/composites/IfElseBlock.tsx"
      provides: "IfElseBlock composite component"
      exports: ["IfElseBlock", "IfElseBlockProps"]
      min_lines: 40
    - path: "src/composites/LoopWithBreak.tsx"
      provides: "LoopWithBreak composite component"
      exports: ["LoopWithBreak", "LoopWithBreakProps"]
      min_lines: 50
    - path: "tests/composites/control-flow.test.ts"
      provides: "Tests for control flow composites"
      min_lines: 50
  key_links:
    - from: "src/composites/IfElseBlock.tsx"
      to: "src/components/control.ts"
      via: "imports If, Else primitives"
      pattern: "import.*If.*Else.*from"
    - from: "src/composites/LoopWithBreak.tsx"
      to: "src/components/control.ts"
      via: "imports Loop, Break primitives"
      pattern: "import.*Loop.*Break.*from"
---

<objective>
Create control flow composite components: IfElseBlock and LoopWithBreak

Purpose: Provide enhanced wrappers around If/Else and Loop/Break primitives with unified APIs that are easier to use for common patterns. Users can copy and modify these as reference implementations.

Output: Two composite components with rich JSDoc, exported from composites barrel, with test coverage.
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-composite-library/32-CONTEXT.md
@.planning/phases/32-composite-library/32-RESEARCH.md
@.planning/phases/32-composite-library/32-01-SUMMARY.md
@src/components/control.ts
@src/ir/content-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IfElseBlock composite</name>
  <files>src/composites/IfElseBlock.tsx</files>
  <action>
Create IfElseBlock composite that wraps If and Else primitives.

**Value-add over raw primitives:**
- Unified component API instead of separate sibling components
- Explicit `then` and `otherwise` props instead of implicit sibling relationship
- Clearer intent for conditional rendering

**Implementation:**
```tsx
import type { ReactNode } from 'react';
import { If, Else, type Condition } from '../components/control.js';

/**
 * Enhanced if/else block with unified condition and branches
 *
 * Wraps If and Else primitives with a single component API for common
 * conditional rendering patterns.
 *
 * @param props - Component props
 * @param props.condition - RuntimeVar condition to evaluate (truthy check)
 * @param props.then - Content when condition is truthy
 * @param props.otherwise - Content when condition is falsy (optional)
 *
 * @example Basic conditional
 * ```tsx
 * import { IfElseBlock } from 'react-agentic/composites';
 * import { useRuntimeVar } from 'react-agentic';
 *
 * const ctx = useRuntimeVar<{ error?: string }>('CTX');
 *
 * <IfElseBlock
 *   condition={ctx.error}
 *   then={<p>Error: {ctx.error}</p>}
 *   otherwise={<p>Success!</p>}
 * />
 * ```
 *
 * @example Without else branch
 * ```tsx
 * <IfElseBlock
 *   condition={ctx.verbose}
 *   then={<p>Debug info: {ctx.debugData}</p>}
 * />
 * ```
 *
 * @see {@link If} for the underlying conditional primitive
 * @see {@link Else} for the underlying else primitive
 */
export interface IfElseBlockProps {
  /** RuntimeVar condition to evaluate (truthy = render then, falsy = render otherwise) */
  condition: Condition;
  /** Content when condition is truthy */
  then: ReactNode;
  /** Content when condition is falsy (optional) */
  otherwise?: ReactNode;
}

export const IfElseBlock = ({ condition, then: thenContent, otherwise }: IfElseBlockProps): ReactNode => {
  return (
    <>
      <If condition={condition}>{thenContent}</If>
      {otherwise && <Else>{otherwise}</Else>}
    </>
  );
};
```

Note: Use `then: thenContent` to rename prop since `then` is a reserved word in some contexts.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/composites/IfElseBlock.tsx`
File has JSDoc: `grep -c "@example" src/composites/IfElseBlock.tsx` shows 2+
Exports IfElseBlockProps: `grep "export interface IfElseBlockProps" src/composites/IfElseBlock.tsx`
  </verify>
  <done>IfElseBlock.tsx exists with If/Else wrapper, rich JSDoc, and exported props interface</done>
</task>

<task type="auto">
  <name>Task 2: Create LoopWithBreak composite</name>
  <files>src/composites/LoopWithBreak.tsx</files>
  <action>
Create LoopWithBreak composite that wraps Loop and Break with condition-based early exit.

**Value-add over raw primitives:**
- Built-in break condition pattern (common use case)
- Message support for break reason
- Clearer API for "loop until condition" pattern

**Implementation:**
```tsx
import type { ReactNode } from 'react';
import { Loop, Break, If, type Condition, type OrRuntimeVar } from '../components/control.js';
import type { RuntimeVarProxy } from '../components/runtime-var.js';

/**
 * Enhanced loop with built-in break condition support
 *
 * Wraps Loop with a common pattern: iterate until a condition is met,
 * then break with an optional message.
 *
 * @param props - Component props
 * @param props.max - Maximum iterations (required, prevents infinite loops)
 * @param props.counter - Optional counter variable (0-indexed)
 * @param props.breakWhen - Condition that triggers break (checked after body)
 * @param props.breakMessage - Message to display when breaking (optional)
 * @param props.children - Loop body content
 *
 * @example Retry loop with break condition
 * ```tsx
 * import { LoopWithBreak } from 'react-agentic/composites';
 * import { useRuntimeVar, runtimeFn } from 'react-agentic';
 *
 * const result = useRuntimeVar<{ done: boolean; data?: string }>('RESULT');
 * const FetchData = runtimeFn(fetchDataFn);
 *
 * <LoopWithBreak
 *   max={5}
 *   breakWhen={result.done}
 *   breakMessage="Data fetched successfully"
 * >
 *   <FetchData.Call args={{}} output={result} />
 *   <p>Attempt completed, checking result...</p>
 * </LoopWithBreak>
 * ```
 *
 * @example With counter
 * ```tsx
 * const i = useRuntimeVar<number>('I');
 *
 * <LoopWithBreak
 *   max={10}
 *   counter={i}
 *   breakWhen={result.found}
 * >
 *   <p>Iteration {i}, searching...</p>
 * </LoopWithBreak>
 * ```
 *
 * @see {@link Loop} for the underlying iteration primitive
 * @see {@link Break} for the underlying break primitive
 */
export interface LoopWithBreakProps {
  /** Maximum iterations (required for bounded loops) */
  max: OrRuntimeVar<number>;
  /** Optional counter variable (0-indexed) */
  counter?: RuntimeVarProxy<number>;
  /** Condition that triggers break (checked after body execution) */
  breakWhen?: Condition;
  /** Message to display when breaking (optional) */
  breakMessage?: OrRuntimeVar<string>;
  /** Loop body content */
  children?: ReactNode;
}

export const LoopWithBreak = ({
  max,
  counter,
  breakWhen,
  breakMessage,
  children
}: LoopWithBreakProps): ReactNode => {
  return (
    <Loop max={max} counter={counter}>
      {children}
      {breakWhen && (
        <If condition={breakWhen}>
          <Break message={breakMessage} />
        </If>
      )}
    </Loop>
  );
};
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/composites/LoopWithBreak.tsx`
File has JSDoc: `grep -c "@example" src/composites/LoopWithBreak.tsx` shows 2+
Exports LoopWithBreakProps: `grep "export interface LoopWithBreakProps" src/composites/LoopWithBreak.tsx`
  </verify>
  <done>LoopWithBreak.tsx exists with Loop/Break wrapper, rich JSDoc, and exported props interface</done>
</task>

<task type="auto">
  <name>Task 3: Update barrel export and add tests</name>
  <files>src/composites/index.ts, tests/composites/control-flow.test.ts</files>
  <action>
Update the composites barrel export and create test file.

**Update src/composites/index.ts:**
```typescript
/**
 * react-agentic/composites - User-definable convenience wrappers
 *
 * Composites wrap primitives to provide enhanced variants with common patterns.
 * Users can import these for "batteries included" behavior, or copy/modify
 * the source code to create custom variants.
 *
 * Import: import { IfElseBlock, LoopWithBreak } from 'react-agentic/composites'
 */

// Control flow composites
export { IfElseBlock, type IfElseBlockProps } from './IfElseBlock.js';
export { LoopWithBreak, type LoopWithBreakProps } from './LoopWithBreak.js';
```

**Create tests/composites/control-flow.test.ts:**
Test that composites:
1. Export expected interfaces
2. Have correct type signatures
3. Transform correctly to markdown (use snapshot tests similar to Phase 27)

Test structure:
```typescript
import { describe, it, expect } from 'vitest';
import { IfElseBlock, LoopWithBreak, type IfElseBlockProps, type LoopWithBreakProps } from '../../src/composites/index.js';

describe('Control Flow Composites', () => {
  describe('IfElseBlock', () => {
    it('should be exported from composites', () => {
      expect(IfElseBlock).toBeDefined();
    });

    it('should have correct props interface exported', () => {
      // Type-level test - if this compiles, interface is correctly exported
      const props: IfElseBlockProps = {
        condition: true,
        then: null,
      };
      expect(props).toBeDefined();
    });
  });

  describe('LoopWithBreak', () => {
    it('should be exported from composites', () => {
      expect(LoopWithBreak).toBeDefined();
    });

    it('should have correct props interface exported', () => {
      const props: LoopWithBreakProps = {
        max: 5,
      };
      expect(props).toBeDefined();
    });
  });
});
```
  </action>
  <verify>
Barrel exports correctly: `grep "export.*IfElseBlock" src/composites/index.ts`
Tests pass: `npm run test:run -- tests/composites/control-flow.test.ts`
All tests pass: `npm run test:run`
  </verify>
  <done>Composites exported from barrel, tests verify export and type correctness</done>
</task>

</tasks>

<verification>
1. IfElseBlock.tsx: Has condition/then/otherwise props, wraps If+Else, has @example JSDoc
2. LoopWithBreak.tsx: Has max/counter/breakWhen/breakMessage props, wraps Loop+If+Break, has @example JSDoc
3. index.ts: Exports both composites and their props interfaces
4. Tests: All composites exported, types work correctly
5. Build: `npm run build` succeeds
6. Full suite: `npm run test:run` passes (all 849+ tests)
</verification>

<success_criteria>
- [ ] IfElseBlock wraps If/Else with unified condition/then/otherwise API
- [ ] LoopWithBreak wraps Loop with breakWhen condition support
- [ ] Both composites have @example JSDoc blocks (2+ each)
- [ ] Props interfaces exported (IfElseBlockProps, LoopWithBreakProps)
- [ ] Composites importable from src/composites/index.ts
- [ ] Tests pass for composite exports and types
- [ ] All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/32-composite-library/32-02-SUMMARY.md`
</output>
