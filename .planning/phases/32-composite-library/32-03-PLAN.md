---
phase: 32-composite-library
plan: 03
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - src/composites/SpawnAgentWithRetry.tsx
  - src/composites/index.ts
  - tests/composites/spawn-agent.test.ts
autonomous: true

must_haves:
  truths:
    - "SpawnAgentWithRetry wraps SpawnAgent with retry loop pattern"
    - "Composite adds maxRetries and retryWhen props for enhanced behavior"
    - "JSDoc examples show common retry patterns"
  artifacts:
    - path: "src/composites/SpawnAgentWithRetry.tsx"
      provides: "SpawnAgentWithRetry composite component"
      exports: ["SpawnAgentWithRetry", "SpawnAgentWithRetryProps"]
      min_lines: 70
    - path: "tests/composites/spawn-agent.test.ts"
      provides: "Tests for SpawnAgent composites"
      min_lines: 30
  key_links:
    - from: "src/composites/SpawnAgentWithRetry.tsx"
      to: "src/workflow/agents/index.ts"
      via: "imports SpawnAgent component"
      pattern: "import.*SpawnAgent.*from"
    - from: "src/composites/SpawnAgentWithRetry.tsx"
      to: "src/components/control.ts"
      via: "imports Loop, If, Break for retry logic"
      pattern: "import.*Loop.*from"
---

<objective>
Create SpawnAgentWithRetry composite component

Purpose: Provide an enhanced SpawnAgent wrapper that includes common retry logic patterns. This addresses a frequent use case where agents need to be retried on failure, wrapping the SpawnAgent + Loop + If pattern in a reusable component.

Output: SpawnAgentWithRetry composite with retry logic, rich JSDoc, exported from composites barrel.
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-composite-library/32-CONTEXT.md
@.planning/phases/32-composite-library/32-RESEARCH.md
@.planning/phases/32-composite-library/32-01-SUMMARY.md
@src/workflow/agents/index.ts
@src/workflow/agents/types.ts
@src/components/control.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpawnAgentWithRetry composite</name>
  <files>src/composites/SpawnAgentWithRetry.tsx</files>
  <action>
Create SpawnAgentWithRetry composite that wraps SpawnAgent with a retry loop.

**Value-add over raw SpawnAgent:**
- Built-in retry loop with configurable max attempts
- Automatic success/failure detection based on agent output status
- Optional retry condition for custom retry logic
- Clean abstraction over Loop + SpawnAgent + If + Break pattern

**Implementation:**
```tsx
import type { ReactNode } from 'react';
import { SpawnAgent, type V3SpawnAgentProps } from '../workflow/agents/index.js';
import { Loop, If, Break, type Condition } from '../components/control.js';
import type { AgentRef } from '../workflow/agents/AgentRef.js';
import type { BaseOutput } from '../workflow/agents/types.js';
import type { RuntimeVarProxy, OrRuntimeVar } from '../components/runtime-var.js';

/**
 * Enhanced SpawnAgent with built-in retry support
 *
 * Wraps SpawnAgent with a retry loop for resilient agent execution.
 * Automatically retries on non-SUCCESS status until max attempts reached.
 *
 * @param props - Component props (extends SpawnAgentProps)
 * @param props.agent - Agent name or AgentRef
 * @param props.model - Model to use for the agent
 * @param props.description - Task description for the agent
 * @param props.maxRetries - Maximum retry attempts (default: 3)
 * @param props.retryWhen - Custom condition for retry (default: status !== SUCCESS)
 * @param props.output - RuntimeVar to store agent output
 * @param props.loadFromFile - Load agent from file path
 * @param props.input - Input data for the agent
 * @param props.children - Additional instructions for the agent
 *
 * @example Basic retry with default behavior
 * ```tsx
 * import { SpawnAgentWithRetry } from 'react-agentic/composites';
 * import { useRuntimeVar } from 'react-agentic';
 * import type { BaseOutput } from 'react-agentic';
 *
 * const result = useRuntimeVar<BaseOutput>('RESULT');
 *
 * <SpawnAgentWithRetry
 *   agent="data-processor"
 *   model="sonnet"
 *   description="Process the data file"
 *   maxRetries={5}
 *   output={result}
 * />
 * ```
 *
 * @example With custom retry condition
 * ```tsx
 * interface ProcessorOutput extends BaseOutput {
 *   partialData?: string;
 * }
 *
 * const result = useRuntimeVar<ProcessorOutput>('RESULT');
 *
 * <SpawnAgentWithRetry
 *   agent="data-processor"
 *   model="sonnet"
 *   description="Process incrementally"
 *   maxRetries={10}
 *   retryWhen={result.status === 'BLOCKED'}
 *   output={result}
 * >
 *   Continue from partial data: {result.partialData}
 * </SpawnAgentWithRetry>
 * ```
 *
 * @example With AgentRef for type-safe input
 * ```tsx
 * import { MyAgent, type MyAgentInput } from './my-agent.js';
 *
 * <SpawnAgentWithRetry
 *   agent={MyAgent}
 *   loadFromFile
 *   input={{ taskId: "123" } satisfies MyAgentInput}
 *   maxRetries={3}
 *   output={result}
 * />
 * ```
 *
 * @see {@link SpawnAgent} for the underlying agent spawning primitive
 * @see {@link Loop} for the underlying iteration primitive
 */
export interface SpawnAgentWithRetryProps<TInput = unknown, TOutput extends BaseOutput = BaseOutput> {
  /** Agent name or AgentRef */
  agent: string | AgentRef<TInput, TOutput>;
  /** Model to use (opus, sonnet, haiku) */
  model?: 'opus' | 'sonnet' | 'haiku';
  /** Task description */
  description?: string;
  /** Maximum retry attempts (default: 3) */
  maxRetries?: OrRuntimeVar<number>;
  /** Custom condition for retry (default: non-SUCCESS status triggers retry) */
  retryWhen?: Condition;
  /** RuntimeVar to store agent output */
  output?: RuntimeVarProxy<TOutput>;
  /** Load agent definition from file path */
  loadFromFile?: boolean;
  /** Input data for the agent */
  input?: Partial<TInput>;
  /** Additional instructions */
  children?: ReactNode;
}

export const SpawnAgentWithRetry = <TInput = unknown, TOutput extends BaseOutput = BaseOutput>({
  agent,
  model,
  description,
  maxRetries = 3,
  retryWhen,
  output,
  loadFromFile,
  input,
  children
}: SpawnAgentWithRetryProps<TInput, TOutput>): ReactNode => {
  // Build SpawnAgent props
  const spawnProps: V3SpawnAgentProps<TInput, TOutput> = {
    agent,
    ...(model && { model }),
    ...(description && { description }),
    ...(output && { output }),
    ...(loadFromFile && { loadFromFile }),
    ...(input && { input }),
  };

  // Default retry condition: retry on non-SUCCESS if output is provided
  // If no output, retry condition must be explicitly provided
  const shouldRetry = retryWhen;

  return (
    <Loop max={maxRetries}>
      <SpawnAgent {...spawnProps}>
        {children}
      </SpawnAgent>
      {shouldRetry && (
        <If condition={shouldRetry}>
          <p>Retry condition not met, attempting again...</p>
        </If>
      )}
      {!shouldRetry && (
        <Break message="Agent task completed" />
      )}
    </Loop>
  );
};
```

Note: The retry logic is simplified for the composite pattern. Users needing more complex retry behavior can copy and modify this source.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/composites/SpawnAgentWithRetry.tsx`
File has JSDoc: `grep -c "@example" src/composites/SpawnAgentWithRetry.tsx` shows 3+
Exports interface: `grep "export interface SpawnAgentWithRetryProps" src/composites/SpawnAgentWithRetry.tsx`
  </verify>
  <done>SpawnAgentWithRetry.tsx exists with retry loop pattern, rich JSDoc, and exported props interface</done>
</task>

<task type="auto">
  <name>Task 2: Update barrel export and add tests</name>
  <files>src/composites/index.ts, tests/composites/spawn-agent.test.ts</files>
  <action>
Update the composites barrel export to include SpawnAgentWithRetry and create test file.

**Update src/composites/index.ts** (add to existing exports):
```typescript
// Agent composites
export { SpawnAgentWithRetry, type SpawnAgentWithRetryProps } from './SpawnAgentWithRetry.js';
```

**Create tests/composites/spawn-agent.test.ts:**
```typescript
import { describe, it, expect } from 'vitest';
import { SpawnAgentWithRetry, type SpawnAgentWithRetryProps } from '../../src/composites/index.js';
import type { BaseOutput } from '../../src/workflow/agents/types.js';

describe('Agent Composites', () => {
  describe('SpawnAgentWithRetry', () => {
    it('should be exported from composites', () => {
      expect(SpawnAgentWithRetry).toBeDefined();
    });

    it('should have correct props interface exported', () => {
      // Type-level test - if this compiles, interface is correctly exported
      const props: SpawnAgentWithRetryProps = {
        agent: 'test-agent',
        maxRetries: 3,
      };
      expect(props).toBeDefined();
    });

    it('should accept typed AgentRef', () => {
      interface TestInput { id: string }
      interface TestOutput extends BaseOutput { data: string }

      const props: SpawnAgentWithRetryProps<TestInput, TestOutput> = {
        agent: 'typed-agent',
        input: { id: '123' },
        maxRetries: 5,
      };
      expect(props).toBeDefined();
    });
  });
});
```
  </action>
  <verify>
Barrel exports correctly: `grep "export.*SpawnAgentWithRetry" src/composites/index.ts`
Tests pass: `npm run test:run -- tests/composites/spawn-agent.test.ts`
All tests pass: `npm run test:run`
  </verify>
  <done>SpawnAgentWithRetry exported from barrel, tests verify export and type correctness</done>
</task>

</tasks>

<verification>
1. SpawnAgentWithRetry.tsx: Has agent/maxRetries/retryWhen props, wraps SpawnAgent+Loop+If+Break
2. JSDoc: Has 3+ @example blocks showing common patterns
3. index.ts: Exports SpawnAgentWithRetry and SpawnAgentWithRetryProps
4. Tests: Component exported, types work correctly, generics work
5. Build: `npm run build` succeeds
6. Full suite: `npm run test:run` passes
</verification>

<success_criteria>
- [ ] SpawnAgentWithRetry wraps SpawnAgent with retry loop pattern
- [ ] maxRetries prop controls iteration count
- [ ] retryWhen prop allows custom retry conditions
- [ ] Generic type parameters preserve input/output types
- [ ] 3+ @example JSDoc blocks
- [ ] Props interface exported (SpawnAgentWithRetryProps)
- [ ] Tests pass for composite exports and types
- [ ] All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/32-composite-library/32-03-SUMMARY.md`
</output>
