---
phase: 10-spawnagent-component
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - src/emitter/emitter.ts
  - tests/emitter/spawnagent-emitter.test.ts
autonomous: true

must_haves:
  truths:
    - "SpawnAgentNode emits valid GSD Task() syntax"
    - "Task() prompt value has double quotes escaped"
    - "Task() preserves multi-line prompt content"
    - "Task() preserves {variable} placeholders"
    - "Command with SpawnAgent builds to valid markdown"
  artifacts:
    - path: "src/emitter/emitter.ts"
      provides: "emitSpawnAgent method"
      contains: "emitSpawnAgent"
    - path: "tests/emitter/spawnagent-emitter.test.ts"
      provides: "SpawnAgent emission tests"
      min_lines: 80
  key_links:
    - from: "src/emitter/emitter.ts"
      to: "SpawnAgentNode"
      via: "emitBlock switch case for spawnAgent"
      pattern: "case 'spawnAgent'"
---

<objective>
Task() syntax emitter for SpawnAgent

Purpose: Complete Phase 10 by emitting GSD Task() function-call syntax from SpawnAgentNode. This is the emission half - converting the SpawnAgentNode IR (produced by Plan 01) into the Task() syntax that GSD framework expects.

Output: emitSpawnAgent method, comprehensive emission tests, working end-to-end SpawnAgent transpilation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-spawnagent-component/10-RESEARCH.md

# Plan 01 provides SpawnAgent transformation
@.planning/phases/10-spawnagent-component/10-01-PLAN.md

# Phase 9 established Agent emission pattern
@.planning/phases/09-agent-transpilation/09-02-SUMMARY.md

# Source files
@src/emitter/emitter.ts
@src/ir/nodes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement emitSpawnAgent method</name>
  <files>src/emitter/emitter.ts</files>
  <action>
Implement emitSpawnAgent method in MarkdownEmitter class. Replace the TODO stub with working implementation.

1. Replace the existing spawnAgent case in emitBlock():
```typescript
case 'spawnAgent':
  return this.emitSpawnAgent(node);
```

2. Add emitSpawnAgent private method:
```typescript
/**
 * Emit SpawnAgent as GSD Task() syntax
 *
 * Output format:
 * Task(
 *   prompt="...",
 *   subagent_type="...",
 *   model="...",
 *   description="..."
 * )
 */
private emitSpawnAgent(node: SpawnAgentNode): string {
  // Escape double quotes in string values (backslash escape for Task() syntax)
  const escapeQuotes = (s: string): string => s.replace(/"/g, '\\"');

  // Build Task() with proper formatting
  // Note: prompt can be multi-line, preserve actual newlines
  return `Task(
  prompt="${escapeQuotes(node.prompt)}",
  subagent_type="${escapeQuotes(node.agent)}",
  model="${escapeQuotes(node.model)}",
  description="${escapeQuotes(node.description)}"
)`;
}
```

Key implementation details:
- Quote escaping: `"` becomes `\"` in output
- Multi-line preservation: Real newlines in prompt, not `\n` escape sequences
- Property order: prompt, subagent_type, model, description (matches GSD convention)
- All values in double quotes
- No trailing comma after description
  </action>
  <verify>npm run typecheck passes; emitBlock no longer throws for spawnAgent</verify>
  <done>emitSpawnAgent method produces valid Task() syntax with proper escaping</done>
</task>

<task type="auto">
  <name>Task 2: Add SpawnAgent emission tests</name>
  <files>tests/emitter/spawnagent-emitter.test.ts</files>
  <action>
Create comprehensive tests for SpawnAgent emission following the agent-emitter.test.ts pattern.

```typescript
import { describe, it, expect } from 'vitest';
import { emit } from '../../src/emitter/emitter.js';
import type { DocumentNode, SpawnAgentNode, FrontmatterNode } from '../../src/ir/index.js';

/**
 * Helper to create DocumentNode with SpawnAgent for testing
 */
function createDocWithSpawnAgent(
  spawnAgents: Omit<SpawnAgentNode, 'kind'>[],
  extraChildren: DocumentNode['children'] = []
): DocumentNode {
  const frontmatter: FrontmatterNode = {
    kind: 'frontmatter',
    data: { name: 'test-command', description: 'Test command' }
  };

  const spawnAgentNodes: SpawnAgentNode[] = spawnAgents.map(sa => ({
    kind: 'spawnAgent',
    ...sa
  }));

  return {
    kind: 'document',
    frontmatter,
    children: [...extraChildren, ...spawnAgentNodes]
  };
}

describe('SpawnAgent emission', () => {
  describe('basic emission', () => {
    it('emits Task() syntax with all fields', () => {
      const doc = createDocWithSpawnAgent([{
        agent: 'gsd-researcher',
        model: '{model}',
        description: 'Research task',
        prompt: 'Do research'
      }]);

      const output = emit(doc);

      expect(output).toContain('Task(');
      expect(output).toContain('prompt="Do research"');
      expect(output).toContain('subagent_type="gsd-researcher"');
      expect(output).toContain('model="{model}"');
      expect(output).toContain('description="Research task"');
      expect(output).toContain(')');
    });

    it('emits Task() with proper indentation', () => {
      const doc = createDocWithSpawnAgent([{
        agent: 'test',
        model: 'm',
        description: 'd',
        prompt: 'p'
      }]);

      const output = emit(doc);

      // Verify indentation structure
      expect(output).toContain('Task(\n');
      expect(output).toContain('  prompt=');
      expect(output).toContain('  subagent_type=');
      expect(output).toContain('  model=');
      expect(output).toContain('  description=');
      expect(output).toContain('\n)');
    });
  });

  describe('quote escaping', () => {
    it('escapes double quotes in prompt', () => {
      const doc = createDocWithSpawnAgent([{
        agent: 'test',
        model: 'm',
        description: 'd',
        prompt: 'Say "hello" to the agent'
      }]);

      const output = emit(doc);

      expect(output).toContain('prompt="Say \\"hello\\" to the agent"');
    });

    it('escapes double quotes in description', () => {
      const doc = createDocWithSpawnAgent([{
        agent: 'test',
        model: 'm',
        description: 'Task with "special" name',
        prompt: 'p'
      }]);

      const output = emit(doc);

      expect(output).toContain('description="Task with \\"special\\" name"');
    });

    it('escapes double quotes in agent name', () => {
      const doc = createDocWithSpawnAgent([{
        agent: 'agent-with-"quotes"',
        model: 'm',
        description: 'd',
        prompt: 'p'
      }]);

      const output = emit(doc);

      expect(output).toContain('subagent_type="agent-with-\\"quotes\\""');
    });
  });

  describe('multi-line content', () => {
    it('preserves multi-line prompt content', () => {
      const doc = createDocWithSpawnAgent([{
        agent: 'test',
        model: 'm',
        description: 'd',
        prompt: 'Line 1\nLine 2\nLine 3'
      }]);

      const output = emit(doc);

      // Should have actual newlines, not escaped \n
      expect(output).toContain('prompt="Line 1\nLine 2\nLine 3"');
    });

    it('handles prompt with XML-like structure', () => {
      const doc = createDocWithSpawnAgent([{
        agent: 'test',
        model: 'm',
        description: 'd',
        prompt: '<context>\nPhase: {phase}\n</context>'
      }]);

      const output = emit(doc);

      expect(output).toContain('<context>');
      expect(output).toContain('Phase: {phase}');
      expect(output).toContain('</context>');
    });
  });

  describe('placeholder preservation', () => {
    it('preserves {variable} in model', () => {
      const doc = createDocWithSpawnAgent([{
        agent: 'test',
        model: '{researcher_model}',
        description: 'd',
        prompt: 'p'
      }]);

      const output = emit(doc);

      expect(output).toContain('model="{researcher_model}"');
    });

    it('preserves {variable} in prompt', () => {
      const doc = createDocWithSpawnAgent([{
        agent: 'test',
        model: 'm',
        description: 'd',
        prompt: 'Research phase {phase_number}'
      }]);

      const output = emit(doc);

      expect(output).toContain('prompt="Research phase {phase_number}"');
    });

    it('preserves multiple {variables} in prompt', () => {
      const doc = createDocWithSpawnAgent([{
        agent: 'test',
        model: 'm',
        description: 'd',
        prompt: 'Phase: {phase}, Goal: {goal}'
      }]);

      const output = emit(doc);

      expect(output).toContain('{phase}');
      expect(output).toContain('{goal}');
    });
  });

  describe('multiple SpawnAgent elements', () => {
    it('emits multiple Task() blocks separated by blank lines', () => {
      const doc = createDocWithSpawnAgent([
        { agent: 'agent1', model: 'm1', description: 'd1', prompt: 'p1' },
        { agent: 'agent2', model: 'm2', description: 'd2', prompt: 'p2' }
      ]);

      const output = emit(doc);

      expect(output).toContain('subagent_type="agent1"');
      expect(output).toContain('subagent_type="agent2"');
      // Should have two Task() blocks
      expect((output.match(/Task\(/g) || []).length).toBe(2);
    });
  });

  describe('SpawnAgent with sibling content', () => {
    it('emits SpawnAgent after other block elements', () => {
      const doc = createDocWithSpawnAgent(
        [{ agent: 'researcher', model: 'm', description: 'd', prompt: 'p' }],
        [
          { kind: 'heading', level: 1, children: [{ kind: 'text', value: 'Title' }] },
          { kind: 'paragraph', children: [{ kind: 'text', value: 'Introduction.' }] }
        ]
      );

      const output = emit(doc);

      // Verify order: heading, paragraph, then Task()
      const titleIndex = output.indexOf('# Title');
      const introIndex = output.indexOf('Introduction.');
      const taskIndex = output.indexOf('Task(');

      expect(titleIndex).toBeLessThan(introIndex);
      expect(introIndex).toBeLessThan(taskIndex);
    });
  });

  describe('complete document output', () => {
    it('emits valid Command with SpawnAgent', () => {
      const doc: DocumentNode = {
        kind: 'document',
        frontmatter: {
          kind: 'frontmatter',
          data: {
            name: 'plan-phase',
            description: 'Plan a phase',
            'allowed-tools': ['Read', 'Task']
          }
        },
        children: [
          { kind: 'heading', level: 1, children: [{ kind: 'text', value: 'Phase Planning' }] },
          { kind: 'paragraph', children: [{ kind: 'text', value: 'This command spawns an agent.' }] },
          {
            kind: 'spawnAgent',
            agent: 'gsd-researcher',
            model: '{researcher_model}',
            description: 'Research phase requirements',
            prompt: 'Research the phase.'
          }
        ]
      };

      const output = emit(doc);

      // Verify frontmatter
      expect(output).toContain('---');
      expect(output).toContain('name: plan-phase');
      expect(output).toContain('description: Plan a phase');

      // Verify body
      expect(output).toContain('# Phase Planning');
      expect(output).toContain('This command spawns an agent.');

      // Verify Task()
      expect(output).toContain('Task(');
      expect(output).toContain('subagent_type="gsd-researcher"');
    });

    it('matches expected output format', () => {
      const doc = createDocWithSpawnAgent([{
        agent: 'test-agent',
        model: '{model}',
        description: 'Test description',
        prompt: 'Test prompt'
      }]);

      const output = emit(doc);

      // Verify the Task() block format matches GSD expectations
      expect(output).toMatch(/Task\(\n {2}prompt=".*",\n {2}subagent_type=".*",\n {2}model=".*",\n {2}description=".*"\n\)/);
    });
  });
});
```
  </action>
  <verify>npm test passes; tests cover SPAWN-05 and verify emission format</verify>
  <done>15+ tests covering basic emission, escaping, multi-line, placeholders, multiple SpawnAgents, complete documents</done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification</name>
  <files>None (verification only)</files>
  <action>
Create a temporary test file to verify complete SpawnAgent transpilation pipeline.

1. Create temporary TSX file:
```tsx
// test-spawnagent.tsx
export default function TestCommand() {
  return (
    <Command name="test-spawn" description="Test SpawnAgent">
      <h1>Test Command</h1>
      <p>This command tests SpawnAgent transpilation.</p>
      <SpawnAgent
        agent="gsd-researcher"
        model="{researcher_model}"
        description="Research phase requirements"
        prompt={`<planning_context>
Phase: {phase_number}
Description: {phase_description}
</planning_context>

Research the technical domain for this phase.`}
      />
    </Command>
  );
}
```

2. Run build and verify output:
```bash
npm run build
cat .claude/commands/test-spawn.md
```

3. Verify expected output contains:
- Frontmatter with name, description
- h1 heading "Test Command"
- Paragraph content
- Task() block with:
  - prompt with preserved newlines and {variables}
  - subagent_type="gsd-researcher"
  - model="{researcher_model}"
  - description="Research phase requirements"

4. Clean up test file after verification

Note: This task is verification-only, no permanent files created.
  </action>
  <verify>Test TSX transpiles to expected markdown format; Task() syntax matches GSD expectations</verify>
  <done>Complete pipeline verified: TSX -> IR -> Task() markdown; placeholders preserved; multi-line handled</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run typecheck` passes
2. `npm test` passes (all existing + new emission tests)
3. SpawnAgentNode emits valid Task() syntax
4. Quote escaping works correctly (`"` -> `\"`)
5. Multi-line prompts preserve newlines
6. {variable} placeholders pass through unchanged
7. Complete E2E: TSX with SpawnAgent -> valid markdown
</verification>

<success_criteria>
- emitSpawnAgent method in MarkdownEmitter
- Task() output format matches GSD specification
- Double quotes escaped in all string values
- Multi-line content preserved (not escaped)
- {variable} placeholders unchanged
- Multiple SpawnAgent elements emit correctly
- 15+ emission tests passing
- All tests pass (npm test)
- E2E verification successful
</success_criteria>

<output>
After completion, create `.planning/phases/10-spawnagent-component/10-02-SUMMARY.md`
</output>
