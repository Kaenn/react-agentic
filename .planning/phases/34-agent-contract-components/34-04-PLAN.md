---
phase: 34-agent-contract-components
plan: 04
type: execute
wave: 3
depends_on: ["34-03"]
files_modified:
  - tests/components/contract.test.ts
  - tests/components/__snapshots__/contract.test.ts.snap
autonomous: true

must_haves:
  truths:
    - "Snapshot tests verify contract component markdown output"
    - "Validation error tests confirm compile-time checks work"
    - "Full agent with all contract components renders correctly"
  artifacts:
    - path: "tests/components/contract.test.ts"
      provides: "Contract component test suite"
      contains: "Role, UpstreamInput, StructuredReturns"
    - path: "tests/components/__snapshots__/contract.test.ts.snap"
      provides: "Snapshot expectations"
  key_links:
    - from: "tests/components/contract.test.ts"
      to: "src/components/contract.ts"
      via: "imports and usage"
      pattern: "from.*jsx"
---

# Plan 34-04: Snapshot Tests for Contract Components

<objective>
Add comprehensive snapshot tests for contract components covering rendering, validation, and edge cases.

Purpose: Ensure contract components work correctly and catch regressions. Tests serve as documentation.
Output: test/components/contract.test.ts with snapshot tests.
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-agent-contract-components/34-CONTEXT.md
@.planning/phases/34-agent-contract-components/34-RESEARCH.md

Existing test patterns:
@tests/components/document.test.ts
@tests/components/semantic.test.ts

Prior plan summaries:
@.planning/phases/34-agent-contract-components/34-01-SUMMARY.md
@.planning/phases/34-agent-contract-components/34-02-SUMMARY.md
@.planning/phases/34-agent-contract-components/34-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Contract Component Test File</name>
  <files>tests/components/contract.test.ts</files>
  <action>
Create new file `tests/components/contract.test.ts`:

```typescript
/**
 * Contract Component Tests
 *
 * Tests for agent contract components: Role, UpstreamInput, DownstreamConsumer,
 * Methodology, StructuredReturns, and Return.
 */

import { describe, it, expect } from 'vitest';
import { transpile } from '../../src/index.js';

// ============================================================================
// Test Helper
// ============================================================================

function compile(tsx: string): string {
  const result = transpile(tsx);
  if (result.errors && result.errors.length > 0) {
    throw new Error(result.errors.join('\n'));
  }
  return result.output!;
}

function expectCompileError(tsx: string, expectedMessage: string): void {
  const result = transpile(tsx);
  expect(result.errors).toBeDefined();
  expect(result.errors!.length).toBeGreaterThan(0);
  expect(result.errors!.some(e => e.includes(expectedMessage))).toBe(true);
}

// ============================================================================
// Individual Component Tests
// ============================================================================

describe('Role component', () => {
  it('renders as <role> XML block', () => {
    const tsx = `
      <Agent name="test" description="Test agent">
        <Role>
          You are a test agent. You do testing.
        </Role>
      </Agent>
    `;
    expect(compile(tsx)).toMatchSnapshot();
  });

  it('supports markdown content', () => {
    const tsx = `
      <Agent name="test" description="Test agent">
        <Role>
          You are a **planner**. Your responsibilities:

          - Create plans
          - Track progress
          - Report status
        </Role>
      </Agent>
    `;
    expect(compile(tsx)).toMatchSnapshot();
  });
});

describe('UpstreamInput component', () => {
  it('renders as <upstream_input> XML block', () => {
    const tsx = `
      <Agent name="test" description="Test agent">
        <UpstreamInput>
          The orchestrator provides context via planning_context block.
        </UpstreamInput>
      </Agent>
    `;
    expect(compile(tsx)).toMatchSnapshot();
  });
});

describe('DownstreamConsumer component', () => {
  it('renders as <downstream_consumer> XML block', () => {
    const tsx = `
      <Agent name="test" description="Test agent">
        <DownstreamConsumer>
          Your output is consumed by the executor phase.
        </DownstreamConsumer>
      </Agent>
    `;
    expect(compile(tsx)).toMatchSnapshot();
  });
});

describe('Methodology component', () => {
  it('renders as <methodology> XML block', () => {
    const tsx = `
      <Agent name="test" description="Test agent">
        <Methodology>
          1. Read the input
          2. Process the data
          3. Return structured output
        </Methodology>
      </Agent>
    `;
    expect(compile(tsx)).toMatchSnapshot();
  });
});

describe('StructuredReturns component', () => {
  it('renders with ## headings for each status', () => {
    const tsx = `
      <Agent name="test" description="Test agent">
        <StructuredReturns>
          <Return status="SUCCESS">All tasks completed successfully</Return>
          <Return status="BLOCKED">Cannot proceed due to missing context</Return>
          <Return status="ERROR">An error occurred during execution</Return>
        </StructuredReturns>
      </Agent>
    `;
    expect(compile(tsx)).toMatchSnapshot();
  });

  it('supports rich content in Return descriptions', () => {
    const tsx = `
      <Agent name="test" description="Test agent">
        <StructuredReturns>
          <Return status="SUCCESS">
            All tests passed.

            **Includes:**
            - Unit tests
            - Integration tests
          </Return>
          <Return status="FAILED">Some tests failed. See report.</Return>
        </StructuredReturns>
      </Agent>
    `;
    expect(compile(tsx)).toMatchSnapshot();
  });
});

// ============================================================================
// Full Agent with All Contract Components
// ============================================================================

describe('Full agent with contract components', () => {
  it('renders complete agent contract', () => {
    const tsx = `
      <Agent name="gsd-planner" description="Creates phase plans">
        <Role>
          You are a GSD planner. You create executable phase plans
          with task breakdown and dependency analysis.
        </Role>

        <UpstreamInput>
          The orchestrator passes a planning_context block containing:

          - project_state: STATE.md content
          - roadmap: ROADMAP.md content
          - phase_context: Optional CONTEXT.md
        </UpstreamInput>

        <DownstreamConsumer>
          Your PLAN.md files are consumed by execute-phase which expects:

          - Frontmatter with wave, depends_on
          - Tasks with files, action, verify, done
          - Verification criteria
        </DownstreamConsumer>

        <Methodology>
          1. Read project state and roadmap
          2. Break phase into 2-3 task plans
          3. Build dependency graph
          4. Assign execution waves
          5. Write PLAN.md files
        </Methodology>

        <StructuredReturns>
          <Return status="PLANNING_COMPLETE">Plans created, ready for execution</Return>
          <Return status="CHECKPOINT_REACHED">Need user input to continue</Return>
          <Return status="PLANNING_BLOCKED">Cannot proceed without more context</Return>
        </StructuredReturns>
      </Agent>
    `;
    expect(compile(tsx)).toMatchSnapshot();
  });

  it('allows interleaving with regular content', () => {
    const tsx = `
      <Agent name="test" description="Test agent">
        <Role>You are a test agent.</Role>

        <XmlBlock name="objective">
          Create and execute tests.
        </XmlBlock>

        <Methodology>Follow TDD practices.</Methodology>

        Some additional notes about this agent.
      </Agent>
    `;
    expect(compile(tsx)).toMatchSnapshot();
  });

  it('works with minimal contract (just Role)', () => {
    const tsx = `
      <Agent name="simple" description="Simple agent">
        <Role>You handle simple tasks.</Role>
      </Agent>
    `;
    expect(compile(tsx)).toMatchSnapshot();
  });
});

// ============================================================================
// Validation Error Tests
// ============================================================================

describe('Contract validation errors', () => {
  it('errors on duplicate Role', () => {
    const tsx = `
      <Agent name="test" description="Test">
        <Role>First role</Role>
        <Role>Second role</Role>
      </Agent>
    `;
    expectCompileError(tsx, 'can only have one <Role>');
  });

  it('errors on duplicate StructuredReturns', () => {
    const tsx = `
      <Agent name="test" description="Test">
        <StructuredReturns>
          <Return status="SUCCESS">OK</Return>
        </StructuredReturns>
        <StructuredReturns>
          <Return status="FAILED">Not OK</Return>
        </StructuredReturns>
      </Agent>
    `;
    expectCompileError(tsx, 'can only have one <StructuredReturns>');
  });

  it('errors on wrong order (Methodology before Role)', () => {
    const tsx = `
      <Agent name="test" description="Test">
        <Methodology>Do stuff</Methodology>
        <Role>I am a role</Role>
      </Agent>
    `;
    expectCompileError(tsx, 'must appear in order');
  });

  it('errors on wrong order (StructuredReturns before UpstreamInput)', () => {
    const tsx = `
      <Agent name="test" description="Test">
        <StructuredReturns>
          <Return status="SUCCESS">OK</Return>
        </StructuredReturns>
        <UpstreamInput>Input spec</UpstreamInput>
      </Agent>
    `;
    expectCompileError(tsx, 'must appear in order');
  });

  it('errors on empty StructuredReturns', () => {
    const tsx = `
      <Agent name="test" description="Test">
        <StructuredReturns></StructuredReturns>
      </Agent>
    `;
    expectCompileError(tsx, 'must have at least one Return');
  });

  it('errors on Return without status', () => {
    const tsx = `
      <Agent name="test" description="Test">
        <StructuredReturns>
          <Return>Missing status prop</Return>
        </StructuredReturns>
      </Agent>
    `;
    expectCompileError(tsx, 'requires status prop');
  });

  it('errors on non-Return children in StructuredReturns', () => {
    const tsx = `
      <Agent name="test" description="Test">
        <StructuredReturns>
          <Return status="SUCCESS">OK</Return>
          <Markdown>This should not be here</Markdown>
        </StructuredReturns>
      </Agent>
    `;
    expectCompileError(tsx, 'can only contain Return');
  });

  it('errors on Return outside StructuredReturns', () => {
    const tsx = `
      <Agent name="test" description="Test">
        <Return status="SUCCESS">Orphan return</Return>
      </Agent>
    `;
    expectCompileError(tsx, 'can only be used inside StructuredReturns');
  });
});
```
  </action>
  <verify>
```bash
cd /Users/glenninizan/workspace/react-agentic/react-agentic && npx vitest run tests/components/contract.test.ts --update 2>&1 | tail -30
```
Tests should pass and create snapshots.
  </verify>
  <done>Contract test file exists with comprehensive test coverage</done>
</task>

<task type="auto">
  <name>Task 2: Run Tests and Verify Snapshots</name>
  <files>tests/components/__snapshots__/contract.test.ts.snap</files>
  <action>
Run the tests with snapshot update to generate snapshots:

```bash
cd /Users/glenninizan/workspace/react-agentic/react-agentic
npx vitest run tests/components/contract.test.ts --update
```

Review the generated snapshots to ensure they match expected output format:
- Role renders as `<role>content</role>`
- UpstreamInput renders as `<upstream_input>content</upstream_input>`
- DownstreamConsumer renders as `<downstream_consumer>content</downstream_consumer>`
- Methodology renders as `<methodology>content</methodology>`
- StructuredReturns renders as `<structured_returns>` with `## STATUS` headings

If snapshots look incorrect, debug the emitter and transformer logic.
  </action>
  <verify>
```bash
cd /Users/glenninizan/workspace/react-agentic/react-agentic && npx vitest run tests/components/contract.test.ts 2>&1 | tail -20
```
All tests should pass.
  </verify>
  <done>Snapshots generated and verified to match expected output format</done>
</task>

<task type="auto">
  <name>Task 3: Run Full Test Suite</name>
  <files></files>
  <action>
Run the full test suite to ensure no regressions in existing functionality:

```bash
cd /Users/glenninizan/workspace/react-agentic/react-agentic
npm test
```

If any tests fail, investigate and fix. Contract components should not affect existing tests.
  </action>
  <verify>
```bash
cd /Users/glenninizan/workspace/react-agentic/react-agentic && npm test 2>&1 | tail -30
```
All tests should pass.
  </verify>
  <done>Full test suite passes with no regressions</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

```bash
cd /Users/glenninizan/workspace/react-agentic/react-agentic

# All tests pass
npm test

# Contract tests specifically pass
npx vitest run tests/components/contract.test.ts

# Snapshot file exists
ls tests/components/__snapshots__/contract.test.ts.snap
```

Expected:
- All tests pass
- Contract test file has 15+ test cases
- Snapshot file exists with expected markdown output
</verification>

<success_criteria>
- [ ] tests/components/contract.test.ts exists with comprehensive tests
- [ ] Snapshot file generated with correct markdown output
- [ ] All contract component rendering tests pass
- [ ] All validation error tests pass
- [ ] Full test suite passes (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/34-agent-contract-components/34-04-SUMMARY.md`
</output>
