---
phase: 12-typed-spawnagent-input
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ir/nodes.ts
  - src/jsx.ts
autonomous: true

must_haves:
  truths:
    - "SpawnAgentNode IR supports optional input field"
    - "SpawnAgentNode IR supports optional extraInstructions field"
    - "SpawnAgentProps accepts input prop as VariableRef OR object literal"
    - "prompt prop is marked optional for backward compatibility"
  artifacts:
    - path: "src/ir/nodes.ts"
      provides: "Extended SpawnAgentNode with input and extraInstructions"
      contains: "SpawnAgentInput"
    - path: "src/jsx.ts"
      provides: "Updated SpawnAgentProps with input prop"
      contains: "input?:"
  key_links:
    - from: "src/jsx.ts"
      to: "src/ir/nodes.ts"
      via: "SpawnAgentInput type alignment"
      pattern: "SpawnAgentInput"
---

<objective>
Extend IR and JSX types to support typed `input` prop on SpawnAgent.

Purpose: Foundation types needed for the transformer and emitter to handle type-driven input instead of freeform prompts.

Output:
- Extended SpawnAgentNode with `input` (optional) and `extraInstructions` (optional) fields
- SpawnAgentInput discriminated union type for VariableRef and object literal forms
- Updated SpawnAgentProps to accept `input` prop and make `prompt` optional
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-typed-spawnagent-input/12-RESEARCH.md

@src/ir/nodes.ts
@src/jsx.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SpawnAgentNode in IR</name>
  <files>src/ir/nodes.ts</files>
  <action>
Add SpawnAgentInput type and extend SpawnAgentNode:

1. Add discriminated union type for input:
```typescript
/**
 * Input value for SpawnAgent typed input
 */
export type InputPropertyValue =
  | { type: 'string'; value: string }
  | { type: 'variable'; name: string }
  | { type: 'placeholder'; name: string };  // {varname} syntax

/**
 * Property in SpawnAgent object literal input
 */
export interface InputProperty {
  name: string;
  value: InputPropertyValue;
}

/**
 * SpawnAgent input - either a variable reference or object literal
 */
export type SpawnAgentInput =
  | { type: 'variable'; variableName: string }  // useVariable ref
  | { type: 'object'; properties: InputProperty[] };  // object literal
```

2. Update SpawnAgentNode interface:
- Make `prompt` optional: `prompt?: string;` (was required)
- Add `input?: SpawnAgentInput;`
- Add `extraInstructions?: string;` (for children content)

Keep existing fields: kind, agent, model, description, inputType
  </action>
  <verify>Run `npm run build` - should compile without errors</verify>
  <done>SpawnAgentNode has optional input, extraInstructions fields; SpawnAgentInput type exists</done>
</task>

<task type="auto">
  <name>Task 2: Update SpawnAgentProps in JSX</name>
  <files>src/jsx.ts</files>
  <action>
Update SpawnAgentProps interface:

1. Make `prompt` optional and add deprecation JSDoc:
```typescript
/**
 * @deprecated Use `input` prop with typed object or VariableRef instead.
 * Prompt content - supports multi-line and {variable} placeholders
 */
prompt?: string;
```

2. Add `input` prop that accepts VariableRef or object matching TInput:
```typescript
/**
 * Typed input - either a VariableRef from useVariable() or an object literal.
 * Auto-generates structured prompt from Agent's interface contract.
 * Mutually exclusive with prompt prop.
 */
input?: VariableRef<TInput> | Partial<TInput>;
```

3. Add `children` to SpawnAgentProps (already has ReactNode from interface pattern):
```typescript
/**
 * Optional extra instructions appended to the auto-generated prompt.
 * Only used when input prop is provided.
 */
children?: ReactNode;
```

Note: The TInput generic parameter is phantom (compile-time only) - actual validation happens in transformer.
  </action>
  <verify>Run `npm run build` - TypeScript compiles without errors</verify>
  <done>SpawnAgentProps has optional prompt, new input prop, children prop with proper JSDoc</done>
</task>

</tasks>

<verification>
- `npm run build` completes successfully
- `npm test` passes (existing tests still work with prompt as required in IR nodes created by tests)
- TypeScript recognizes SpawnAgentInput type in node definitions
</verification>

<success_criteria>
- SpawnAgentNode.input field exists and is optional
- SpawnAgentNode.extraInstructions field exists and is optional
- SpawnAgentNode.prompt field is now optional (not required)
- SpawnAgentInput type has 'variable' and 'object' discriminated variants
- SpawnAgentProps.input accepts VariableRef or object literal
- SpawnAgentProps.prompt is optional with deprecation notice
- All existing tests pass (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/12-typed-spawnagent-input/12-01-SUMMARY.md`
</output>
