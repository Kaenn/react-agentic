---
phase: 12-typed-spawnagent-input
plan: 03
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - src/emitter/emitter.ts
autonomous: true

must_haves:
  truths:
    - "SpawnAgent with input generates XML-structured prompt"
    - "VariableRef input emits <input>{var_name}</input> block"
    - "Object literal input emits <prop_name>value</prop_name> for each property"
    - "extraInstructions appended after auto-generated prompt"
    - "Existing prompt-based SpawnAgent emits unchanged"
  artifacts:
    - path: "src/emitter/emitter.ts"
      provides: "Prompt generation from SpawnAgentInput"
      contains: "generateInputPrompt"
  key_links:
    - from: "src/emitter/emitter.ts"
      to: "src/ir/nodes.ts"
      via: "Reads SpawnAgentInput to generate prompt"
      pattern: "input\\.type === 'variable'|input\\.type === 'object'"
---

<objective>
Generate XML-structured prompts from SpawnAgent input in emitter.

Purpose: Auto-generate structured prompts from typed input, eliminating manual prompt writing while ensuring consistent format.

Output:
- emitSpawnAgent generates prompt from input when input provided
- VariableRef input emits `<input>{VAR_NAME}</input>` format
- Object literal input emits `<prop_name>value</prop_name>` per property
- extraInstructions appended with blank line separator
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-typed-spawnagent-input/12-RESEARCH.md
@.planning/phases/12-typed-spawnagent-input/12-02-SUMMARY.md

@src/emitter/emitter.ts
@src/ir/nodes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prompt generation from input</name>
  <files>src/emitter/emitter.ts</files>
  <action>
Add generateInputPrompt method and update emitSpawnAgent:

1. Add private method to generate prompt from SpawnAgentInput:
```typescript
/**
 * Generate XML-structured prompt from SpawnAgentInput
 *
 * VariableRef -> <input>{var_name}</input>
 * Object literal -> <prop>value</prop> per property
 */
private generateInputPrompt(input: SpawnAgentInput): string {
  if (input.type === 'variable') {
    // Wrap variable in <input> block with lowercase variable name
    return `<input>\n{${input.variableName.toLowerCase()}}\n</input>`;
  }

  // Object literal: create XML section per property
  const sections: string[] = [];
  for (const prop of input.properties) {
    const value = this.formatInputValue(prop.value);
    sections.push(`<${prop.name}>\n${value}\n</${prop.name}>`);
  }
  return sections.join('\n\n');
}

/**
 * Format InputPropertyValue for prompt output
 */
private formatInputValue(value: InputPropertyValue): string {
  switch (value.type) {
    case 'string':
      return value.value;
    case 'placeholder':
      return `{${value.name}}`;
    case 'variable':
      return `{${value.name.toLowerCase()}}`;
  }
}
```

2. Update emitSpawnAgent to handle input:
```typescript
private emitSpawnAgent(node: SpawnAgentNode): string {
  const escapeQuotes = (s: string): string => s.replace(/"/g, '\\"');

  // Determine prompt: use provided prompt OR generate from input
  let promptContent: string;
  if (node.prompt) {
    // Existing prompt-based usage (backward compat)
    promptContent = node.prompt;
  } else if (node.input) {
    // Generate from typed input
    promptContent = this.generateInputPrompt(node.input);
  } else {
    // Neither - shouldn't happen (transformer validates)
    throw new Error('SpawnAgent requires either prompt or input');
  }

  // Append extraInstructions if present
  if (node.extraInstructions) {
    promptContent = promptContent + '\n\n' + node.extraInstructions;
  }

  return `Task(
  prompt="${escapeQuotes(promptContent)}",
  subagent_type="${escapeQuotes(node.agent)}",
  model="${escapeQuotes(node.model)}",
  description="${escapeQuotes(node.description)}"
)`;
}
```

Import SpawnAgentInput and InputPropertyValue types from nodes.ts at the top of the file.
  </action>
  <verify>Run `npm run build` - compiles without errors</verify>
  <done>emitSpawnAgent generates prompt from input, appends extraInstructions</done>
</task>

<task type="auto">
  <name>Task 2: Add emitter tests for input-based prompts</name>
  <files>tests/emitter/spawnagent-emitter.test.ts</files>
  <action>
Add test cases for input-based prompt generation:

1. Test VariableRef input emission:
```typescript
describe('input-based prompt generation', () => {
  it('emits prompt from VariableRef input', () => {
    const doc = createDocWithSpawnAgent([{
      agent: 'test',
      model: 'm',
      description: 'd',
      input: { type: 'variable', variableName: 'CONTEXT' }
    }]);

    const output = emit(doc);

    expect(output).toContain('prompt="<input>\\n{context}\\n</input>"');
  });
});
```

2. Test object literal input emission:
```typescript
it('emits prompt from object literal input', () => {
  const doc = createDocWithSpawnAgent([{
    agent: 'test',
    model: 'm',
    description: 'd',
    input: {
      type: 'object',
      properties: [
        { name: 'phase', value: { type: 'string', value: '5' } },
        { name: 'goal', value: { type: 'placeholder', name: 'goal_var' } }
      ]
    }
  }]);

  const output = emit(doc);

  expect(output).toContain('<phase>');
  expect(output).toContain('5');
  expect(output).toContain('</phase>');
  expect(output).toContain('<goal>');
  expect(output).toContain('{goal_var}');
  expect(output).toContain('</goal>');
});
```

3. Test extraInstructions appending:
```typescript
it('appends extraInstructions to generated prompt', () => {
  const doc = createDocWithSpawnAgent([{
    agent: 'test',
    model: 'm',
    description: 'd',
    input: { type: 'variable', variableName: 'CTX' },
    extraInstructions: 'Additional context here.'
  }]);

  const output = emit(doc);

  // Prompt should contain both the input block and extra instructions
  expect(output).toContain('{ctx}');
  expect(output).toContain('Additional context here.');
});
```

4. Test backward compatibility:
```typescript
it('still emits from prompt prop (backward compat)', () => {
  const doc = createDocWithSpawnAgent([{
    agent: 'test',
    model: 'm',
    description: 'd',
    prompt: 'Do the task'
  }]);

  const output = emit(doc);

  expect(output).toContain('prompt="Do the task"');
});
```

Update createDocWithSpawnAgent helper to handle the new optional fields (input, extraInstructions).
  </action>
  <verify>Run `npm test` - all tests pass</verify>
  <done>Tests verify VariableRef emission, object literal emission, extraInstructions, backward compat</done>
</task>

</tasks>

<verification>
- `npm run build` compiles without errors
- `npm test` passes all tests
- Generated prompts have correct XML structure
- {placeholder} values preserved in output
- extraInstructions appear after main prompt content
</verification>

<success_criteria>
- VariableRef input emits `<input>\n{var_name}\n</input>` format
- Object literal input emits `<prop_name>\nvalue\n</prop_name>` per property
- extraInstructions appended with double newline separator
- Existing prompt prop still works unchanged
- {placeholder} patterns in values pass through to output
</success_criteria>

<output>
After completion, create `.planning/phases/12-typed-spawnagent-input/12-03-SUMMARY.md`
</output>
