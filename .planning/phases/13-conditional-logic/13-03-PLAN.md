---
phase: 13-conditional-logic
plan: 03
type: execute
wave: 3
depends_on: ["13-02"]
files_modified:
  - src/emitter/emitter.ts
  - src/app/basic/test-conditional.tsx
autonomous: true

must_haves:
  truths:
    - "IfNode emits **If {test}:** followed by content"
    - "ElseNode emits **Otherwise:** followed by content"
    - "Nested If produces readable indentation"
    - "Variable interpolation in test props preserved"
    - "If/Else pair emits complete conditional block"
  artifacts:
    - path: "src/emitter/emitter.ts"
      provides: "emitIf and emitElse methods"
      contains: "emitIf"
    - path: "src/app/basic/test-conditional.tsx"
      provides: "Example showing If/Else usage"
      contains: "<If test"
  key_links:
    - from: "src/emitter/emitter.ts"
      to: "src/ir/nodes.ts"
      via: "Handles IfNode and ElseNode kinds"
      pattern: "case 'if'"
---

<objective>
Implement emitter logic and create test command for If/Else components.

Purpose: Emit IfNode as `**If {test}:**` prose pattern and ElseNode as `**Otherwise:**` pattern, matching GSD command formatting. Create a test command demonstrating all conditional features: basic If, If/Else pairs, nested conditionals, and variable interpolation.

Output: Working emitIf/emitElse methods, test command file, verified markdown output.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-conditional-logic/13-RESEARCH.md
@.planning/phases/13-conditional-logic/13-02-SUMMARY.md

@src/emitter/emitter.ts
@src/ir/nodes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add emitIf and emitElse to emitter</name>
  <files>src/emitter/emitter.ts</files>
  <action>
1. Add IfNode and ElseNode to the type imports:

```typescript
import type {
  // ... existing imports ...
  IfNode,
  ElseNode,
} from '../ir/index.js';
```

2. Add cases to the emitBlock switch statement (after 'assign' case):

```typescript
case 'if':
  return this.emitIf(node);
case 'else':
  return this.emitElse(node);
```

3. Add the emitter methods after emitAssign:

```typescript
/**
 * Emit If node as prose-based conditional
 *
 * Output format:
 * **If {test}:**
 *
 * {content}
 */
private emitIf(node: IfNode): string {
  const parts: string[] = [];

  // Emit condition header
  parts.push(`**If ${node.test}:**`);

  // Emit "then" block content with blank line after header
  for (const child of node.children) {
    parts.push(this.emitBlock(child));
  }

  return parts.join('\n\n');
}

/**
 * Emit Else node as prose-based conditional
 *
 * Output format:
 * **Otherwise:**
 *
 * {content}
 */
private emitElse(node: ElseNode): string {
  const parts: string[] = [];

  // Emit "otherwise" header
  parts.push('**Otherwise:**');

  // Emit "else" block content with blank line after header
  for (const child of node.children) {
    parts.push(this.emitBlock(child));
  }

  return parts.join('\n\n');
}
```

The output format matches GSD patterns:
- **If [ -f config.json ]:** (bold header with test expression)
- Blank line
- Content blocks
- **Otherwise:** (bold header)
- Blank line
- Content blocks

Nested If within children is automatically handled via recursive emitBlock calls.
  </action>
  <verify>
Run `npx tsc --noEmit` - should compile successfully.
Check methods: `grep -E "emitIf|emitElse" src/emitter/emitter.ts`
  </verify>
  <done>emitIf outputs **If {test}:** followed by content. emitElse outputs **Otherwise:** followed by content. Both use double newline separation.</done>
</task>

<task type="auto">
  <name>Task 2: Create test conditional command</name>
  <files>src/app/basic/test-conditional.tsx</files>
  <action>
Create a test command that demonstrates all conditional features:

```tsx
/**
 * Test command for conditional logic
 *
 * Demonstrates:
 * - Basic If with shell test expression
 * - If/Else pair
 * - Nested If within Else
 * - Variable interpolation in test prop
 */

import { Command, XmlBlock, If, Else, Assign, useVariable } from '../../jsx.js';

const configExists = useVariable("CONFIG_EXISTS", {
  bash: `[ -f .planning/config.json ] && echo "true" || echo "false"`
});

const phaseDir = useVariable("PHASE_DIR", {
  bash: `ls -d .planning/phases/\${PHASE}-* 2>/dev/null | head -1`
});

export default function TestConditional() {
  return (
    <Command name="test-conditional" description="Test conditional logic components">
      <h2>Conditional Logic Test</h2>

      <p>This command tests the If/Else conditional components.</p>

      <XmlBlock name="process">
        <h3>Step 1: Check Configuration</h3>
        <Assign var={configExists} />

        <If test="[ $CONFIG_EXISTS = 'true' ]">
          <p>Configuration found. Loading settings from config file.</p>
        </If>
        <Else>
          <p>No configuration found. Using default settings.</p>
        </Else>

        <h3>Step 2: Find Phase Directory</h3>
        <Assign var={phaseDir} />

        <If test={`[ -z \${phaseDir.ref} ]`}>
          <p>Phase directory not found. Creating new directory.</p>
          <pre><code className="language-bash">mkdir -p .planning/phases/$PHASE-unknown</code></pre>
        </If>
        <Else>
          <p>Using existing phase directory.</p>

          <If test="[ -f $PHASE_DIR/*-CONTEXT.md ]">
            <p>Found context file. Reading prior decisions.</p>
          </If>
        </Else>

        <h3>Step 3: Basic Conditional</h3>
        <If test="[ -d .git ]">
          <p>Git repository detected. Checking status.</p>
          <pre><code className="language-bash">git status</code></pre>
        </If>
      </XmlBlock>
    </Command>
  );
}
```

The test demonstrates:
1. Basic If (COND-01, COND-03)
2. If/Else pair (COND-04)
3. Nested If within Else (COND-05)
4. Variable interpolation in test (COND-02, COND-06)
5. If without Else (valid usage)
  </action>
  <verify>
Build the command: `node dist/cli/index.js build "src/app/basic/test-conditional.tsx"`
Verify output file created: `ls -la .claude/commands/test-conditional.md`
Verify markdown structure: `cat .claude/commands/test-conditional.md | head -50`
  </verify>
  <done>Test command exists with all conditional patterns. Build succeeds and produces readable markdown with **If condition:**/**Otherwise:** patterns.</done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end and update docs</name>
  <files>docs/getting-started.md</files>
  <action>
1. Run the full test suite to verify no regressions:
```bash
npm test
```

2. Build the test command and verify output:
```bash
node dist/cli/index.js build "src/app/basic/test-conditional.tsx"
cat .claude/commands/test-conditional.md
```

Expected output structure:
```markdown
---
name: test-conditional
description: Test conditional logic components
---

## Conditional Logic Test

...

<process>
### Step 1: Check Configuration

```bash
CONFIG_EXISTS=$([ -f .planning/config.json ] && echo "true" || echo "false")
```

**If [ $CONFIG_EXISTS = 'true' ]:**

Configuration found. Loading settings from config file.

**Otherwise:**

No configuration found. Using default settings.

...
</process>
```

3. Add a brief mention in docs/getting-started.md under components (or create a new section if needed). Find the "Core Components" section and add If/Else:

After the existing components table, add:

```markdown
### Conditional Components

| Component | Purpose | Example |
|-----------|---------|---------|
| `<If>` | Conditional block | `<If test="[ -f file ]">content</If>` |
| `<Else>` | Optional else block | Must follow `</If>` |

Conditionals emit as prose-based `**If condition:**` / `**Otherwise:**` patterns.
```
  </action>
  <verify>
Run `npm test` - all tests pass.
Build command succeeds: `node dist/cli/index.js build "src/app/basic/test-conditional.tsx"`
Output contains **If: `grep "**If" .claude/commands/test-conditional.md`
Output contains **Otherwise: `grep "**Otherwise" .claude/commands/test-conditional.md`
  </verify>
  <done>All tests pass. Test command builds correctly. Output matches GSD prose conditional format. Docs updated with If/Else components.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. All tests pass: `npm test`
3. Build test command: `node dist/cli/index.js build "src/app/basic/test-conditional.tsx"`
4. Verify prose format:
   - `grep "**If" .claude/commands/test-conditional.md` returns matches
   - `grep "**Otherwise" .claude/commands/test-conditional.md` returns matches
5. Verify nested conditional indentation is readable
6. Verify variable interpolation preserved in output
</verification>

<success_criteria>
- emitIf produces `**If {test}:**` followed by children content
- emitElse produces `**Otherwise:**` followed by children content
- Nested If within children produces readable output
- Test command builds without errors
- Output markdown matches GSD prose conditional format
- All existing tests pass (no regression)
- Docs mention If/Else components
</success_criteria>

<output>
After completion, create `.planning/phases/13-conditional-logic/13-03-SUMMARY.md`
</output>
