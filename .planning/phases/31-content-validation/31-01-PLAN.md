---
phase: 31-content-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ir/content-types.ts
  - src/components/Command.ts
  - src/components/Agent.ts
  - tests/ir/content-validation.test.ts
autonomous: true

must_haves:
  truths:
    - "SpawnAgent inside SubComponentContent children prop causes TypeScript error"
    - "Control flow (If/Else/Loop/Break) inside SubComponentContent causes TypeScript error"
    - "Valid nesting (heading, paragraph, table) compiles without errors"
    - "JSDoc hover on SubComponentContent shows exclusion list"
  artifacts:
    - path: "src/ir/content-types.ts"
      provides: "Enhanced JSDoc documentation on content types"
      contains: "@example"
    - path: "tests/ir/content-validation.test.ts"
      provides: "User component pattern tests demonstrating validation"
      min_lines: 80
  key_links:
    - from: "src/ir/content-types.ts"
      to: "user component children prop"
      via: "TypeScript type import"
      pattern: "SubComponentContent"
---

<objective>
Implement compile-time content validation through enhanced JSDoc documentation and comprehensive user component pattern tests.

Purpose: Enable users to type their custom component children props with SubComponentContent and receive compile-time TypeScript errors for invalid nesting (SpawnAgent, control flow).

Output: Enhanced content-types.ts with clear JSDoc, updated Command/Agent children typing for consistency, and test file demonstrating validation patterns.
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 28 foundation - content types implementation
@.planning/phases/28-content-types/28-01-SUMMARY.md
@src/ir/content-types.ts

# Phase 31 research - patterns and pitfalls
@.planning/phases/31-content-validation/31-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance content types with comprehensive JSDoc</name>
  <files>src/ir/content-types.ts</files>
  <action>
Add comprehensive JSDoc documentation to all three content types in content-types.ts.

For SubComponentContent, add:
1. Clear explanation of what's excluded and why (document-level vs presentation)
2. Complete list of 10 excluded node types with categories
3. @example showing user component pattern with children prop typed as SubComponentContent
4. Explicit statement that TypeScript will reject invalid assignments

For CommandContent and AgentContent, add:
1. Statement that these allow full feature set
2. @example showing typical usage in Command/Agent children

The JSDoc should be visible when users hover over the types in their IDE, providing immediate guidance without needing to reference documentation.

Key insight from research: TypeScript cannot show custom error messages, so JSDoc is our primary way to communicate restrictions to users.
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no errors
2. Open content-types.ts in editor, hover over SubComponentContent - should see exclusion list
3. Grep for "@example" in content-types.ts - should find 3+ examples
  </verify>
  <done>
All three content types have comprehensive JSDoc with examples and SubComponentContent clearly lists all 10 excluded node types with categories.
  </done>
</task>

<task type="auto">
  <name>Task 2: Type Command/Agent children with content types</name>
  <files>src/components/Command.ts, src/components/Agent.ts</files>
  <action>
Update CommandProps and AgentProps to type children with CommandContent and AgentContent respectively.

In Command.ts:
1. Import CommandContent from '../ir/content-types.js'
2. Change children type from `ReactNode | ((ctx: CommandContext) => ReactNode)` to `CommandContent | CommandContent[] | ((ctx: CommandContext) => ReactNode) | ReactNode`
3. Update JSDoc to explain the content type usage

In Agent.ts:
1. Import AgentContent from '../ir/content-types.js'
2. Change children type from `ReactNode | ((ctx: AgentContext) => ReactNode)` to `AgentContent | AgentContent[] | ((ctx: AgentContext) => ReactNode) | ReactNode`
3. Update JSDoc to explain the content type usage

IMPORTANT: Keep ReactNode in the union to maintain backward compatibility - this formalizes the types without breaking existing code. The content types provide opt-in validation when users explicitly use them.
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no errors
2. Run `npm test` - all tests pass
3. Existing Command/Agent usage in tests compiles without changes
  </verify>
  <done>
Command and Agent children props include content types alongside ReactNode for enhanced type documentation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add user component pattern validation tests</name>
  <files>tests/ir/content-validation.test.ts</files>
  <action>
Create a new test file demonstrating the user-facing validation patterns.

Test categories:
1. User component with SubComponentContent children - valid cases
   - Heading, paragraph, table children compile
   - XmlBlock wrapper children compile
   - Multiple SubComponentContent elements compile

2. User component with SubComponentContent children - invalid cases (use @ts-expect-error)
   - SpawnAgent child causes type error
   - If/Else children cause type error
   - Loop/Break children cause type error
   - Return child causes type error
   - AskUser child causes type error
   - RuntimeVarDecl child causes type error
   - RuntimeCall child causes type error
   - OnStatus child causes type error

3. Document-level components with full content - valid cases
   - Command/Agent can contain SpawnAgent
   - Command/Agent can contain control flow
   - Nested valid content works

Pattern to use for testing:
```typescript
interface UserCardProps {
  title: string;
  children?: SubComponentContent | SubComponentContent[];
}

// Valid
const validCard: UserCardProps = {
  title: 'Test',
  children: { kind: 'heading', level: 1, children: [] } as HeadingNode,
};

// @ts-expect-error - SpawnAgentNode not assignable to SubComponentContent
const invalidCard: UserCardProps = {
  title: 'Test',
  children: { kind: 'spawnAgent', agent: 'x', model: 'y', description: 'z' } as SpawnAgentNode,
};
```

This tests the actual user-facing pattern (typing component props) rather than just direct type assignment.
  </action>
  <verify>
1. Run `npm test tests/ir/content-validation.test.ts` - all tests pass
2. Check for 10+ @ts-expect-error directives (one per excluded node type)
3. Check test count - should have 15+ tests
  </verify>
  <done>
Content validation tests demonstrate user component patterns with @ts-expect-error directives proving compile-time rejection of invalid content.
  </done>
</task>

</tasks>

<verification>
After all tasks:

1. TypeScript compile check: `npx tsc --noEmit`
2. Full test suite: `npm test`
3. Specific validation tests: `npm test tests/ir/content-validation.test.ts`
4. Count @ts-expect-error in new test file - should have 10+ (one per excluded type)
5. Verify JSDoc visibility: Open content-types.ts, hover over SubComponentContent

All tests from Phase 28 must still pass - this phase adds documentation and patterns, not new restrictions.
</verification>

<success_criteria>
- [ ] SubComponentContent JSDoc lists all 10 excluded node types
- [ ] CommandContent and AgentContent have JSDoc examples
- [ ] Command/Agent children props include content types
- [ ] New test file has 15+ tests with user component patterns
- [ ] 10+ @ts-expect-error directives prove compile-time rejection
- [ ] All existing tests pass
- [ ] Build succeeds with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-content-validation/31-01-SUMMARY.md`
</output>
