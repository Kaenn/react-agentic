---
phase: 06-watch-error-handling
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/commands/build.ts
  - src/cli/output.ts
autonomous: true

must_haves:
  truths:
    - "User can run `react-agentic build --dry-run` to preview output"
    - "Dry run shows file tree with expected output paths and sizes"
    - "Dry run does not write any files to disk"
    - "Dry run validates all files and reports errors if any"
  artifacts:
    - path: "src/cli/commands/build.ts"
      provides: "--dry-run option handling"
      contains: ".option('-d, --dry-run'"
    - path: "src/cli/output.ts"
      provides: "Build tree output formatting"
      exports: ["logBuildTree"]
  key_links:
    - from: "src/cli/commands/build.ts"
      to: "src/cli/output.ts"
      via: "calls logBuildTree for dry-run output"
      pattern: "logBuildTree"
---

<objective>
Add dry-run mode to preview transpilation output without writing files.

Purpose: Users want to see what files would be created and validate their TSX before committing changes. Dry run shows the output file tree (Next.js build style) with file sizes.

Output: `--dry-run` flag, build tree formatting, validation-only mode.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-watch-error-handling/06-RESEARCH.md
@.planning/phases/06-watch-error-handling/06-CONTEXT.md

@src/cli/commands/build.ts
@src/cli/output.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add build tree output formatting</name>
  <files>src/cli/output.ts</files>
  <action>
Add Next.js-style build tree output to the output module:

1. Add `BuildResult` interface:
   ```typescript
   interface BuildResult {
     inputFile: string;
     outputPath: string;
     content: string;
     size: number;
   }
   ```

2. Add `formatBytes(bytes: number): string` helper:
   - `< 1024` -> `${bytes} B`
   - `< 1024 * 1024` -> `${(bytes / 1024).toFixed(1)} KB`
   - Otherwise -> `${(bytes / (1024 * 1024)).toFixed(1)} MB`

3. Add `logBuildTree(results: BuildResult[], dryRun: boolean): void`:
   - Print header: "Output:" (or "Would create:" if dryRun)
   - For each result:
     - Format: `  {outputPath}  {size}` (two spaces indent)
     - Use pc.cyan for path
     - Use pc.dim for size (right-aligned, 8 chars)
   - Print blank line after

Example output:
```
Output:
  .claude/commands/analyze.md       1.2 KB
  .claude/commands/test.md          0.8 KB
```

Export: BuildResult, logBuildTree
  </action>
  <verify>`npm run typecheck` passes</verify>
  <done>logBuildTree function exists and formats file tree with sizes</done>
</task>

<task type="auto">
  <name>Task 2: Add --dry-run option to build command</name>
  <files>src/cli/commands/build.ts</files>
  <action>
Modify the build command to support dry-run mode:

1. Update BuildOptions interface:
   ```typescript
   interface BuildOptions {
     out: string;
     dryRun?: boolean;
   }
   ```

2. Add option to command:
   ```typescript
   .option('-d, --dry-run', 'Preview output without writing files')
   ```

3. Refactor the build loop to collect results:
   - Create `results: BuildResult[]` array
   - For each successful transform, push result with:
     - inputFile
     - outputPath
     - content (the markdown)
     - size: `Buffer.byteLength(content, 'utf8')`

4. After processing all files:
   - If `options.dryRun`:
     - Call `logBuildTree(results, true)` to show what would be created
     - Skip mkdir and writeFile operations
     - Still show summary and exit with error code if any failures
   - If NOT dryRun:
     - Write files as before
     - Call `logBuildTree(results, false)` after writing (new: show build tree)
     - Show summary

5. Import logBuildTree and BuildResult from '../output.js'

The key change: always collect results first, then either write+display or just display.
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm test` passes
    - Run `npx tsx src/cli/index.ts build --dry-run commands/*.tsx` with a test file
    - Verify no files written, tree displayed
  </verify>
  <done>`--dry-run` flag prevents file writing and shows preview tree with sizes</done>
</task>

</tasks>

<verification>
1. Create test file `test-dry-run.tsx`:
   ```tsx
   export default <Command name="test" description="Test command">
     <h1>Test</h1>
     <p>Content here</p>
   </Command>
   ```

2. Run `npx tsx src/cli/index.ts build --dry-run test-dry-run.tsx`

3. Verify:
   - "Would create:" header
   - File tree shows `.claude/commands/test-dry-run.md` with size
   - No file actually created (check with `ls .claude/commands/test-dry-run.md`)
   - Exit code 0

4. Run without --dry-run to verify normal build still works and shows tree

5. Clean up: `rm test-dry-run.tsx .claude/commands/test-dry-run.md`
</verification>

<success_criteria>
- `--dry-run` flag accepted by CLI
- Dry run shows "Would create:" with file tree
- No files written in dry-run mode
- Normal build shows "Output:" with file tree
- File sizes displayed in human-readable format
</success_criteria>

<output>
After completion, create `.planning/phases/06-watch-error-handling/06-02-SUMMARY.md`
</output>
