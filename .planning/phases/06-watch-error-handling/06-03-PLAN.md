---
phase: 06-watch-error-handling
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/cli/watcher.ts
  - src/cli/commands/build.ts
  - package.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can run `react-agentic build --watch` and see auto-rebuild on file changes"
    - "Watch mode debounces rapid file changes (no duplicate builds)"
    - "Terminal clears before each rebuild for fresh output"
    - "Ctrl+C stops watch mode gracefully with 'Stopping watch...' message"
    - "Initial build runs immediately before watching begins"
  artifacts:
    - path: "src/cli/watcher.ts"
      provides: "File watcher with debouncing"
      exports: ["createWatcher", "Watcher"]
    - path: "src/cli/commands/build.ts"
      provides: "--watch option handling"
      contains: ".option('-w, --watch'"
    - path: "package.json"
      provides: "chokidar dependency"
      contains: '"chokidar"'
  key_links:
    - from: "src/cli/commands/build.ts"
      to: "src/cli/watcher.ts"
      via: "creates and uses file watcher"
      pattern: "createWatcher"
    - from: "src/cli/watcher.ts"
      to: "chokidar"
      via: "wraps chokidar with debounce"
      pattern: "chokidar.watch"
---

<objective>
Add watch mode for automatic rebuilds on file changes.

Purpose: Developers want fast feedback loops. Watch mode rebuilds automatically when source files change, with debouncing to avoid duplicate builds from rapid edits.

Output: `--watch` flag, chokidar-based file watcher with debouncing, graceful shutdown.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-watch-error-handling/06-RESEARCH.md
@.planning/phases/06-watch-error-handling/06-CONTEXT.md

@src/cli/commands/build.ts
@src/cli/output.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install chokidar and create watcher module</name>
  <files>package.json, src/cli/watcher.ts</files>
  <action>
1. Install chokidar:
   ```bash
   npm install chokidar
   ```

2. Create `src/cli/watcher.ts` with:

```typescript
/**
 * File Watcher - Watch for file changes with debouncing
 */
import chokidar from 'chokidar';
import type { FSWatcher } from 'chokidar';

export interface Watcher {
  close(): Promise<void>;
}

export interface WatcherOptions {
  debounceMs?: number;
  onReady?: () => void;
}

/**
 * Create a file watcher with debounced rebuild callback
 *
 * @param files - Array of file paths to watch (use globby to expand first)
 * @param onRebuild - Callback when files change (receives changed file paths)
 * @param options - Configuration options
 */
export function createWatcher(
  files: string[],
  onRebuild: (changedFiles: string[]) => Promise<void>,
  options: WatcherOptions = {}
): Watcher {
  const debounceMs = options.debounceMs ?? 200;

  let timeout: NodeJS.Timeout | null = null;
  let pending: Set<string> = new Set();
  let isRebuilding = false;

  const watcher: FSWatcher = chokidar.watch(files, {
    ignoreInitial: true,  // Don't fire on startup - do full build first
    awaitWriteFinish: {
      stabilityThreshold: 100,  // Wait for writes to complete
      pollInterval: 50,
    },
  });

  const triggerRebuild = async () => {
    if (isRebuilding) {
      // If already rebuilding, reschedule
      timeout = setTimeout(triggerRebuild, debounceMs);
      return;
    }

    const changedFiles = Array.from(pending);
    pending.clear();

    if (changedFiles.length === 0) return;

    isRebuilding = true;
    try {
      await onRebuild(changedFiles);
    } finally {
      isRebuilding = false;
    }
  };

  watcher.on('all', (event, filePath) => {
    if (event === 'add' || event === 'change' || event === 'unlink') {
      pending.add(filePath);

      if (timeout) clearTimeout(timeout);
      timeout = setTimeout(triggerRebuild, debounceMs);
    }
  });

  if (options.onReady) {
    watcher.on('ready', options.onReady);
  }

  watcher.on('error', (error) => {
    console.error('Watcher error:', error.message);
  });

  return {
    async close() {
      if (timeout) clearTimeout(timeout);
      await watcher.close();
    },
  };
}
```

Export: createWatcher, Watcher, WatcherOptions
  </action>
  <verify>
    - `npm run typecheck` passes
    - chokidar appears in package.json dependencies
  </verify>
  <done>Watcher module created with debounced file change detection</done>
</task>

<task type="auto">
  <name>Task 2: Add --watch option to build command</name>
  <files>src/cli/commands/build.ts</files>
  <action>
Modify the build command to support watch mode:

1. Update BuildOptions interface:
   ```typescript
   interface BuildOptions {
     out: string;
     dryRun?: boolean;
     watch?: boolean;
   }
   ```

2. Add option to command:
   ```typescript
   .option('-w, --watch', 'Watch for changes and rebuild automatically')
   ```

3. Import watcher utilities:
   ```typescript
   import { createWatcher, type Watcher } from '../watcher.js';
   ```

4. Refactor build logic into a reusable function:
   ```typescript
   async function runBuild(
     tsxFiles: string[],
     options: BuildOptions,
     project: Project,
     clearScreen: boolean
   ): Promise<{ successCount: number; errorCount: number }> {
     if (clearScreen) {
       console.clear();
     }
     // ... existing build logic moved here ...
     // Return { successCount, errorCount } instead of calling process.exit
   }
   ```

5. In the action handler, after initial setup:
   ```typescript
   if (options.watch) {
     // Disallow --dry-run with --watch
     if (options.dryRun) {
       console.error('Cannot use --dry-run with --watch');
       process.exit(1);
     }

     // Initial build
     logInfo(`Watching ${tsxFiles.length} file(s) for changes...\n`);
     await runBuild(tsxFiles, options, project, false);

     // Setup watcher
     const watcher = createWatcher(tsxFiles, async (changedFiles) => {
       logInfo(`\nFile changed: ${changedFiles.join(', ')}`);
       // Clear stale source files and re-add for fresh parse
       for (const file of changedFiles) {
         const existing = project.getSourceFile(file);
         if (existing) {
           project.removeSourceFile(existing);
         }
       }
       await runBuild(tsxFiles, options, project, true);
     });

     // Graceful shutdown
     const shutdown = async () => {
       console.log('\nStopping watch...');
       await watcher.close();
       process.exit(0);
     };

     process.on('SIGINT', shutdown);
     process.on('SIGTERM', shutdown);

     // Keep process running
     return;
   }
   ```

6. For non-watch mode, keep existing behavior (run build, exit with code).

Key points:
- Watch mode does NOT exit after build (process stays alive)
- Watch mode clears terminal before each rebuild
- Watch mode shows "Watching N file(s)..." message
- Watch mode removes old source files from ts-morph Project before re-adding (avoids circular import pitfall from research)
- Ctrl+C triggers graceful shutdown
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm test` passes
    - Run `npx tsx src/cli/index.ts build --watch commands/*.tsx` (with test file)
    - Modify test file, verify rebuild occurs
    - Press Ctrl+C, verify "Stopping watch..." appears
  </verify>
  <done>Watch mode auto-rebuilds on file changes with debouncing and graceful shutdown</done>
</task>

</tasks>

<verification>
1. Create test file `test-watch.tsx`:
   ```tsx
   export default <Command name="watch-test" description="Watch test">
     <h1>Original</h1>
   </Command>
   ```

2. Run `npx tsx src/cli/index.ts build --watch test-watch.tsx`

3. Verify:
   - Initial build runs, file created
   - "Watching 1 file(s) for changes..." message shown

4. In another terminal, modify test-watch.tsx:
   ```tsx
   export default <Command name="watch-test" description="Watch test">
     <h1>Modified</h1>
   </Command>
   ```

5. Verify:
   - Rebuild triggered automatically
   - Terminal cleared before rebuild
   - Output file updated

6. Rapid edits test: save file 3 times quickly, verify only 1 rebuild (debounce working)

7. Press Ctrl+C, verify:
   - "Stopping watch..." message
   - Process exits cleanly

8. Clean up: `rm test-watch.tsx .claude/commands/watch-test.md`

9. Verify --dry-run --watch fails:
   - `npx tsx src/cli/index.ts build --dry-run --watch test.tsx`
   - Should show error and exit
</verification>

<success_criteria>
- `--watch` flag accepted by CLI
- Initial build runs immediately
- Changes trigger rebuild after debounce delay
- Rapid changes result in single rebuild (debouncing works)
- Terminal clears before each rebuild
- Ctrl+C shows "Stopping watch..." and exits cleanly
- `--dry-run --watch` is rejected with error
</success_criteria>

<output>
After completion, create `.planning/phases/06-watch-error-handling/06-03-SUMMARY.md`
</output>
