---
phase: 26-parser-refactoring
plan: 04
type: execute
wave: 3
depends_on: ["26-03"]
files_modified:
  - src/parser/transformers/spawner.ts
  - src/parser/transformers/variables.ts
  - src/parser/transformers/state.ts
  - src/parser/transformers/primitives.ts
  - src/parser/transformers/markdown.ts
  - src/parser/transformers/dispatch.ts
  - src/parser/transformers/index.ts
  - src/parser/transformer.ts
  - src/parser/parser.ts
  - src/parser/index.ts
autonomous: true

must_haves:
  truths:
    - "All transformer methods extracted to focused modules"
    - "Transformer class is thin coordinator delegating to modules"
    - "parser.ts re-exports from utils/ instead of defining functions"
    - "All existing tests pass after refactoring"
    - "Build passes with no TypeScript errors"
  artifacts:
    - path: "src/parser/transformers/spawner.ts"
      provides: "transformSpawnAgent and helper methods"
      min_lines: 400
    - path: "src/parser/transformers/variables.ts"
      provides: "transformAssign, transformAssignGroup"
      min_lines: 200
    - path: "src/parser/transformers/state.ts"
      provides: "transformReadState, transformWriteState"
      min_lines: 200
    - path: "src/parser/transformers/primitives.ts"
      provides: "transformStep, transformBash, transformReadFiles, transformPromptTemplate"
      min_lines: 200
    - path: "src/parser/transformers/markdown.ts"
      provides: "transformMarkdown, transformXmlBlock, transformCustomComponent"
      min_lines: 250
    - path: "src/parser/transformer.ts"
      provides: "Thin Transformer class coordinator"
      max_lines: 300
  key_links:
    - from: "src/parser/transformer.ts"
      to: "src/parser/transformers/index.ts"
      via: "imports all transform functions"
      pattern: "import.*from.*transformers"
    - from: "src/parser/parser.ts"
      to: "src/parser/utils/index.ts"
      via: "re-exports all utilities"
      pattern: "export.*from.*utils"
    - from: "src/parser/index.ts"
      to: "src/parser/parser.ts"
      via: "public API unchanged"
      pattern: "export.*from.*parser"
---

<objective>
Complete transformer extraction, implement dispatch, and update entry files

Purpose: Finalize the refactoring with working coordinator and verified tests
Output: All transformer modules complete, slim coordinator, passing tests
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-parser-refactoring/26-RESEARCH.md
@.planning/phases/26-parser-refactoring/26-03-SUMMARY.md
@src/parser/transformer.ts
@src/parser/parser.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract remaining transformer modules (spawner, variables, state, primitives, markdown)</name>
  <files>
    src/parser/transformers/spawner.ts
    src/parser/transformers/variables.ts
    src/parser/transformers/state.ts
    src/parser/transformers/primitives.ts
    src/parser/transformers/markdown.ts
  </files>
  <action>
Extract final batch of transformer methods:

**transformers/spawner.ts** (~500 lines):
1. `transformSpawnAgent` - SpawnAgent element to SpawnAgentNode
2. `extractAgentProp` - Helper for agent prop extraction
3. `resolveAgentRef` - Helper for AgentRef resolution
4. `resolveImportedAgentRef` - Helper for imported AgentRef
5. `extractAgentRefFromObject` - Helper for AgentRef object extraction
6. `extractLoadFromFileProp` - Helper for loadFromFile prop
7. `extractInputProp` - Helper for input prop extraction
8. `extractExtraInstructions` - Helper for child content extraction
9. `extractSpawnAgentTypeParam` - Helper for type parameter
10. `validateInputAgainstInterface` - Helper for input validation

**transformers/variables.ts** (~250 lines):
1. `transformAssign` - Assign element to AssignNode
2. `transformAssignGroup` - AssignGroup element to AssignGroupNode
3. `extractAssignPropValue` - Helper for assignment prop extraction
4. `extractBashTemplate` - Helper for bash template extraction

**transformers/state.ts** (~250 lines):
1. `transformReadState` - ReadState element to ReadStateNode
2. `transformWriteState` - WriteState element to WriteStateNode
3. `extractStateKey` - Helper for state key extraction
4. `extractVariableName` - Helper for variable name extraction

**transformers/primitives.ts** (~250 lines):
1. `transformStep` - Step element to StepNode
2. `transformBash` - Bash element to CodeBlockNode
3. `transformReadFiles` - ReadFiles element to ReadFilesNode
4. `extractFilesFromSchema` - Helper for file schema extraction
5. `extractTemplatePath` - Helper for template path extraction

**transformers/markdown.ts** (~300 lines):
1. `transformMarkdown` - Markdown element to raw content
2. `transformXmlBlock` - XmlBlock element to XmlBlockNode
3. `transformCustomComponent` - Custom component resolution and inlining
4. `evaluateStringConcatenation` - Helper for string concat evaluation
5. `evaluateStringExpression` - Helper for string expression evaluation
6. `resolvePropertyAccess` - Helper for property access resolution
7. `extractTemplateText` - Helper for template text extraction
8. `extractPromptProp` - Helper for prompt prop extraction

All functions accept TransformContext as parameter.
  </action>
  <verify>
    `npx tsc --noEmit src/parser/transformers/spawner.ts src/parser/transformers/variables.ts src/parser/transformers/state.ts src/parser/transformers/primitives.ts src/parser/transformers/markdown.ts` passes
  </verify>
  <done>
    All 5 remaining transformer modules created
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement dispatch.ts and update transformers/index.ts</name>
  <files>
    src/parser/transformers/dispatch.ts
    src/parser/transformers/index.ts
  </files>
  <action>
Complete the dispatch module implementation:

**transformers/dispatch.ts** (~200 lines):

Replace stub implementation with full dispatch logic:

```typescript
import { Node } from 'ts-morph';
import type { BlockNode } from '../../ir/index.js';
import type { TransformContext } from './types.js';
import { getElementName, extractText } from '../utils/index.js';
import { isCustomComponent } from './shared.js';

// Import all transform functions
import { transformCommand, transformAgent, transformSkill, transformMCPConfig, transformState } from './document.js';
import { transformList, transformBlockquote, transformCodeBlock, transformDiv } from './html.js';
import { transformTable, transformPropList, transformExecutionContext, transformSuccessCriteria, transformOfferNext, transformXmlSection, transformXmlWrapper } from './semantic.js';
import { transformIf, transformElse, transformLoop, transformOnStatus } from './control.js';
import { transformSpawnAgent } from './spawner.js';
import { transformAssign, transformAssignGroup } from './variables.js';
import { transformReadState, transformWriteState } from './state.js';
import { transformStep, transformBash, transformReadFiles, transformPromptTemplate } from './primitives.js';
import { transformMarkdown, transformXmlBlock, transformCustomComponent } from './markdown.js';
import { transformInlineChildren } from './inline.js';

/**
 * Dispatch element transformation based on tag name
 */
export function transformElement(
  name: string,
  node: JsxElement | JsxSelfClosingElement,
  ctx: TransformContext
): BlockNode | null {
  // Heading elements
  const headingMatch = name.match(/^h([1-6])$/);
  if (headingMatch) {
    // ... heading handling
  }

  // Route to appropriate transformer based on element name
  switch (name) {
    case 'p': return transformParagraph(node, ctx);
    case 'hr': return { kind: 'thematicBreak' };
    case 'ul': return transformList(node, false, ctx);
    case 'ol': return transformList(node, true, ctx);
    // ... etc for all elements
  }
}

/**
 * Transform JSX children to BlockNodes, handling If/Else sibling pairs
 */
export function transformBlockChildren(
  jsxChildren: Node[],
  ctx: TransformContext
): BlockNode[] {
  // Implementation extracted from Transformer.transformBlockChildren
}

export function dispatchBlockTransform(node: Node, ctx: TransformContext): BlockNode | null {
  // Implementation that calls transformElement
}
```

**Update transformers/index.ts**:
Add exports for all new modules:
```typescript
// SpawnAgent
export { transformSpawnAgent } from './spawner.js';

// Variables
export { transformAssign, transformAssignGroup } from './variables.js';

// State
export { transformReadState, transformWriteState } from './state.js';

// Primitives
export { transformStep, transformBash, transformReadFiles, transformPromptTemplate } from './primitives.js';

// Markdown
export { transformMarkdown, transformXmlBlock, transformCustomComponent } from './markdown.js';
```
  </action>
  <verify>
    `npx tsc --noEmit src/parser/transformers/index.ts` passes
  </verify>
  <done>
    dispatch.ts fully implemented, index.ts exports all transformer modules
  </done>
</task>

<task type="auto">
  <name>Task 3: Update transformer.ts coordinator and parser.ts re-exports, verify tests</name>
  <files>
    src/parser/transformer.ts
    src/parser/parser.ts
    src/parser/index.ts
  </files>
  <action>
Update entry files to use new module structure:

**transformer.ts** (slim coordinator, ~200 lines):

Rewrite to delegate to transformer modules:

```typescript
import { Node, JsxElement, JsxSelfClosingElement, JsxFragment, SourceFile } from 'ts-morph';
import { TranspileError, getNodeLocation, getSourceCode } from '../cli/errors.js';
import type { DocumentNode, AgentDocumentNode, SkillDocumentNode, MCPConfigDocumentNode, StateDocumentNode } from '../ir/index.js';
import type { TransformContext } from './transformers/types.js';
import { getElementName, extractVariableDeclarations } from './utils/index.js';
import { transformCommand, transformAgent, transformSkill, transformMCPConfig, transformState } from './transformers/document.js';
import { transformBlockChildren } from './transformers/dispatch.js';

export class Transformer {
  private ctx: TransformContext;

  constructor() {
    this.ctx = this.createContext();
  }

  private createContext(): TransformContext {
    return {
      sourceFile: undefined,
      visitedPaths: new Set(),
      variables: new Map(),
      outputs: new Map(),
      stateRefs: new Map(),
      renderPropsContext: undefined,
      createError: (message, node) => {
        const location = getNodeLocation(node);
        const sourceCode = getSourceCode(node.getSourceFile());
        return new TranspileError(message, location, sourceCode);
      },
    };
  }

  transform(node: JsxElement | JsxSelfClosingElement | JsxFragment, sourceFile?: SourceFile): DocumentNode | AgentDocumentNode | SkillDocumentNode | MCPConfigDocumentNode | StateDocumentNode {
    // Initialize context
    this.ctx.sourceFile = sourceFile;
    // ... extract variables, outputs, stateRefs

    // Delegate to appropriate transformer
    if (Node.isJsxElement(node) || Node.isJsxSelfClosingElement(node)) {
      const name = getElementName(node);
      if (name === 'Command') return transformCommand(node, this.ctx);
      if (name === 'Agent') return transformAgent(node, this.ctx);
      // ... etc
    }
  }
}

export function transform(...) {
  const transformer = new Transformer();
  return transformer.transform(...);
}
```

**parser.ts** (re-exports only, ~20 lines):

```typescript
/**
 * Parser utilities - re-exports from utils/
 */

export * from './utils/index.js';
```

**Verify index.ts** unchanged (should already export from parser.ts and transformer.ts):
```typescript
export * from './parser.js';
export * from './transformer.js';
```

**Run all parser tests:**
```bash
npm run test -- tests/parser/
```

All 5 test files should pass:
- parser.test.ts
- transformer.test.ts
- agent-transformer.test.ts
- spawnagent-transformer.test.ts
- generic-extraction.test.ts
  </action>
  <verify>
    `npm run build && npm run test -- tests/parser/` passes
  </verify>
  <done>
    transformer.ts is slim coordinator, parser.ts re-exports from utils/, all tests pass
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. All transformer modules complete (10 files in transformers/)
2. transformer.ts is ~200 lines (down from 3956)
3. parser.ts re-exports from utils/ (~20 lines, down from 1255)
4. `npm run build` passes
5. `npm run test -- tests/parser/` passes (all 5 test files)
6. Public API unchanged (parser/index.ts exports same symbols)
</verification>

<success_criteria>
- [ ] spawner.ts, variables.ts, state.ts, primitives.ts, markdown.ts created
- [ ] dispatch.ts fully implemented with routing logic
- [ ] transformer.ts is thin coordinator (~200 lines)
- [ ] parser.ts re-exports from utils/ (~20 lines)
- [ ] `npm run build` passes with no TypeScript errors
- [ ] All 5 parser tests pass
- [ ] Public API unchanged (no breaking changes to imports)
</success_criteria>

<output>
After completion, create `.planning/phases/26-parser-refactoring/26-04-SUMMARY.md`
</output>
