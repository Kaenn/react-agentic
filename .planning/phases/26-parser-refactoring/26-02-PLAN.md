---
phase: 26-parser-refactoring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/parser/transformers/types.ts
  - src/parser/transformers/shared.ts
  - src/parser/transformers/dispatch.ts
  - src/parser/transformers/index.ts
autonomous: true

must_haves:
  truths:
    - "TransformContext interface defines all shared state for transformer functions"
    - "Shared utilities (transformBlockChildren, trimBoundaryTextNodes) are extracted"
    - "Dispatch function provides central transform routing to avoid circular imports"
  artifacts:
    - path: "src/parser/transformers/types.ts"
      provides: "TransformContext, RenderPropsContext interfaces"
      min_lines: 30
    - path: "src/parser/transformers/shared.ts"
      provides: "transformBlockChildren, transformMixedChildren, helper functions"
      min_lines: 150
    - path: "src/parser/transformers/dispatch.ts"
      provides: "dispatchBlockTransform for routing transform calls"
      min_lines: 80
    - path: "src/parser/transformers/index.ts"
      provides: "Barrel exports for all transformer modules"
      min_lines: 20
  key_links:
    - from: "src/parser/transformers/shared.ts"
      to: "src/parser/transformers/dispatch.ts"
      via: "imports dispatchBlockTransform for recursive calls"
      pattern: "import.*dispatch"
    - from: "src/parser/transformers/dispatch.ts"
      to: "src/parser/transformers/*.ts"
      via: "imports all transform functions"
      pattern: "import.*transform"
---

<objective>
Create transformers/ directory foundation with shared types, utilities, and dispatch mechanism

Purpose: Establish the infrastructure for extracting Transformer class methods into modules
Output: 4 files providing types, shared utilities, and dispatch for transformer modules
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-parser-refactoring/26-RESEARCH.md
@src/parser/transformer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create transformers/types.ts with shared interfaces</name>
  <files>
    src/parser/transformers/types.ts
  </files>
  <action>
Create src/parser/transformers/ directory and the types module:

**transformers/types.ts** (~50 lines):

```typescript
/**
 * Shared types for transformer modules
 */

import type { SourceFile, Node } from 'ts-morph';
import type { ExtractedVariable } from '../utils/variable-extraction.js';

/**
 * Context values available for render props interpolation
 */
export interface RenderPropsContext {
  /** Parameter name used in arrow function (e.g., 'ctx') */
  paramName: string;
  /** Context values that can be interpolated */
  values: Record<string, string>;
}

/**
 * Transform context passed to all transformer functions
 * Replaces class instance state with explicit context object
 */
export interface TransformContext {
  /** Source file for component resolution (optional - only needed for composition) */
  sourceFile: SourceFile | undefined;
  /** Visited paths for circular import detection */
  visitedPaths: Set<string>;
  /** Extracted useVariable declarations from source file */
  variables: Map<string, ExtractedVariable>;
  /** Extracted useOutput declarations: identifier name -> agent name */
  outputs: Map<string, string>;
  /** Extracted useStateRef declarations: identifier name -> state key */
  stateRefs: Map<string, string>;
  /** Current render props context for interpolation */
  renderPropsContext: RenderPropsContext | undefined;
  /** Create error with source location */
  createError: (message: string, node: Node) => Error;
}
```

This interface captures all the state that was previously stored on the Transformer class instance.
  </action>
  <verify>
    `npx tsc --noEmit src/parser/transformers/types.ts` passes
  </verify>
  <done>
    types.ts created with TransformContext and RenderPropsContext interfaces
  </done>
</task>

<task type="auto">
  <name>Task 2: Create transformers/shared.ts with common utilities</name>
  <files>
    src/parser/transformers/shared.ts
  </files>
  <action>
Extract shared transformation utilities used by multiple transformer modules:

**transformers/shared.ts** (~250 lines):

Extract from transformer.ts:
1. `toSnakeCase` helper function
2. HTML_ELEMENTS constant (Set of supported HTML elements)
3. INLINE_ELEMENTS constant (Set of inline elements)
4. SPECIAL_COMPONENTS constant (Set of special component names)
5. `isInlineElement` function
6. `isCustomComponent` function (exported)
7. `isValidXmlName` function
8. XML_NAME_REGEX constant
9. `trimBoundaryTextNodes` function
10. `transformInlineNodes` helper
11. `transformMixedChildren` - note: this calls dispatchBlockTransform, so use forward reference

Import from utils/:
- getElementName, extractText from utils/index.js
- Node from ts-morph

Import from ir/:
- BlockNode, InlineNode types

Note: transformBlockChildren and other recursive transforms will be in dispatch.ts to avoid circular imports.

Key implementation note: Functions that call other transform functions should accept a `dispatch` callback parameter or import from dispatch.ts. For shared.ts, focus on pure utility functions that don't recurse into other transforms.
  </action>
  <verify>
    `npx tsc --noEmit src/parser/transformers/shared.ts` passes
  </verify>
  <done>
    shared.ts created with utility functions and constants
  </done>
</task>

<task type="auto">
  <name>Task 3: Create dispatch.ts and transformers barrel export</name>
  <files>
    src/parser/transformers/dispatch.ts
    src/parser/transformers/index.ts
  </files>
  <action>
Create the central dispatch module and barrel exports:

**transformers/dispatch.ts** (~150 lines):

This is a STUB file for now - it will be populated in Plan 03/04 as transformer modules are created.

Create initial structure:
```typescript
/**
 * Central transform dispatcher
 *
 * Prevents circular imports by providing a single entry point
 * for recursive transform calls. Individual transformer modules
 * import dispatchBlockTransform instead of each other.
 */

import type { Node } from 'ts-morph';
import type { BlockNode, InlineNode } from '../../ir/index.js';
import type { TransformContext } from './types.js';

/**
 * Dispatch a node transformation to the appropriate handler
 * Called by transformBlockChildren and other recursive transforms
 *
 * NOTE: Implementation will be completed in Plan 03/04 as
 * transformer modules are extracted.
 */
export function dispatchBlockTransform(
  node: Node,
  ctx: TransformContext
): BlockNode | null {
  // TODO: Will be implemented when transformer modules are created
  throw new Error('dispatchBlockTransform not yet implemented - complete in Plan 03/04');
}

/**
 * Transform JSX children to BlockNodes, handling If/Else sibling pairs
 * Extracted from Transformer.transformBlockChildren
 */
export function transformBlockChildren(
  jsxChildren: Node[],
  ctx: TransformContext
): BlockNode[] {
  // TODO: Will be implemented when transformer modules are created
  throw new Error('transformBlockChildren not yet implemented - complete in Plan 03/04');
}
```

**transformers/index.ts** (barrel exports):
```typescript
/**
 * Transformer modules - JSX AST to IR transformation
 */

// Types
export type { TransformContext, RenderPropsContext } from './types.js';

// Shared utilities
export {
  isCustomComponent,
  isInlineElement,
  isValidXmlName,
  toSnakeCase,
  HTML_ELEMENTS,
  INLINE_ELEMENTS,
  SPECIAL_COMPONENTS,
  trimBoundaryTextNodes,
} from './shared.js';

// Dispatch (recursive transform entry point)
export { dispatchBlockTransform, transformBlockChildren } from './dispatch.js';

// NOTE: Individual transformer modules will be added in Plan 03/04:
// - document.ts (transformCommand, transformAgent, transformSkill, etc.)
// - html.ts (transformList, transformBlockquote, transformCodeBlock, etc.)
// - semantic.ts (transformTable, transformExecutionContext, etc.)
// - control.ts (transformIf, transformElse, transformLoop, etc.)
// - spawner.ts (transformSpawnAgent, extractAgentProp, etc.)
// - variables.ts (transformAssign, transformAssignGroup, etc.)
// - state.ts (transformReadState, transformWriteState, etc.)
// - primitives.ts (transformStep, transformBash, etc.)
// - markdown.ts (transformMarkdown, transformXmlBlock, etc.)
// - inline.ts (transformInlineChildren, transformToInline, etc.)
```
  </action>
  <verify>
    `npx tsc --noEmit src/parser/transformers/index.ts` passes
  </verify>
  <done>
    dispatch.ts stub and transformers/index.ts barrel created, ready for Plan 03/04 to populate
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. src/parser/transformers/ directory exists with 4 files
2. types.ts defines TransformContext and RenderPropsContext
3. shared.ts contains utility functions and constants
4. dispatch.ts has stub functions (to be completed in Plan 03/04)
5. index.ts barrel exports all modules
6. `npx tsc --noEmit src/parser/transformers/index.ts` passes
</verification>

<success_criteria>
- [ ] transformers/types.ts with TransformContext interface
- [ ] transformers/shared.ts with utility functions and constants
- [ ] transformers/dispatch.ts with stub functions
- [ ] transformers/index.ts with barrel exports
- [ ] TypeScript compilation passes
- [ ] Foundation ready for transformer method extraction in Plan 03/04
</success_criteria>

<output>
After completion, create `.planning/phases/26-parser-refactoring/26-02-SUMMARY.md`
</output>
