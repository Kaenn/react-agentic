---
phase: 26-parser-refactoring
plan: 03
type: execute
wave: 2
depends_on: ["26-01", "26-02"]
files_modified:
  - src/parser/transformers/document.ts
  - src/parser/transformers/html.ts
  - src/parser/transformers/inline.ts
  - src/parser/transformers/semantic.ts
  - src/parser/transformers/control.ts
  - src/parser/transformers/index.ts
autonomous: true

must_haves:
  truths:
    - "Document transformers (Command, Agent, Skill, MCPConfig, State) are extracted"
    - "HTML transformers (list, blockquote, codeBlock, div) are extracted"
    - "Inline transformers are extracted"
    - "Semantic component transformers are extracted"
    - "Control flow transformers (If, Else, Loop, OnStatus) are extracted"
  artifacts:
    - path: "src/parser/transformers/document.ts"
      provides: "transformCommand, transformAgent, transformSkill, transformMCPConfig, transformState"
      min_lines: 400
    - path: "src/parser/transformers/html.ts"
      provides: "transformList, transformListItem, transformBlockquote, transformCodeBlock, transformDiv"
      min_lines: 300
    - path: "src/parser/transformers/inline.ts"
      provides: "transformInlineChildren, transformToInline, transformInlineElement, transformLink"
      min_lines: 200
    - path: "src/parser/transformers/semantic.ts"
      provides: "transformTable, transformPropList, transformExecutionContext, transformSuccessCriteria, transformOfferNext"
      min_lines: 250
    - path: "src/parser/transformers/control.ts"
      provides: "transformIf, transformElse, transformLoop, transformOnStatus"
      min_lines: 200
  key_links:
    - from: "src/parser/transformers/document.ts"
      to: "src/parser/transformers/dispatch.ts"
      via: "uses transformBlockChildren"
      pattern: "import.*transformBlockChildren"
    - from: "src/parser/transformers/control.ts"
      to: "src/parser/transformers/dispatch.ts"
      via: "uses transformBlockChildren"
      pattern: "import.*transformBlockChildren"
---

<objective>
Extract first batch of transformer methods from Transformer class into focused modules

Purpose: Split the 3956-line Transformer class into maintainable domain-focused modules
Output: 5 transformer modules covering document, HTML, inline, semantic, and control flow transforms
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-parser-refactoring/26-RESEARCH.md
@.planning/phases/26-parser-refactoring/26-01-SUMMARY.md
@.planning/phases/26-parser-refactoring/26-02-SUMMARY.md
@src/parser/transformer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract document transformers (Command, Agent, Skill, MCP, State)</name>
  <files>
    src/parser/transformers/document.ts
  </files>
  <action>
Extract document-level transform methods from transformer.ts:

**transformers/document.ts** (~500 lines):

Functions to extract (convert from methods to standalone functions accepting TransformContext):
1. `transformCommand` - Command element to DocumentNode
2. `transformAgent` - Agent element to AgentDocumentNode
3. `transformSkill` - Skill element to SkillDocumentNode
4. `processSkillChildren` - Helper for Skill transformation
5. `transformSkillFile` - SkillFile element
6. `transformSkillStatic` - SkillStatic element
7. `transformMCPConfig` - MCPConfig element to MCPConfigDocumentNode
8. `transformMCPServer` - MCPServer/MCPStdioServer/MCPHTTPServer element
9. `transformState` - State element to StateDocumentNode
10. `transformOperation` - Operation child of State
11. `mergeCommandProps` - Helper for Command prop merging
12. `getBooleanAttribute` - Helper for boolean prop extraction
13. `hasAttribute` - Helper for attribute existence check
14. `extractArrayAttribute` - Helper for array prop extraction
15. `extractObjectAttribute` - Helper for object prop extraction
16. `transformArrowFunctionBody` - For render props pattern

Key transformation pattern:
```typescript
// BEFORE (class method):
private transformCommand(node: JsxElement): DocumentNode {
  if (!name) throw this.createError('...', node);
  const children = this.transformBlockChildren(...);
}

// AFTER (standalone function):
export function transformCommand(
  node: JsxElement | JsxSelfClosingElement,
  ctx: TransformContext
): DocumentNode {
  if (!name) throw ctx.createError('...', node);
  const children = transformBlockChildren(..., ctx);
}
```

Imports needed:
- ts-morph types: Node, JsxElement, JsxSelfClosingElement, JsxOpeningElement
- IR types from ../../ir/index.js
- Utils from ../utils/index.js
- TransformContext from ./types.js
- transformBlockChildren from ./dispatch.js (forward reference for now)

Note: The dispatch.ts transformBlockChildren is a stub. document.ts can import it, but full functionality depends on Plan 04 completing the dispatch implementation.
  </action>
  <verify>
    `npx tsc --noEmit src/parser/transformers/document.ts` passes
  </verify>
  <done>
    document.ts created with all document-level transform functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract HTML and inline transformers</name>
  <files>
    src/parser/transformers/html.ts
    src/parser/transformers/inline.ts
  </files>
  <action>
Extract HTML element and inline transform methods:

**transformers/html.ts** (~350 lines):

Functions to extract:
1. `transformList` - ul/ol element to ListNode
2. `transformListItem` - li element to ListItemNode
3. `transformBlockquote` - blockquote element to BlockquoteNode
4. `transformCodeBlock` - pre element to CodeBlockNode
5. `extractCodeContent` - Helper for code content extraction
6. `transformDiv` - div element to XmlBlockNode or GroupNode
7. `transformMixedChildren` - Mixed inline+block children handling
8. `extractAllText` - Recursive text extraction

Imports: ts-morph types, IR types, utils, TransformContext, dispatch functions

**transformers/inline.ts** (~250 lines):

Functions to extract:
1. `transformInlineChildren` - Extract inline content from element
2. `transformToInline` - Convert node to InlineNode
3. `transformInlineElement` - Handle inline elements (b, i, code, a, etc.)
4. `transformLink` - a element to LinkNode
5. `trimBoundaryTextNodes` - Trim whitespace from inline boundaries

Imports: ts-morph types, IR types (InlineNode, LinkNode), utils (extractInlineText), TransformContext
  </action>
  <verify>
    `npx tsc --noEmit src/parser/transformers/html.ts src/parser/transformers/inline.ts` passes
  </verify>
  <done>
    html.ts and inline.ts created with HTML element and inline transform functions
  </done>
</task>

<task type="auto">
  <name>Task 3: Extract semantic and control flow transformers</name>
  <files>
    src/parser/transformers/semantic.ts
    src/parser/transformers/control.ts
    src/parser/transformers/index.ts
  </files>
  <action>
Extract semantic component and control flow transform methods:

**transformers/semantic.ts** (~300 lines):

Functions to extract:
1. `transformTable` - Table component to TableNode
2. `parseRowsAttribute` - Helper for Table rows prop
3. `interpolatePropertyAccess` - Helper for context interpolation
4. `transformPropList` - List component (prop-based) to ListNode
5. `transformExecutionContext` - ExecutionContext to ExecutionContextNode
6. `transformSuccessCriteria` - SuccessCriteria to SuccessCriteriaNode
7. `parseSuccessCriteriaItems` - Helper for items parsing
8. `transformOfferNext` - OfferNext to OfferNextNode
9. `parseOfferNextRoutes` - Helper for routes parsing
10. `transformXmlSection` - XmlSection to XmlBlockNode
11. `transformXmlWrapper` - DeviationRules/CommitRules/etc to XmlBlockNode

**transformers/control.ts** (~250 lines):

Functions to extract:
1. `transformIf` - If element to IfNode
2. `transformElse` - Else element to ElseNode
3. `transformLoop` - Loop element to LoopNode
4. `transformOnStatus` - OnStatus element to OnStatusNode
5. `extractOutputDeclarations` - Helper for useOutput tracking
6. `extractStateRefDeclarations` - Helper for useStateRef tracking

**Update transformers/index.ts**:
Add exports for all new modules:
```typescript
// Document transforms
export { transformCommand, transformAgent, transformSkill, transformMCPConfig, transformState } from './document.js';

// HTML transforms
export { transformList, transformBlockquote, transformCodeBlock, transformDiv } from './html.js';

// Inline transforms
export { transformInlineChildren, transformToInline, transformInlineElement } from './inline.js';

// Semantic transforms
export { transformTable, transformPropList, transformExecutionContext, transformSuccessCriteria, transformOfferNext } from './semantic.js';

// Control flow transforms
export { transformIf, transformElse, transformLoop, transformOnStatus } from './control.js';
```
  </action>
  <verify>
    `npx tsc --noEmit src/parser/transformers/index.ts` passes (validates all transformer modules)
  </verify>
  <done>
    semantic.ts and control.ts created, index.ts updated with all new exports
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. 5 new transformer modules exist: document.ts, html.ts, inline.ts, semantic.ts, control.ts
2. Each module exports standalone functions with TransformContext parameter
3. transformers/index.ts re-exports all new functions
4. TypeScript compilation passes
5. No changes to public API yet - transformer.ts still has all methods
</verification>

<success_criteria>
- [ ] document.ts with Command/Agent/Skill/MCP/State transforms
- [ ] html.ts with list/blockquote/codeBlock/div transforms
- [ ] inline.ts with inline element transforms
- [ ] semantic.ts with Table/List/ExecutionContext/SuccessCriteria transforms
- [ ] control.ts with If/Else/Loop/OnStatus transforms
- [ ] All modules export functions accepting TransformContext
- [ ] transformers/index.ts updated with all exports
- [ ] TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/26-parser-refactoring/26-03-SUMMARY.md`
</output>
