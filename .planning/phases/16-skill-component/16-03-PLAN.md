---
phase: 16-skill-component
plan: 03
type: execute
wave: 3
depends_on: ["16-02"]
files_modified:
  - src/emitter/emitter.ts
  - src/cli/commands/build.ts
autonomous: true

must_haves:
  truths:
    - "Skill emits frontmatter with kebab-case keys"
    - "Skill body content renders as markdown"
    - "SkillFile generates additional files in skill directory"
    - "SkillStatic copies static files from source"
    - "Build process creates .claude/skills/{name}/ directory"
  artifacts:
    - path: "src/emitter/emitter.ts"
      provides: "emitSkill, emitSkillFile, emitSkillFrontmatter methods"
      contains: "emitSkill"
    - path: "src/cli/commands/build.ts"
      provides: "processSkill multi-file output handling"
      contains: "SkillDocumentNode"
  key_links:
    - from: "src/cli/commands/build.ts"
      to: "src/emitter/emitter.ts"
      via: "emitSkill function call"
      pattern: "emitSkill\\(doc"
---

<objective>
Implement emitter methods for Skill documents and extend build command for multi-file skill output.

Purpose: Complete the Skill compilation pipeline from TSX to filesystem
Output: Working skill build that produces SKILL.md + supporting files
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-skill-component/16-RESEARCH.md
@.planning/phases/16-skill-component/16-02-SUMMARY.md

# Existing patterns to follow
@src/emitter/emitter.ts
@src/cli/commands/build.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add emitSkill and emitSkillFrontmatter to emitter.ts</name>
  <files>src/emitter/emitter.ts</files>
  <action>
1. Add imports for new node types:
```typescript
import type {
  // ... existing imports ...
  SkillDocumentNode,
  SkillFrontmatterNode,
  SkillFileNode,
} from '../ir/index.js';
```

2. Add emitSkillFrontmatter method (maps camelCase to kebab-case):
```typescript
/**
 * Emit Skill frontmatter (Claude Code format: kebab-case keys)
 */
private emitSkillFrontmatter(node: SkillFrontmatterNode): string {
  const data: Record<string, unknown> = {
    name: node.name,
    description: node.description,
  };

  // Map camelCase props to kebab-case YAML keys
  if (node.disableModelInvocation !== undefined) {
    data['disable-model-invocation'] = node.disableModelInvocation;
  }
  if (node.userInvocable !== undefined) {
    data['user-invocable'] = node.userInvocable;
  }
  if (node.allowedTools && node.allowedTools.length > 0) {
    data['allowed-tools'] = node.allowedTools;
  }
  if (node.argumentHint) {
    data['argument-hint'] = node.argumentHint;
  }
  if (node.model) {
    data['model'] = node.model;
  }
  if (node.context) {
    data['context'] = node.context;
  }
  if (node.agent) {
    data['agent'] = node.agent;
  }

  return matter.stringify('', data).trimEnd();
}
```

3. Add emitSkill method:
```typescript
/**
 * Emit a SkillDocumentNode to markdown (SKILL.md content)
 */
emitSkill(doc: SkillDocumentNode): string {
  const parts: string[] = [];

  // Skill frontmatter
  parts.push(this.emitSkillFrontmatter(doc.frontmatter));

  // Body content
  for (const child of doc.children) {
    parts.push(this.emitBlock(child));
  }

  // Join with double newlines for block separation, then ensure single trailing newline
  const result = parts.join('\n\n');
  return result ? result + '\n' : '';
}
```

4. Add emitSkillFile method:
```typescript
/**
 * Emit a SkillFileNode to markdown (supporting file content)
 */
emitSkillFile(node: SkillFileNode): string {
  const parts: string[] = [];

  for (const child of node.children) {
    parts.push(this.emitBlock(child));
  }

  // Join with double newlines, ensure trailing newline
  const result = parts.join('\n\n');
  return result ? result + '\n' : '';
}
```

5. Add convenience functions at bottom of file:
```typescript
/**
 * Convenience function for emitting a skill document
 */
export function emitSkill(doc: SkillDocumentNode): string {
  const emitter = new MarkdownEmitter();
  return emitter.emitSkill(doc);
}

/**
 * Convenience function for emitting a skill file
 */
export function emitSkillFile(node: SkillFileNode): string {
  const emitter = new MarkdownEmitter();
  return emitter.emitSkillFile(node);
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors in emitter.ts</verify>
  <done>emitSkill and emitSkillFile methods generate markdown with proper frontmatter</done>
</task>

<task type="auto">
  <name>Task 2: Extend build.ts for multi-file skill output</name>
  <files>src/cli/commands/build.ts</files>
  <action>
1. Add imports:
```typescript
import { copyFile } from 'fs/promises';
import {
  // ... existing imports ...
  emitSkill,
  emitSkillFile,
} from '../../index.js';
import type { SkillDocumentNode } from '../../index.js';
```

2. Update runBuild to handle SkillDocumentNode (add after agentDocument case):
```typescript
if (doc.kind === 'skillDocument') {
  // Skill: multi-file output to .claude/skills/{name}/
  const skillResult = await processSkill(doc, inputFile, sourceFile);

  // Collect all outputs
  for (const output of skillResult.outputs) {
    results.push({
      inputFile,
      outputPath: output.outputPath,
      content: output.content,
      size: output.size,
    });
  }

  // Copy static files (after mkdir in Phase 2)
  skillResult.staticsToCopy = skillResult.statics;
  // Store for later processing
  continue;
}
```

Actually, cleaner approach - refactor to handle skill results separately:

3. Add processSkill function:
```typescript
interface SkillBuildResult {
  inputFile: string;
  skillName: string;
  outputs: Array<{
    outputPath: string;
    content: string;
    size: number;
  }>;
  statics: Array<{
    src: string;
    dest: string;
  }>;
}

/**
 * Process a skill document into build outputs
 */
function processSkill(
  doc: SkillDocumentNode,
  inputFile: string,
  sourceFile: SourceFile
): SkillBuildResult {
  const skillName = doc.frontmatter.name;
  const skillDir = `.claude/skills/${skillName}`;
  const inputDir = path.dirname(inputFile);

  // 1. Generate SKILL.md
  const skillMd = emitSkill(doc);
  const outputs = [{
    outputPath: `${skillDir}/SKILL.md`,
    content: skillMd,
    size: Buffer.byteLength(skillMd, 'utf8'),
  }];

  // 2. Generate SkillFiles
  for (const file of doc.files) {
    const content = emitSkillFile(file);
    outputs.push({
      outputPath: `${skillDir}/${file.name}`,
      content,
      size: Buffer.byteLength(content, 'utf8'),
    });
  }

  // 3. Resolve SkillStatic paths
  const statics = doc.statics.map(s => ({
    src: path.resolve(inputDir, s.src),
    dest: `${skillDir}/${s.dest || s.src}`,
  }));

  return { inputFile, skillName, outputs, statics };
}
```

4. Update runBuild to handle skills with static file copying:
In the processing loop, detect skillDocument and call processSkill.
In the write phase (Phase 2), handle:
- Writing generated files (outputs array)
- Copying static files (statics array)

```typescript
// In the file writing loop, after mkdir:
if (result.statics) {
  for (const staticFile of result.statics) {
    const destDir = path.dirname(staticFile.dest);
    await mkdir(destDir, { recursive: true });
    await copyFile(staticFile.src, staticFile.dest);
  }
}
```

Note: Need to track skill results separately since they have statics. Add a Map or extend BuildResult interface.

Simplest approach: Extend BuildResult with optional statics array:
```typescript
interface BuildResult {
  inputFile: string;
  outputPath: string;
  content: string;
  size: number;
  statics?: Array<{ src: string; dest: string }>;  // For skills only
}
```

Then in the processing loop for skillDocument:
- Create results for each output (SKILL.md + SkillFiles)
- Attach statics to the first result (SKILL.md)

In write phase:
- Write content as normal
- If result.statics exists, copy each static file
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors
Create a test skill file and run build to verify output structure
  </verify>
  <done>Build command processes skills, creates directory, generates files, copies statics</done>
</task>

</tasks>

<verification>
```bash
# Type check passes
npx tsc --noEmit

# Emitter exports new functions
grep -n "export function emitSkill\|export function emitSkillFile" src/emitter/emitter.ts

# Build handles skill documents
grep -n "skillDocument\|processSkill" src/cli/commands/build.ts

# Test build (manual - create test file first)
# node dist/cli/index.js build src/app/test-skill.tsx
```
</verification>

<success_criteria>
- [ ] emitSkillFrontmatter maps camelCase to kebab-case YAML keys
- [ ] emitSkill generates complete SKILL.md content
- [ ] emitSkillFile generates supporting file content
- [ ] processSkill creates multi-file build result
- [ ] Build creates .claude/skills/{name}/ directory
- [ ] Build writes SKILL.md and SkillFile outputs
- [ ] Build copies SkillStatic files to destination
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-skill-component/16-03-SUMMARY.md`
</output>
