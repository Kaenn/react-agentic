---
phase: 27-baseline-registry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/components/__snapshots__/
  - tests/components/control-flow.test.ts
  - tests/components/structured.test.ts
  - tests/components/semantic.test.ts
  - tests/components/runtime.test.ts
  - tests/components/document.test.ts
autonomous: true

must_haves:
  truths:
    - "Running `npm test` with component output changes causes snapshot failures"
    - "Each primitive component has at least one snapshot capturing its markdown output"
    - "Key nesting combinations (If+SpawnAgent, Loop+Break) have dedicated snapshots"
  artifacts:
    - path: "tests/components/control-flow.test.ts"
      provides: "If, Else, Loop, Break, Return snapshots"
      contains: "toMatchSnapshot"
    - path: "tests/components/structured.test.ts"
      provides: "Table, List, Indent snapshots"
      contains: "toMatchSnapshot"
    - path: "tests/components/semantic.test.ts"
      provides: "ExecutionContext, XmlBlock, Step snapshots"
      contains: "toMatchSnapshot"
    - path: "tests/components/runtime.test.ts"
      provides: "SpawnAgent, AskUser, RuntimeCall, OnStatus snapshots"
      contains: "toMatchSnapshot"
    - path: "tests/components/document.test.ts"
      provides: "Command, Agent document structure snapshots"
      contains: "toMatchSnapshot"
  key_links:
    - from: "tests/components/*.test.ts"
      to: "src/emitter/emitter.ts"
      via: "import emit function"
      pattern: "import.*emit"
    - from: "tests/components/*.test.ts"
      to: "src/ir/*.ts"
      via: "import node types"
      pattern: "import.*Node"
---

<objective>
Create snapshot tests for all current component markdown output to establish a safety baseline before refactoring.

Purpose: Ensure refactoring in later phases cannot accidentally change component output without explicit snapshot updates.
Output: Test files in tests/components/ with external snapshots in __snapshots__/ subdirectory.
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-baseline-registry/27-RESEARCH.md

# Existing test patterns to follow
@tests/emitter/document.test.ts
@src/ir/nodes.ts
@src/ir/runtime-nodes.ts
@src/emitter/emitter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create control flow component snapshots</name>
  <files>tests/components/control-flow.test.ts</files>
  <action>
Create test file for control flow components (If, Else, Loop, Break, Return).

Use the existing test patterns from tests/emitter/document.test.ts:
1. Import vitest, emit function, and node types from src/ir/runtime-nodes.ts
2. For each component, construct IR node directly (not from TSX parsing)
3. Use MarkdownEmitter to emit the node and snapshot the result

Test cases to include:
- If: basic condition with truthy ref, literal condition, nested content
- If+Else: paired conditional with both branches
- Loop: basic loop with max, with counterVar, nested If inside Loop
- Break: standalone break, break with message
- Return: basic return, return with status and message
- Nesting: If containing SpawnAgent (key integration point)

Use `toMatchSnapshot()` for external snapshots (not inline).
Import from runtime-nodes.ts for IfNode, ElseNode, LoopNode, BreakNode, ReturnNode.
  </action>
  <verify>npm test tests/components/control-flow.test.ts -- --run</verify>
  <done>All control flow snapshot tests pass, __snapshots__/control-flow.test.ts.snap created</done>
</task>

<task type="auto">
  <name>Task 2: Create structured and semantic component snapshots</name>
  <files>
tests/components/structured.test.ts
tests/components/semantic.test.ts
  </files>
  <action>
Create test files for structured props and semantic components.

**structured.test.ts** (Table, List, Indent from src/ir/nodes.ts):
- Table: basic headers/rows, with alignment, empty cells
- List: unordered items, ordered items, with start number
- Indent: default indentation (2 spaces), custom indentation (4 spaces, tab)

**semantic.test.ts** (ExecutionContext, XmlBlock, Step from src/ir/nodes.ts):
- ExecutionContext: basic paths, with custom prefix, with children
- XmlBlock: basic name/children, with attributes
- Step: heading variant, bold variant, xml variant

Follow same pattern: construct IR nodes directly, emit with MarkdownEmitter, snapshot result.
  </action>
  <verify>npm test tests/components/structured.test.ts tests/components/semantic.test.ts -- --run</verify>
  <done>Structured and semantic component snapshots exist and pass</done>
</task>

<task type="auto">
  <name>Task 3: Create runtime and document component snapshots</name>
  <files>
tests/components/runtime.test.ts
tests/components/document.test.ts
  </files>
  <action>
Create test files for runtime components and document structure.

**runtime.test.ts** (SpawnAgent, AskUser, RuntimeCall, OnStatus from src/ir/runtime-nodes.ts):
- SpawnAgent: basic agent spawn, with input object, with output variable
- AskUser: basic question/options, with multiSelect
- RuntimeCall: basic function call with args
- OnStatus: with SUCCESS status, with ERROR status, with BLOCKED status
- Key nesting: Loop containing Break (control flow integration)

**document.test.ts** (DocumentNode, AgentDocumentNode):
- DocumentNode: with frontmatter, with children, with runtimeVars
- AgentDocumentNode: with agent frontmatter, with structured returns

For runtime components, test the **emitted template** (what Claude sees), not execution.
SpawnAgent should emit `Task()` syntax. If conditions should emit human-readable checks.
  </action>
  <verify>npm test tests/components/runtime.test.ts tests/components/document.test.ts -- --run</verify>
  <done>Runtime and document snapshots exist, all tests pass</done>
</task>

</tasks>

<verification>
```bash
# All new tests pass
npm test tests/components/ -- --run

# Snapshots were created
ls tests/components/__snapshots__/

# Snapshot files have content
wc -l tests/components/__snapshots__/*.snap
```
</verification>

<success_criteria>
1. `npm test tests/components/` passes with no failures
2. `__snapshots__/` directory contains .snap files for each test file
3. At least 20 total snapshots across all component types
4. Modifying emitter output (e.g., changing Table separator) would cause test failures
</success_criteria>

<output>
After completion, create `.planning/phases/27-baseline-registry/27-01-SUMMARY.md`
</output>
