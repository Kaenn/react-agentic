---
phase: 27-baseline-registry
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ir/registry.ts
  - src/ir/index.ts
  - tests/ir/registry.test.ts
autonomous: true

must_haves:
  truths:
    - "`isPrimitive(node)` returns true for all compiler-owned components"
    - "`getComponentInfo(kind)` returns category and migration target info"
    - "Registry exports are accessible from 'src/index.js'"
  artifacts:
    - path: "src/ir/registry.ts"
      provides: "Primitive registry with classification functions"
      exports: ["isPrimitive", "getPrimitives", "getComposites", "getComponentInfo", "PRIMITIVE_COMPONENTS"]
    - path: "tests/ir/registry.test.ts"
      provides: "Registry function tests"
      contains: "isPrimitive"
  key_links:
    - from: "src/ir/index.ts"
      to: "src/ir/registry.ts"
      via: "re-export"
      pattern: "export.*from.*registry"
    - from: "src/index.ts"
      to: "src/ir/index.ts"
      via: "re-export"
      pattern: "export.*from.*ir"
---

<objective>
Create a primitive component registry that explicitly lists all compiler-owned components with classification functions.

Purpose: Replace ad-hoc string checks (e.g., `name === 'If'`) with formal registry lookups. Enable future introspection and metaprogramming.
Output: `src/ir/registry.ts` with typed functions and a test file verifying correctness.
</objective>

<execution_context>
@/Users/glenninizan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/glenninizan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-baseline-registry/27-RESEARCH.md
@.planning/phases/27-baseline-registry/27-CONTEXT.md

# Current component checks (to be replaced in later phases)
@src/parser/transformers/dispatch.ts
@src/ir/nodes.ts
@src/ir/runtime-nodes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create primitive registry module</name>
  <files>src/ir/registry.ts</files>
  <action>
Create registry module at `src/ir/registry.ts` with the following exports:

```typescript
/**
 * Primitive Component Registry
 *
 * Formalizes which components are compiler-owned primitives vs user-definable composites.
 * Infrastructure primitives handle plumbing (agents, control flow).
 * Presentation primitives are destined for composite layer in Phase 32.
 */

// All primitive component kinds (node.kind values)
export const PRIMITIVE_COMPONENTS = new Set([
  // Infrastructure primitives (will remain primitives)
  'spawnAgent',
  'if',
  'else',
  'loop',
  'break',
  'return',
  'askUser',
  'runtimeVarDecl',
  'runtimeCall',

  // Presentation primitives (destined for composite in Phase 32)
  'table',
  'list',
  'executionContext',
  'successCriteria',
  'offerNext',
  'xmlBlock',
  'step',

  // Core document structure
  'document',
  'agentDocument',
  'frontmatter',
  'agentFrontmatter',
] as const);

export type PrimitiveKind = typeof PRIMITIVE_COMPONENTS extends Set<infer T> ? T : never;
```

Add these functions:

1. `isPrimitive(node: { kind: string }): boolean` - Returns true if node is primitive
2. `getPrimitives(): ReadonlySet<string>` - Returns the primitive set
3. `getComposites(): string[]` - Returns empty array (for now, populated in Phase 32)
4. `getComponentInfo(kind: string): ComponentInfo` - Returns classification metadata

ComponentInfo interface:
```typescript
export interface ComponentInfo {
  kind: string;
  category: 'primitive' | 'composite';
  layer: 'infrastructure' | 'presentation' | 'document';
  migrationTarget?: 'composite';  // For presentation primitives
}
```

Mark presentation primitives with `migrationTarget: 'composite'` for tracking.
  </action>
  <verify>npx tsc --noEmit src/ir/registry.ts</verify>
  <done>Registry module compiles without TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Export registry from IR and root index</name>
  <files>
src/ir/index.ts
  </files>
  <action>
Update `src/ir/index.ts` to re-export registry functions:

```typescript
// Add to existing exports
export {
  isPrimitive,
  getPrimitives,
  getComposites,
  getComponentInfo,
  PRIMITIVE_COMPONENTS,
  type PrimitiveKind,
  type ComponentInfo,
} from './registry.js';
```

This makes registry accessible from the main package export.

Verify the root `src/index.ts` already re-exports from `./ir/index.js` (it should based on existing structure).
  </action>
  <verify>npm run build && node -e "import('./dist/index.js').then(m => console.log('isPrimitive:', typeof m.isPrimitive))"</verify>
  <done>Registry functions accessible from package root export</done>
</task>

<task type="auto">
  <name>Task 3: Add registry tests</name>
  <files>tests/ir/registry.test.ts</files>
  <action>
Create test file for registry functions.

Test cases:

1. **isPrimitive**:
   - Returns true for infrastructure primitives (spawnAgent, if, loop, etc.)
   - Returns true for presentation primitives (table, list, etc.)
   - Returns false for unknown kinds
   - Works with node objects: `isPrimitive({ kind: 'if' })`

2. **getComponentInfo**:
   - Returns correct category for primitives
   - Returns correct layer (infrastructure/presentation/document)
   - Returns migrationTarget for presentation primitives
   - Returns 'composite' category for unknown kinds

3. **getPrimitives**:
   - Returns a Set containing all expected primitive kinds
   - Set is readonly (modifications don't affect original)

4. **Coverage check**:
   - Every kind in runtime-nodes.ts RuntimeBlockNode union is in registry
   - Every presentation component from nodes.ts is in registry
  </action>
  <verify>npm test tests/ir/registry.test.ts -- --run</verify>
  <done>Registry tests pass with full coverage of classification logic</done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
npm run build

# Registry exports work
node -e "import('./dist/index.js').then(m => {
  console.log('isPrimitive(if):', m.isPrimitive({ kind: 'if' }));
  console.log('getPrimitives size:', m.getPrimitives().size);
  console.log('getComponentInfo(table):', m.getComponentInfo('table'));
})"

# Tests pass
npm test tests/ir/registry.test.ts -- --run
```
</verification>

<success_criteria>
1. `isPrimitive({ kind: 'if' })` returns `true`
2. `isPrimitive({ kind: 'unknown' })` returns `false`
3. `getComponentInfo('table').migrationTarget` equals `'composite'`
4. `getPrimitives().size` is at least 15 (covering all current primitives)
5. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-baseline-registry/27-02-SUMMARY.md`
</output>
